<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Cricket 2025 - Auction App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .pulse-bid {
            animation: pulseBid 1s infinite;
        }

        @keyframes pulseBid {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen text-white">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md border border-white/20">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-yellow-400 mb-2">üèè Persistent Cricket 2025</h1>
                <p class="text-gray-300">Auction Management System</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="username"
                        class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        placeholder="Enter username" value="admin">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="password"
                        class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        placeholder="Enter password" value="admin123">
                </div>

                <button onclick="login()"
                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 rounded-lg transition-colors">
                    Login as Admin
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-black/30 backdrop-blur-lg border-b border-white/20 p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-yellow-400">üèè PC 2025 Auction</h1>
                    <span id="userRole"
                        class="px-3 py-1 bg-yellow-500 text-black rounded-full text-sm font-medium"></span>
                    <div id="viewerInfo" class="hidden text-xs text-green-400 bg-green-500/20 px-3 py-1 rounded-full">
                        üî¥ Live Updates Every 2s
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="viewerUrl" class="hidden text-xs text-gray-300">
                        <span class="text-yellow-400">Viewer URL:</span>
                        <code class="bg-black/30 px-2 py-1 rounded text-blue-300" onclick="copyViewerUrl()"
                            style="cursor: pointer;" title="Click to copy">
                            Viewer Page
                        </code>
                    </div>
                    <button onclick="logout()"
                        class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-black/20 backdrop-blur-lg border-b border-white/10">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-8">
                    <button onclick="showTab('auction')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="auction">Live Auction</button>
                    <button onclick="showTab('players')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="players">Player Management</button>
                    <button onclick="showTab('teams')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="teams">Team Dashboard</button>
                    <button onclick="showTab('settings')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="settings">Settings</button>
                </div>
            </div>
        </nav>

        <!-- Live Auction Tab -->
        <div id="auctionTab" class="tab-content p-6">
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Current Player & Bidding -->
                    <div>
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 mb-6">
                            <h2 class="text-2xl font-bold mb-4 text-yellow-400">Current Auction</h2>
                            <div id="currentPlayerCard" class="text-center">
                                <div class="text-gray-400">No player selected for auction</div>
                            </div>
                        </div>

                        <!-- Bidding Panel -->
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                            <h3 class="text-xl font-bold mb-4 text-yellow-400">Place Bid</h3>
                            <div id="biddingPanel" class="space-y-4">
                                <div class="text-gray-400 text-center">Select a player to start bidding</div>
                            </div>
                        </div>
                    </div>

                    <!-- Teams Overview -->
                    <div>
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                            <h3 class="text-xl font-bold mb-4 text-yellow-400">Teams Budget</h3>
                            <div id="teamsOverview" class="space-y-3">
                                <!-- Teams budget will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Player Queue -->
                <div class="mt-6 bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-yellow-400">Players Available for Auction</h3>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <input type="text" id="playerSearch" placeholder="Search players..."
                                    class="px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400 w-64"
                                    oninput="filterPlayers()">
                                <div class="absolute right-3 top-2.5 text-gray-400">üîç</div>
                            </div>
                            <select id="roleFilter" onchange="filterPlayers()"
                                class="px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                                <option value="" class="bg-gray-800 text-white">All Roles</option>
                                <option value="Batsman" class="bg-gray-800 text-white">Batsman</option>
                                <option value="Bowler" class="bg-gray-800 text-white">Bowler</option>
                                <option value="All-Rounder" class="bg-gray-800 text-white">All-Rounder</option>
                                <option value="Wicket-keeper" class="bg-gray-800 text-white">Wicket-keeper</option>
                            </select>
                            <button onclick="clearFilters()"
                                class="px-3 py-2 bg-gray-500 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                                Clear
                            </button>
                        </div>
                    </div>
                    <div id="playerSearchResults" class="text-sm text-gray-400 mb-2 hidden"></div>
                    <div id="playerQueue" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Players will be populated here -->
                    </div>
                </div>

                <!-- All Teams Players -->
                <div class="mt-6 bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <h3 class="text-xl font-bold mb-4 text-yellow-400">All Teams Squad</h3>
                    <div id="allTeamsPlayers" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- All teams with their players will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Management Tab -->
        <div id="playersTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-yellow-400">Player Management</h2>
                    <button onclick="showAddPlayerModal()"
                        class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                        Add Player
                    </button>
                </div>

                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div id="playersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Players will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Dashboard Tab -->
        <div id="teamsTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6">Team Dashboard</h2>
                <div id="teamsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Teams will be populated here -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6">Auction Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4">Team Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Number of Teams</label>
                                <input type="number" id="numTeams" value="6" min="2" max="10"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Max Players per Team</label>
                                <input type="number" id="maxPlayers" value="15" min="10" max="25"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                            </div>
                            <button onclick="updateSettings()"
                                class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                Update Settings
                            </button>
                        </div>
                    </div>

                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4">Data Management</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Load Players JSON</label>
                                <input type="file" accept=".json" onchange="loadPlayersJSON(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-500 file:text-white hover:file:bg-green-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Load Teams JSON</label>
                                <input type="file" accept=".json" onchange="loadTeamsJSON(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Load Users JSON</label>
                                <input type="file" accept=".json" onchange="loadUsersJSON(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-500 file:text-white hover:file:bg-purple-600">
                            </div>
                            <button onclick="downloadSampleJSONs()"
                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg transition-colors">
                                Download Sample JSON Files
                            </button>
                        </div>
                    </div>

                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4">Auction Controls</h3>
                        <div class="space-y-4">
                            <button onclick="resetAuction()"
                                class="w-full bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                                Reset Auction
                            </button>
                            <button onclick="exportToJSON()"
                                class="w-full bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                Export Complete Data
                            </button>
                            <button onclick="manualSaveJSONFiles()"
                                class="w-full bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                Download Updated JSON Files
                            </button>
                            <div>
                                <label class="block text-sm font-medium mb-2">Import Complete Data</label>
                                <input type="file" accept=".json" onchange="importFromJSON(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Load Session Data</label>
                                <input type="file" accept=".json" onchange="loadSessionData(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-500 file:text-white hover:file:bg-orange-600">
                                <p class="text-xs text-gray-400 mt-1">Load auction_session.json to restore exact auction
                                    state</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Player Modal -->
    <div id="addPlayerModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-md border border-white/20">
            <h3 class="text-xl font-bold mb-4 text-yellow-400">Add New Player</h3>

            <div class="space-y-4 max-h-96 overflow-y-auto">
                <input type="text" id="playerName" placeholder="Player Name"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <select id="playerRole"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="Batsman" class="bg-gray-800 text-white">Batsman</option>
                    <option value="Bowler" class="bg-gray-800 text-white">Bowler</option>
                    <option value="All-Rounder" class="bg-gray-800 text-white">All-Rounder</option>
                    <option value="Wicket-keeper" class="bg-gray-800 text-white">Wicket-keeper</option>
                </select>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="playerAge" placeholder="Age"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                    <input type="text" id="playerExperience" placeholder="Experience (e.g., 10 years)"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                </div>
                <select id="playerBattingStyle"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="" class="bg-gray-800 text-white">Select Batting Style</option>
                    <option value="Right-handed" class="bg-gray-800 text-white">Right-handed</option>
                    <option value="Left-handed" class="bg-gray-800 text-white">Left-handed</option>
                </select>
                <select id="playerBowlingStyle"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="" class="bg-gray-800 text-white">Select Bowling Style</option>
                    <option value="Right-arm fast" class="bg-gray-800 text-white">Right-arm fast</option>
                    <option value="Right-arm fast-medium" class="bg-gray-800 text-white">Right-arm fast-medium</option>
                    <option value="Right-arm medium" class="bg-gray-800 text-white">Right-arm medium</option>
                    <option value="Right-arm off-break" class="bg-gray-800 text-white">Right-arm off-break</option>
                    <option value="Right-arm leg-break" class="bg-gray-800 text-white">Right-arm leg-break</option>
                    <option value="Left-arm fast" class="bg-gray-800 text-white">Left-arm fast</option>
                    <option value="Left-arm fast-medium" class="bg-gray-800 text-white">Left-arm fast-medium</option>
                    <option value="Left-arm medium" class="bg-gray-800 text-white">Left-arm medium</option>
                    <option value="Left-arm orthodox" class="bg-gray-800 text-white">Left-arm orthodox</option>
                    <option value="Left-arm chinaman" class="bg-gray-800 text-white">Left-arm chinaman</option>
                </select>
                <div>
                    <label class="block text-sm font-medium mb-2">PCL Seasons Played</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2019" value="2019" class="mr-2"> 1
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2020" value="2020" class="mr-2"> 2
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2021" value="2021" class="mr-2"> 3
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2022" value="2022" class="mr-2"> 4
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2023" value="2023" class="mr-2"> 5
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2024" value="2024" class="mr-2"> 6
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2024" value="2024" class="mr-2"> 7
                        </label>
                    </div>
                </div>
                <input type="number" id="basePrice" placeholder="Base Price" value="5000"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <div>
                    <label class="block text-sm font-medium mb-2">Player Photo</label>
                    <input type="file" id="playerPhotoFile" accept="image/*"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-black hover:file:bg-yellow-600">
                    <p class="text-xs text-gray-400 mt-1">Or use emoji/text as photo</p>
                    <input type="text" id="playerPhoto" placeholder="Photo emoji or text (e.g., üèè)"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400 mt-2">
                </div>
                <div class="flex space-x-4">
                    <button onclick="addPlayer()"
                        class="flex-1 bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">Add</button>
                    <button onclick="closeAddPlayerModal()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Player Modal -->
    <div id="editPlayerModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-md border border-white/20">
            <h3 class="text-xl font-bold mb-4 text-yellow-400">Edit Player Details</h3>
            <div class="space-y-4 max-h-96 overflow-y-auto">
                <input type="text" id="editPlayerName" placeholder="Player Name"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <select id="editPlayerRole"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="Batsman" class="bg-gray-800 text-white">Batsman</option>
                    <option value="Bowler" class="bg-gray-800 text-white">Bowler</option>
                    <option value="All-Rounder" class="bg-gray-800 text-white">All-Rounder</option>
                    <option value="Wicket-keeper" class="bg-gray-800 text-white">Wicket-keeper</option>
                </select>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="editPlayerAge" placeholder="Age"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                    <input type="text" id="editPlayerExperience" placeholder="Experience (e.g., 10 years)"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                </div>
                <select id="editPlayerBattingStyle"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="" class="bg-gray-800 text-white">Select Batting Style</option>
                    <option value="Right-handed" class="bg-gray-800 text-white">Right-handed</option>
                    <option value="Left-handed" class="bg-gray-800 text-white">Left-handed</option>
                </select>
                <select id="editPlayerBowlingStyle"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="" class="bg-gray-800 text-white">Select Bowling Style</option>
                    <option value="Right-arm fast" class="bg-gray-800 text-white">Right-arm fast</option>
                    <option value="Right-arm fast-medium" class="bg-gray-800 text-white">Right-arm fast-medium</option>
                    <option value="Right-arm medium" class="bg-gray-800 text-white">Right-arm medium</option>
                    <option value="Right-arm off-break" class="bg-gray-800 text-white">Right-arm off-break</option>
                    <option value="Right-arm leg-break" class="bg-gray-800 text-white">Right-arm leg-break</option>
                    <option value="Left-arm fast" class="bg-gray-800 text-white">Left-arm fast</option>
                    <option value="Left-arm fast-medium" class="bg-gray-800 text-white">Left-arm fast-medium</option>
                    <option value="Left-arm medium" class="bg-gray-800 text-white">Left-arm medium</option>
                    <option value="Left-arm orthodox" class="bg-gray-800 text-white">Left-arm orthodox</option>
                    <option value="Left-arm chinaman" class="bg-gray-800 text-white">Left-arm chinaman</option>
                </select>
                <div>
                    <label class="block text-sm font-medium mb-2">PCL Seasons Played</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="editSeason2019" value="2019" class="mr-2"> 1
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="editSeason2020" value="2020" class="mr-2"> 2
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="editSeason2021" value="2021" class="mr-2"> 3
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="editSeason2022" value="2022" class="mr-2"> 4
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="editSeason2023" value="2023" class="mr-2"> 5
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="editSeason2024" value="2024" class="mr-2"> 6
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="editSeason2024" value="2024" class="mr-2"> 7
                        </label>
                    </div>
                </div>
                <input type="number" id="editBasePrice" placeholder="Base Price"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <div>
                    <label class="block text-sm font-medium mb-2">Player Photo</label>
                    <input type="file" id="editPlayerPhotoFile" accept="image/*"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-black hover:file:bg-yellow-600">
                    <p class="text-xs text-gray-400 mt-1">Or use emoji/text as photo</p>
                    <input type="text" id="editPlayerPhoto" placeholder="Photo emoji or text (e.g., üèè)"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400 mt-2">
                </div>
                <div class="flex space-x-4">
                    <button onclick="savePlayerEdit()"
                        class="flex-1 bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">Save
                        Changes</button>
                    <button onclick="closeEditPlayerModal()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-yellow-400 mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-yellow-400 mb-2">Processing...</h3>
            <p id="loadingMessage" class="text-gray-300">Please wait while we update the data</p>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentRole = null;
        let currentPlayerIndex = 0;
        let auctionActive = false;
        let currentBid = 0;
        let currentBidder = null;
        let isProcessing = false;

        // Loading functions
        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            isProcessing = true;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            isProcessing = false;
        }

        // Debounce function to prevent rapid clicks
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Data persistence functions
        function saveToLocalStorage() {
            try {
                const data = {
                    teams: teams,
                    players: players,
                    currentPlayerIndex: currentPlayerIndex,
                    auctionActive: auctionActive,
                    currentBid: currentBid,
                    currentBidder: currentBidder,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('auctionData', JSON.stringify(data));
                console.log('Data saved successfully at:', new Date().toLocaleTimeString());
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }

        // Update JSON files in project path (async for better performance)
        async function updateProjectJSONFiles() {
            return new Promise((resolve) => {
                // Use setTimeout to make it async and prevent UI blocking
                setTimeout(() => {
                    try {
                        // Prepare players.json (only available and unsold players)
                        const availablePlayers = players.filter(p => p.status === 'available' || p.status === 'unsold');
                        const playersData = availablePlayers.map(player => ({
                            id: player.id,
                            name: player.name,
                            role: player.role,
                            age: player.age,
                            nationality: player.nationality,
                            experience: player.experience,
                            battingStyle: player.battingStyle,
                            bowlingStyle: player.bowlingStyle,
                            pclSeasons: player.pclSeasons,
                            basePrice: player.basePrice,
                            photo: player.photo
                        }));

                        // Prepare teams.json (with sold players included)
                        const teamsData = teams.map(team => ({
                            id: team.id,
                            name: team.name,
                            budget: team.budget,
                            color: team.color,
                            owner: team.owner,
                            players: team.players.map(player => ({
                                id: player.id,
                                name: player.name,
                                role: player.role,
                                age: player.age,
                                nationality: player.nationality,
                                experience: player.experience,
                                battingStyle: player.battingStyle,
                                bowlingStyle: player.bowlingStyle,
                                pclSeasons: player.pclSeasons,
                                basePrice: player.basePrice,
                                soldPrice: player.soldPrice,
                                photo: player.photo
                            }))
                        }));

                        // Store in localStorage for persistence
                        localStorage.setItem('updatedPlayers', JSON.stringify(playersData));
                        localStorage.setItem('updatedTeams', JSON.stringify(teamsData));

                        // Log updated data to console for manual file updates (only in development)
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.log('=== UPDATED PLAYERS.JSON ===');
                            console.log(JSON.stringify(playersData, null, 2));
                            console.log('\n=== UPDATED TEAMS.JSON ===');
                            console.log(JSON.stringify(teamsData, null, 2));
                        }

                        resolve({ playersData, teamsData });
                    } catch (error) {
                        console.error('Error updating JSON files:', error);
                        resolve(null);
                    }
                }, 100); // Small delay to prevent UI blocking
            });
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('auctionData');
                if (savedData) {
                    const data = JSON.parse(savedData);

                    // Validate and load data with proper error handling
                    if (data.teams && Array.isArray(data.teams)) {
                        teams = data.teams.map(team => ({
                            ...team,
                            players: Array.isArray(team.players) ? team.players : []
                        }));
                        console.log('Teams loaded:', teams.length);
                    }

                    if (data.players && Array.isArray(data.players)) {
                        players = data.players;
                        console.log('Players loaded:', players.length);
                    }

                    // Load auction state
                    currentPlayerIndex = data.currentPlayerIndex || 0;
                    auctionActive = data.auctionActive || false;
                    currentBid = data.currentBid || 0;
                    currentBidder = data.currentBidder || null;

                    console.log('Data loaded from localStorage at:', new Date().toLocaleTimeString());
                    console.log('Auction state - Index:', currentPlayerIndex, 'Active:', auctionActive);

                    return true;
                }
                console.log('No saved data found in localStorage');
                return false;
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                return false;
            }
        }

        function exportToJSON() {
            const data = {
                teams: teams,
                players: players,
                auctionState: {
                    currentPlayerIndex: currentPlayerIndex,
                    auctionActive: auctionActive,
                    currentBid: currentBid,
                    currentBidder: currentBidder
                },
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auction-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // JSON file loading functions
        function loadPlayersJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            players = data.map(player => ({
                                ...player,
                                currentBid: 0,
                                status: 'available',
                                soldTo: null
                            }));
                        } else if (data.players && Array.isArray(data.players)) {
                            players = data.players.map(player => ({
                                ...player,
                                currentBid: 0,
                                status: 'available',
                                soldTo: null
                            }));
                        }
                        saveToLocalStorage();
                        renderAll();
                        alert(`${players.length} players loaded successfully!`);
                    } catch (error) {
                        alert('Error loading players JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadTeamsJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            teams = data.map(team => ({
                                ...team,
                                players: team.players || []
                            }));
                        } else if (data.teams && Array.isArray(data.teams)) {
                            teams = data.teams.map(team => ({
                                ...team,
                                players: team.players || []
                            }));
                        }
                        saveToLocalStorage();
                        renderAll();
                        alert(`${teams.length} teams loaded successfully!`);
                    } catch (error) {
                        alert('Error loading teams JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadUsersJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            users = data;
                        } else if (data.users && Array.isArray(data.users)) {
                            users = data.users;
                        }
                        alert(`${users.length} users loaded successfully!`);
                    } catch (error) {
                        alert('Error loading users JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function downloadSampleJSONs() {
            // Sample Players JSON
            const samplePlayers = [
                {
                    "id": 1,
                    "name": "Virat Kohli",
                    "role": "Batsman",
                    "age": 35,
                    "nationality": "Indian",
                    "experience": "15 years",
                    "battingStyle": "Right-handed",
                    "bowlingStyle": "Right-arm medium",
                    "pclSeasons": ["2019", "2020", "2021", "2022", "2023"],
                    "basePrice": 15000,
                    "photo": "üèè"
                },
                {
                    "id": 2,
                    "name": "MS Dhoni",
                    "role": "Wicket-keeper",
                    "age": 42,
                    "nationality": "Indian",
                    "experience": "20 years",
                    "battingStyle": "Right-handed",
                    "bowlingStyle": "Right-arm medium",
                    "pclSeasons": ["2019", "2020", "2021", "2022"],
                    "basePrice": 15000,
                    "photo": "üß§"
                },
                {
                    "id": 3,
                    "name": "Jasprit Bumrah",
                    "role": "Bowler",
                    "age": 30,
                    "nationality": "Indian",
                    "experience": "8 years",
                    "battingStyle": "Right-handed",
                    "bowlingStyle": "Right-arm fast",
                    "pclSeasons": ["2020", "2021", "2022", "2023"],
                    "basePrice": 12000,
                    "photo": "‚ö°"
                }
            ];

            // Sample Teams JSON
            const sampleTeams = [
                {
                    "id": 1,
                    "name": "Mumbai Warriors",
                    "budget": 75000,
                    "color": "bg-blue-600",
                    "owner": "Owner 1",
                    "players": []
                },
                {
                    "id": 2,
                    "name": "Delhi Capitals",
                    "budget": 75000,
                    "color": "bg-red-600",
                    "owner": "Owner 2",
                    "players": []
                }
            ];

            // Sample Users JSON
            const sampleUsers = [
                {
                    "id": 1,
                    "username": "admin",
                    "password": "admin123",
                    "role": "admin",
                    "name": "Administrator"
                },
                {
                    "id": 2,
                    "username": "auctioneer",
                    "password": "auction123",
                    "role": "auctioneer",
                    "name": "Auctioneer"
                }
            ];

            // Download players.json
            downloadJSON(samplePlayers, 'players.json');

            // Download teams.json
            setTimeout(() => downloadJSON(sampleTeams, 'teams.json'), 500);

            // Download users.json
            setTimeout(() => downloadJSON(sampleUsers, 'users.json'), 1000);

            alert('Sample JSON files will be downloaded. Use these as templates for your data!');
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.teams) teams = data.teams;
                        if (data.players) players = data.players;
                        if (data.users) users = data.users;
                        if (data.auctionState) {
                            currentPlayerIndex = data.auctionState.currentPlayerIndex || 0;
                            auctionActive = data.auctionState.auctionActive || false;
                            currentBid = data.auctionState.currentBid || 0;
                            currentBidder = data.auctionState.currentBidder || null;
                        }
                        saveToLocalStorage();
                        renderAll();
                        alert('Complete data imported successfully!');
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadSessionData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const sessionData = JSON.parse(e.target.result);

                        // Restore teams with their players
                        if (sessionData.teams) {
                            teams = sessionData.teams.map(team => ({
                                ...team,
                                players: team.players || []
                            }));
                        }

                        // Restore available players
                        if (sessionData.availablePlayers) {
                            const availablePlayers = sessionData.availablePlayers.map(player => ({
                                ...player,
                                currentBid: 0,
                                status: 'available',
                                soldTo: null
                            }));

                            // Restore sold players
                            const soldPlayers = sessionData.soldPlayers ? sessionData.soldPlayers.map(player => ({
                                ...player,
                                currentBid: player.soldPrice,
                                status: 'sold'
                            })) : [];

                            players = [...availablePlayers, ...soldPlayers];
                        }

                        // Restore auction state
                        if (sessionData.auctionState) {
                            currentPlayerIndex = sessionData.auctionState.currentPlayerIndex || 0;
                            auctionActive = sessionData.auctionState.auctionActive || false;
                            currentBid = sessionData.auctionState.currentBid || 0;
                            currentBidder = sessionData.auctionState.currentBidder || null;
                        }

                        localStorage.setItem('auctionData', JSON.stringify({
                            teams: teams,
                            players: players,
                            currentPlayerIndex: currentPlayerIndex,
                            auctionActive: auctionActive,
                            currentBid: currentBid,
                            currentBidder: currentBidder,
                            timestamp: new Date().toISOString()
                        }));

                        renderAll();
                        alert(`Session restored successfully! 
                        Teams: ${teams.length}
                        Available Players: ${players.filter(p => p.status === 'available').length}
                        Sold Players: ${players.filter(p => p.status === 'sold').length}
                        Session Date: ${sessionData.timestamp ? new Date(sessionData.timestamp).toLocaleString() : 'Unknown'}`);
                    } catch (error) {
                        alert('Error loading session data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        const manualSaveJSONFiles = debounce(async function () {
            if (isProcessing) return;

            if (confirm('This will download updated JSON files with current auction state. Continue?')) {
                showLoading('Preparing JSON files for download...');

                try {
                    // Save players.json (only available and unsold players)
                    const availablePlayers = players.filter(p => p.status === 'available' || p.status === 'unsold');
                    const playersData = availablePlayers.map(player => ({
                        id: player.id,
                        name: player.name,
                        role: player.role,
                        battingStyle: player.battingStyle,
                        bowlingStyle: player.bowlingStyle,
                        pclSeasons: player.pclSeasons,
                        basePrice: player.basePrice,
                        photo: player.photo
                    }));

                    downloadJSON(playersData, 'players_updated.json');

                    // Save teams.json (with sold players included)
                    const teamsData = teams.map(team => ({
                        id: team.id,
                        name: team.name,
                        budget: team.budget,
                        color: team.color,
                        owner: team.owner,
                        players: team.players.map(player => ({
                            id: player.id,
                            name: player.name,
                            role: player.role,
                            battingStyle: player.battingStyle,
                            bowlingStyle: player.bowlingStyle,
                            pclSeasons: player.pclSeasons,
                            basePrice: player.basePrice,
                            soldPrice: player.soldPrice,
                            photo: player.photo
                        }))
                    }));

                    // Delay team file download to avoid browser blocking multiple downloads
                    setTimeout(() => {
                        downloadJSON(teamsData, 'teams_updated.json');
                    }, 1000);

                    // Save complete session data
                    setTimeout(() => {
                        const sessionData = {
                            teams: teamsData,
                            availablePlayers: playersData,
                            soldPlayers: players.filter(p => p.status === 'sold').map(player => ({
                                id: player.id,
                                name: player.name,
                                role: player.role,
                                soldTo: player.soldTo,
                                soldPrice: player.currentBid,
                                soldToTeam: teams.find(t => t.id === player.soldTo)?.name
                            })),
                            auctionState: {
                                currentPlayerIndex: currentPlayerIndex,
                                auctionActive: auctionActive,
                                currentBid: currentBid,
                                currentBidder: currentBidder
                            },
                            timestamp: new Date().toISOString()
                        };
                        downloadJSON(sessionData, 'auction_session.json');
                        hideLoading();

                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                        successMsg.textContent = 'JSON files downloaded successfully!';
                        document.body.appendChild(successMsg);

                        setTimeout(() => {
                            if (successMsg.parentNode) {
                                successMsg.parentNode.removeChild(successMsg);
                            }
                        }, 3000);
                    }, 2000);

                } catch (error) {
                    hideLoading();
                    console.error('Error downloading files:', error);
                    alert('Error occurred while preparing files. Please try again.');
                }
            }
        }, 1000);

        // Initialize empty data arrays
        let teams = [];
        let players = [];
        let users = [];
        let auctionSettings = {};

        // Default fallback data (used if JSON files are not loaded)
        const defaultTeams = [
            { id: 1, name: 'Mumbai Warriors', budget: 75000, players: [], color: 'bg-blue-600' },
            { id: 2, name: 'Delhi Capitals', budget: 75000, players: [], color: 'bg-red-600' },
            { id: 3, name: 'Chennai Kings', budget: 75000, players: [], color: 'bg-yellow-600' },
            { id: 4, name: 'Kolkata Knights', budget: 75000, players: [], color: 'bg-purple-600' },
            { id: 5, name: 'Bangalore Royals', budget: 75000, players: [], color: 'bg-green-600' },
            { id: 6, name: 'Hyderabad Titans', budget: 75000, players: [], color: 'bg-orange-600' }
        ];

        const defaultPlayers = [
            {
                id: 1, name: 'Virat Kohli', role: 'Batsman', basePrice: 15000, currentBid: 0, status: 'available', soldTo: null, photo: 'üèè',
                battingStyle: 'Right-handed', bowlingStyle: 'Right-arm medium', pclSeasons: ['2019', '2020', '2021', '2022', '2023'],
                age: 35, nationality: 'Indian', experience: '15 years'
            },
            {
                id: 2, name: 'Rohit Sharma', role: 'Batsman', basePrice: 15000, currentBid: 0, status: 'available', soldTo: null, photo: 'üèè',
                battingStyle: 'Right-handed', bowlingStyle: 'Right-arm off-break', pclSeasons: ['2019', '2020', '2021', '2022', '2023'],
                age: 37, nationality: 'Indian', experience: '17 years'
            }
        ];

        const defaultUsers = [
            { id: 1, username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator' },
            { id: 2, username: 'auctioneer', password: 'auction123', role: 'auctioneer', name: 'Auctioneer' }
        ];

        const defaultSettings = {
            maxTeams: 10,
            maxPlayersPerTeam: 15,
            defaultBudget: 75000,
            bidIncrement: 1000,
            auctionName: 'Persistent Cricket League 2025'
        };

        // Copy viewer URL to clipboard
        function copyViewerUrl() {
            const url = `${window.location.origin}${window.location.pathname}?view=teams`;
            navigator.clipboard.writeText(url).then(() => {
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                successMsg.textContent = 'Viewer URL copied to clipboard!';
                document.body.appendChild(successMsg);

                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 2000);
            });
        }

        // Check for viewer mode
        function checkViewerMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('view') === 'teams') {
                // Direct viewer mode - skip login
                currentUser = 'viewer';
                currentRole = 'viewer';
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userRole').textContent = 'Live Viewer';
                document.getElementById('viewerInfo').classList.remove('hidden');

                // Hide admin tabs and logout for viewer
                document.querySelector('[data-tab="auction"]').style.display = 'none';
                document.querySelector('[data-tab="players"]').style.display = 'none';
                document.querySelector('[data-tab="settings"]').style.display = 'none';
                document.querySelector('button[onclick="logout()"]').style.display = 'none';

                showTab('teams');
                startViewerAutoRefresh();
                return true;
            }
            return false;
        }

        // Auto-refresh for viewer mode with enhanced data loading
        function startViewerAutoRefresh() {
            setInterval(() => {
                if (currentRole === 'viewer') {
                    console.log('Refreshing viewer data at:', new Date().toLocaleTimeString());

                    // Force reload from localStorage
                    const dataLoaded = loadFromLocalStorage();

                    if (dataLoaded) {
                        console.log('Data refreshed - Teams:', teams.length, 'Players:', players.length);
                        renderTeams();
                    } else {
                        console.log('No data found, using defaults');
                        // If no data, ensure we have defaults
                        if (teams.length === 0) {
                            teams = [...defaultTeams];
                        }
                        if (players.length === 0) {
                            players = [...defaultPlayers];
                        }
                        renderTeams();
                    }
                }
            }, 2000); // Refresh every 2 seconds
        }

        // Login functionality
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }

            // Check against loaded users or default users
            const allUsers = users.length > 0 ? users : defaultUsers;
            const user = allUsers.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user.username;
                currentRole = user.role;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userRole').textContent = user.name || user.role;

                // Show viewer URL for admin users
                if (user.role === 'admin') {
                    document.getElementById('viewerUrl').classList.remove('hidden');
                }

                showTab('auction');
                renderAll();
            } else {
                alert('Invalid credentials');
            }
        }

        function logout() {
            currentUser = null;
            currentRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('border-yellow-400'));

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-yellow-400');

            // Render content based on tab
            if (tabName === 'auction') renderAuction();
            if (tabName === 'players') renderPlayers();
            if (tabName === 'teams') renderTeams();
        }

        // Auction functionality
        function renderAuction() {
            // Initialize auction if not done
            if (availablePlayerPool.length === 0 && !currentAuctionPlayer && players.filter(p => p.status === 'available').length > 0) {
                initializeAuctionQueue();
            }

            // Get current player
            const currentPlayer = getCurrentAuctionPlayer();

            // Render current player
            if (currentPlayer) {
                document.getElementById('currentPlayerCard').innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-black rounded-xl p-6 mb-4">
                        <div class="flex items-start space-x-6 mb-4">
                            <div class="flex-shrink-0">
                                ${currentPlayer.photo && (currentPlayer.photo.startsWith('data:') || currentPlayer.photo.includes('/') || currentPlayer.photo.includes('.')) ?
                        `<img src="${currentPlayer.photo}" alt="${currentPlayer.name}" class="w-40 h-40 rounded-xl object-cover border-4 border-white shadow-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                     <div class="w-40 h-40 rounded-xl bg-white/20 items-center justify-center text-8xl border-4 border-white shadow-lg" style="display:none;">üë§</div>` :
                        `<div class="w-40 h-40 rounded-xl bg-white/20 flex items-center justify-center text-8xl border-4 border-white shadow-lg">${currentPlayer.photo || 'üë§'}</div>`
                    }
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold">${currentPlayer.name}</h3>
                                <p class="text-lg">${currentPlayer.role}</p>
                                <p class="text-sm">Base Price: ‚Çπ${currentPlayer.basePrice.toLocaleString()}</p>
                                <div class="grid grid-cols-2 gap-2 mt-3 text-xs">
                                    <div><strong>Batting:</strong> ${currentPlayer.battingStyle || 'N/A'}</div>
                                    <div><strong>Bowling:</strong> ${currentPlayer.bowlingStyle || 'N/A'}</div>
                                    <div><strong>PCL Runs:</strong> ${currentPlayer.runs || 'N/A'}</div>
                                    <div><strong>PCL Wickets:</strong> ${currentPlayer.wickets || 'N/A'}</div>
                                    <div class="col-span-2"><strong>PCL Seasons:</strong> ${currentPlayer.pclSeasons ? currentPlayer.pclSeasons.join(', ') : 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-lg font-bold">Current Bid: ‚Çπ${currentPlayer.currentBid.toLocaleString()}</p>
                            ${currentBidder ? `<p class="text-sm">Leading: ${teams.find(t => t.id === currentBidder)?.name}</p>` : ''}
                            <div class="flex justify-between text-xs text-gray-800 mt-2">
                                <span>Available: ${availablePlayerPool.length}</span>
                                <span>Sold: ${players.filter(p => p.status === 'sold').length}</span>
                                <span>Unsold: ${unsoldPlayers.length}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        ${availablePlayerPool.length === 0 && !currentAuctionPlayer && players.filter(p => p.status === 'available').length > 0 ? `
                            <button onclick="initializeAuctionQueue(); renderAuction();" class="bg-purple-500 hover:bg-purple-600 px-6 py-2 rounded-lg transition-colors">
                                üé≤ Start Random Auction
                            </button>
                        ` : ''}
                        ${currentAuctionPlayer ? `
                        <button onclick="startBidding()" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded-lg transition-colors">
                            Start Bidding
                        </button>
                        <button onclick="unsoldPlayer()" class="bg-red-500 hover:bg-red-600 px-6 py-2 rounded-lg transition-colors">
                            Unsold
                        </button>
                            <button onclick="nextPlayer()" class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg transition-colors">
                                Next Player
                            </button>
                        ` : ''}
                    </div>
                `;

                // Render bidding panel for admin
                if (auctionActive) {
                    document.getElementById('biddingPanel').innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Select Team</label>
                                <select id="biddingTeam" class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white" onchange="updateBidLimits()">
                                    <option value="" class="bg-gray-800 text-white">Select Team</option>
                                    ${teams.map(team => {
                        const remainingSlots = 15 - team.players.length;
                        const maxBidAmount = calculateMaxBidForTeam(team, currentPlayer.basePrice);
                        const isEligible = team.budget >= currentPlayer.basePrice && remainingSlots > 0 && maxBidAmount >= currentPlayer.basePrice;
                        return `
                                        <option value="${team.id}" class="bg-gray-800 text-white" ${!isEligible ? 'disabled' : ''} data-max-bid="${maxBidAmount}">
                                            ${team.name} (‚Çπ${team.budget.toLocaleString()}) - Max: ‚Çπ${maxBidAmount.toLocaleString()} ${!isEligible ? '- Ineligible' : ''}
                                        </option>
                                    `}).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Current Bid Amount</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="bidAmount" value="${Math.max(currentPlayer.currentBid + 1000, currentPlayer.basePrice)}" 
                                           class="flex-1 px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white" step="1000" min="${currentPlayer.basePrice}" oninput="updateCurrentBid()">
                                    <button onclick="increaseBid()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors text-white font-bold">
                                        +‚Çπ1000
                                    </button>
                                </div>
                                <div id="bidLimitWarning" class="text-xs text-yellow-400 mt-1 hidden">
                                    ‚ö†Ô∏è Bid exceeds team's maximum allowed amount
                                </div>
                            </div>
                            <button onclick="soldToSelectedTeam()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-colors">
                                Sold to Selected Team
                            </button>
                        </div>
                    `;
                } else {
                    document.getElementById('biddingPanel').innerHTML = '<div class="text-gray-400 text-center">Start bidding to place bids</div>';
                }
            } else {
                document.getElementById('currentPlayerCard').innerHTML = '<div class="text-gray-400 text-center">Auction Complete!</div>';
                document.getElementById('biddingPanel').innerHTML = '<div class="text-gray-400 text-center">Auction Complete!</div>';
            }

            // Render teams overview
            renderTeamsOverview();

            // Render player queue
            renderPlayerQueue();

            // Render all teams players
            renderAllTeamsPlayers();
        }

        function calculateMaxBidForTeam(team, currentPlayerBasePrice) {
            const remainingSlots = 15 - team.players.length;
            if (remainingSlots === 0) return 0; // Team is full

            // If this is the last slot, team can spend all remaining budget
            if (remainingSlots === 1) {
                return team.budget;
            }

            // Calculate minimum budget needed for remaining slots after this purchase
            const minBudgetForRemainingSlots = (remainingSlots - 1) * 500; // 500 is minimum base price
            const maxBidAmount = team.budget - minBudgetForRemainingSlots;

            // Ensure bid is at least the base price
            return Math.max(maxBidAmount, currentPlayerBasePrice);
        }

        function renderTeamsOverview() {
            const currentPlayer = players.filter(p => p.status === 'available')[currentPlayerIndex];
            const currentBasePrice = currentPlayer ? currentPlayer.basePrice : 500;

            const teamsHtml = teams.map(team => {
                const totalBudget = 75000;
                const spent = totalBudget - team.budget;
                const spentPercentage = ((spent / totalBudget) * 100).toFixed(1);
                const remainingPercentage = ((team.budget / totalBudget) * 100).toFixed(1);
                const remainingSlots = 15 - team.players.length;
                const maxBidAmount = calculateMaxBidForTeam(team, currentBasePrice);
                const isEligible = team.budget >= currentBasePrice && remainingSlots > 0 && maxBidAmount >= currentBasePrice;

                // Calculate budget constraint warning
                const minBudgetNeeded = remainingSlots * 500;
                const isConstrainted = team.budget <= minBudgetNeeded && remainingSlots > 1;

                return `
                <div class="p-3 bg-white/5 rounded-lg ${!isEligible ? 'opacity-50' : ''} ${isConstrainted ? 'border border-yellow-500/30' : ''}">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center">
                            <div class="w-3 h-3 ${team.color} rounded-full mr-3"></div>
                            <span class="font-medium">${team.name}</span>
                            ${!isEligible ? '<span class="text-xs text-red-400 ml-2">(Ineligible)</span>' : ''}
                            ${isConstrainted ? '<span class="text-xs text-yellow-400 ml-2">(‚ö†Ô∏è Budget Tight)</span>' : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold">‚Çπ${team.budget.toLocaleString()}</div>
                            <div class="text-xs text-gray-400">${team.players.length}/15 players</div>
                            <div class="text-xs ${isEligible ? 'text-green-400' : 'text-red-400'}">
                                Max Bid: ‚Çπ${maxBidAmount.toLocaleString()}
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-300">
                        <div class="flex justify-between">
                            <span>Spent: ‚Çπ${spent.toLocaleString()} (${spentPercentage}%)</span>
                            <span>Slots: ${remainingSlots} left</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-1">
                            <div class="${team.color} h-2 rounded-full" style="width: ${spentPercentage}%"></div>
                        </div>
                        ${isConstrainted ? `
                        <div class="text-xs text-yellow-400 mt-1">
                            ‚ö†Ô∏è Must reserve ‚Çπ${minBudgetNeeded.toLocaleString()} for ${remainingSlots} slots
                        </div>
                        ` : ''}
                    </div>
                </div>
            `}).join('');

            document.getElementById('teamsOverview').innerHTML = teamsHtml;
        }

        let filteredPlayers = [];

        // Shuffle array function for random player selection
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function renderPlayerQueue() {
            // Show all available players
            const displayPlayers = players.filter(p => p.status === 'available');
            filteredPlayers = displayPlayers; // Initialize filtered players

            const queueHtml = displayPlayers.map((player) => {
                const isCurrentPlayer = currentAuctionPlayer && currentAuctionPlayer.id === player.id;
                const isUnsold = unsoldPlayers.includes(player.id);

                return `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10 ${isCurrentPlayer ? 'ring-2 ring-yellow-400 bg-yellow-500/10' : ''} ${isUnsold ? 'border-orange-400/50' : ''}" data-player-id="${player.id}">
                    <div class="flex items-start space-x-3 mb-3">
                        <div class="text-2xl relative">
                            ${player.photo && (player.photo.startsWith('data:') || player.photo.includes('/') || player.photo.includes('.')) ?
                        `<img src="${player.photo}" alt="${player.name}" class="w-10 h-10 rounded-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                 <span style="display:none;">üë§</span>` :
                        (player.photo || 'üë§')
                    }
                            ${isCurrentPlayer ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full"></div>' : ''}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                            <h4 class="font-bold text-sm">${player.name}</h4>
                                <span class="text-xs px-2 py-1 rounded ${isCurrentPlayer ? 'bg-yellow-500 text-black' : isUnsold ? 'bg-orange-500' : 'bg-gray-600'}">
                                    ${isCurrentPlayer ? 'CURRENT' : isUnsold ? 'UNSOLD' : 'AVAILABLE'}
                                </span>
                            </div>
                            <p class="text-xs text-gray-300">${player.role}</p>
                            <p class="text-xs">‚Çπ${player.basePrice.toLocaleString()}</p>
                            ${player.age ? `<p class="text-xs text-gray-400">Age: ${player.age}</p>` : ''}
                            ${player.pclSeasons && player.pclSeasons.length > 0 ? `<p class="text-xs text-gray-400">PCL: ${player.pclSeasons.join(', ')}</p>` : ''}
                        </div>
                    </div>
                    ${isCurrentPlayer ? `
                        <div class="text-xs bg-yellow-500/20 text-yellow-300 p-2 rounded mb-2">
                            üéØ Currently in auction
                        </div>
                    ` : ''}
                    ${!isCurrentPlayer ? `
                    <div class="flex space-x-2">
                            <button onclick="selectPlayerForAuction(${player.id})" class="flex-1 text-xs bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded transition-colors">
                                Select for Auction
                    </button>
                </div>
                    ` : ''}
                </div>
            `}).join('');

            document.getElementById('playerQueue').innerHTML = queueHtml;
            updateSearchResults(displayPlayers.length, displayPlayers.length);
        }

        function filterPlayers() {
            const searchTerm = document.getElementById('playerSearch').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const availablePlayers = players.filter(p => p.status === 'available');

            filteredPlayers = availablePlayers.filter(player => {
                const matchesSearch = !searchTerm ||
                    player.name.toLowerCase().includes(searchTerm) ||
                    player.role.toLowerCase().includes(searchTerm) ||
                    (player.pclSeasons && player.pclSeasons.some(season => season.includes(searchTerm))) ||
                    (player.battingStyle && player.battingStyle.toLowerCase().includes(searchTerm)) ||
                    (player.bowlingStyle && player.bowlingStyle.toLowerCase().includes(searchTerm));

                const matchesRole = !roleFilter || player.role === roleFilter;

                return matchesSearch && matchesRole;
            });

            renderFilteredPlayers();
            updateSearchResults(filteredPlayers.length, availablePlayers.length);
        }

        function renderFilteredPlayers() {
            const queueHtml = filteredPlayers.map((player) => {
                const isCurrentPlayer = currentAuctionPlayer && currentAuctionPlayer.id === player.id;
                const isUnsold = unsoldPlayers.includes(player.id);

                return `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10 ${isCurrentPlayer ? 'ring-2 ring-yellow-400' : ''}" data-player-id="${player.id}">
                    <div class="flex items-start space-x-3 mb-3">
                        <div class="text-2xl">
                            ${player.photo && (player.photo.startsWith('data:') || player.photo.includes('/') || player.photo.includes('.')) ?
                        `<img src="${player.photo}" alt="${player.name}" class="w-8 h-8 rounded-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                 <span style="display:none;">üë§</span>` :
                        (player.photo || 'üë§')
                    }
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                            <h4 class="font-bold text-sm">${player.name}</h4>
                                <span class="text-xs px-2 py-1 rounded ${isCurrentPlayer ? 'bg-yellow-500 text-black' : isUnsold ? 'bg-orange-500' : 'bg-gray-600'}">
                                    ${isCurrentPlayer ? 'CURRENT' : isUnsold ? 'UNSOLD' : 'AVAILABLE'}
                                </span>
                            </div>
                            <p class="text-xs text-gray-300">${player.role}</p>
                            <p class="text-xs">‚Çπ${player.basePrice.toLocaleString()}</p>
                            ${player.age ? `<p class="text-xs text-gray-400">Age: ${player.age}</p>` : ''}
                            ${player.pclSeasons && player.pclSeasons.length > 0 ? `<p class="text-xs text-gray-400">PCL: ${player.pclSeasons.join(', ')}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="selectPlayerForAuction(${player.id})" class="flex-1 text-xs bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded transition-colors">
                            Select for Auction
                        </button>
                        <button onclick="startAuctionForPlayer(${player.id})" class="flex-1 text-xs bg-green-500 hover:bg-green-600 px-2 py-1 rounded transition-colors">
                            Start Auction
                        </button>
                    </div>
                </div>
            `}).join('');

            document.getElementById('playerQueue').innerHTML = queueHtml;
        }

        function updateSearchResults(filtered, total) {
            const resultsDiv = document.getElementById('playerSearchResults');
            if (filtered < total) {
                resultsDiv.textContent = `Showing ${filtered} of ${total} players`;
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('hidden');
            }
        }

        function clearFilters() {
            document.getElementById('playerSearch').value = '';
            document.getElementById('roleFilter').value = '';
            filterPlayers();
        }

        function selectPlayerForAuction(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player && player.status === 'available') {
                currentAuctionPlayer = player;
                auctionActive = false;
                currentBidder = null;
                renderAuction();
                console.log(`Manually selected player: ${player.name}`);
            }
        }

        function startAuctionForPlayer(playerId) {
            selectPlayerForAuction(playerId);
            setTimeout(() => {
                startBidding();
            }, 100);
        }

        function renderAllTeamsPlayers() {
            const teamsHtml = teams.map(team => `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="flex items-center mb-3">
                        <div class="w-3 h-3 ${team.color} rounded-full mr-3"></div>
                        <h4 class="font-bold">${team.name}</h4>
                    </div>
                    <div class="text-xs text-gray-400 mb-3">
                        Budget: ‚Çπ${team.budget.toLocaleString()} | Players: ${team.players.length}/15
                    </div>
                    <div class="space-y-2">
                        ${team.players.length > 0 ? team.players.map(player => `
                            <div class="flex justify-between text-sm bg-white/5 rounded p-2">
                                <span>${player.name} (${player.role})</span>
                                <span class="text-green-400">‚Çπ${player.soldPrice.toLocaleString()}</span>
                            </div>
                        `).join('') : '<p class="text-gray-400 text-sm">No players yet</p>'}
                    </div>
                </div>
            `).join('');

            document.getElementById('allTeamsPlayers').innerHTML = teamsHtml;
        }

        function startBidding() {
            auctionActive = true;
            const currentPlayer = getCurrentAuctionPlayer();
            if (currentPlayer && currentPlayer.basePrice) {
                currentPlayer.currentBid = currentPlayer.basePrice;
                currentBid = currentPlayer.basePrice;
                currentBidder = null;
                renderAuction();
            } else {
                console.error('No valid player found for bidding');
                alert('No valid player available for bidding');
                auctionActive = false;
            }
        }

        function updateBidLimits() {
            const teamSelect = document.getElementById('biddingTeam');
            const bidAmountInput = document.getElementById('bidAmount');
            const warningDiv = document.getElementById('bidLimitWarning');

            if (teamSelect && bidAmountInput && warningDiv) {
                const selectedOption = teamSelect.options[teamSelect.selectedIndex];
                const maxBid = selectedOption ? parseInt(selectedOption.getAttribute('data-max-bid')) : 0;
                const currentBid = parseInt(bidAmountInput.value);

                if (maxBid > 0) {
                    bidAmountInput.max = maxBid;
                    if (currentBid > maxBid) {
                        warningDiv.classList.remove('hidden');
                        bidAmountInput.classList.add('border-red-500');
                    } else {
                        warningDiv.classList.add('hidden');
                        bidAmountInput.classList.remove('border-red-500');
                    }
                }
            }
        }

        function updateCurrentBid() {
            const bidAmountInput = document.getElementById('bidAmount');
            if (bidAmountInput) {
                const currentPlayer = getCurrentAuctionPlayer();
                if (currentPlayer) {
                    const newBidAmount = parseInt(bidAmountInput.value) || currentPlayer.basePrice;
                    currentPlayer.currentBid = newBidAmount;
                    currentBid = newBidAmount;

                    // Update the display immediately
                    const currentBidDisplay = document.querySelector('.text-lg.font-bold');
                    if (currentBidDisplay && currentBidDisplay.textContent.includes('Current Bid:')) {
                        currentBidDisplay.textContent = `Current Bid: ‚Çπ${newBidAmount.toLocaleString()}`;
                    }
                }
                updateBidLimits();
            }
        }

        function increaseBid() {
            const bidAmountInput = document.getElementById('bidAmount');
            const teamSelect = document.getElementById('biddingTeam');
            const currentAmount = parseInt(bidAmountInput.value);
            const newAmount = currentAmount + 1000;

            // Check if team is selected and validate max bid
            if (teamSelect && teamSelect.value) {
                const selectedOption = teamSelect.options[teamSelect.selectedIndex];
                const maxBid = parseInt(selectedOption.getAttribute('data-max-bid'));

                if (newAmount <= maxBid) {
                    bidAmountInput.value = newAmount;
                } else {
                    bidAmountInput.value = maxBid;
                    alert(`Maximum bid for this team is ‚Çπ${maxBid.toLocaleString()}`);
                }
            } else {
                bidAmountInput.value = newAmount;
            }

            // Update current bid display
            const currentPlayer = getCurrentAuctionPlayer();
            if (currentPlayer) {
                currentPlayer.currentBid = parseInt(bidAmountInput.value);
                currentBid = parseInt(bidAmountInput.value);

                // Update the display immediately
                const currentBidDisplay = document.querySelector('.text-lg.font-bold');
                if (currentBidDisplay && currentBidDisplay.textContent.includes('Current Bid:')) {
                    currentBidDisplay.textContent = `Current Bid: ‚Çπ${currentPlayer.currentBid.toLocaleString()}`;
                }
            }
            updateBidLimits();
        }

        function soldToSelectedTeam() {
            const teamId = parseInt(document.getElementById('biddingTeam').value);
            const bidAmount = parseInt(document.getElementById('bidAmount').value);

            if (!teamId) {
                alert('Please select a team');
                return;
            }

            const currentPlayer = getCurrentAuctionPlayer();
            if (!currentPlayer) {
                alert('No player selected for auction');
                return;
            }

            const selectedTeam = teams.find(t => t.id === teamId);

            if (!selectedTeam) {
                alert('Selected team not found');
                return;
            }

            if (bidAmount > selectedTeam.budget) {
                alert('Team has insufficient budget');
                return;
            }

            if (selectedTeam.players.length >= 15) {
                alert('Team is full (15 players maximum)');
                return;
            }

            // Validate bid amount against team constraints
            const maxAllowedBid = calculateMaxBidForTeam(selectedTeam, currentPlayer.basePrice);
            if (bidAmount > maxAllowedBid) {
                alert(`Bid amount ‚Çπ${bidAmount.toLocaleString()} exceeds team's maximum allowed bid of ‚Çπ${maxAllowedBid.toLocaleString()}`);
                return;
            }

            // Store player name for success message
            const playerName = currentPlayer.name;
            const teamName = selectedTeam.name;

            // Sell player to selected team
            selectedTeam.budget -= bidAmount;
            selectedTeam.players.push({ ...currentPlayer, soldPrice: bidAmount });
            currentPlayer.status = 'sold';
            currentPlayer.soldTo = teamId;
            currentPlayer.currentBid = bidAmount;

            // Remove sold player from available pool
            availablePlayerPool = availablePlayerPool.filter(id => id !== currentPlayer.id);

            // Save to localStorage immediately
            saveToLocalStorage();

            // Move to next player and update UI
            nextPlayer();

            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successMsg.textContent = `${playerName} sold to ${teamName} for ‚Çπ${bidAmount.toLocaleString()}!`;
            document.body.appendChild(successMsg);

            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.parentNode.removeChild(successMsg);
                }
            }, 3000);
        }

        let availablePlayerPool = [];
        let unsoldPlayers = [];
        let currentAuctionPlayer = null;

        function initializeAuctionQueue() {
            // Get all available players and create the pool
            availablePlayerPool = players.filter(p => p.status === 'available').map(p => p.id);
            unsoldPlayers = [];
            currentAuctionPlayer = null;

            // Pick first random player
            if (availablePlayerPool.length > 0) {
                pickRandomPlayer();
            }

            console.log(`Auction initialized with ${availablePlayerPool.length} available players`);
        }

        function pickRandomPlayer() {
            if (availablePlayerPool.length === 0) {
                // No more players in main pool, check unsold players
                if (unsoldPlayers.length > 0) {
                    // Move unsold players back to available pool
                    availablePlayerPool = [...unsoldPlayers];
                    unsoldPlayers = [];

                    // Show message about unsold round
                    const unsoldMsg = document.createElement('div');
                    unsoldMsg.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-orange-600 text-white px-8 py-4 rounded-lg shadow-lg z-50 text-center';
                    unsoldMsg.innerHTML = `
                        <h3 class="text-xl font-bold mb-2">üîÑ Unsold Players Round</h3>
                        <p>Auctioning ${availablePlayerPool.length} unsold players</p>
                    `;
                    document.body.appendChild(unsoldMsg);

                    setTimeout(() => {
                        if (unsoldMsg.parentNode) {
                            unsoldMsg.parentNode.removeChild(unsoldMsg);
                        }
                    }, 3000);
                }
            }

            if (availablePlayerPool.length > 0) {
                // Pick random player from available pool
                const randomIndex = Math.floor(Math.random() * availablePlayerPool.length);
                const selectedPlayerId = availablePlayerPool[randomIndex];

                // Find the actual player object
                currentAuctionPlayer = players.find(p => p.id === selectedPlayerId);

                if (currentAuctionPlayer) {
                    console.log(`Selected random player: ${currentAuctionPlayer.name}`);
                    return currentAuctionPlayer;
                }
            }

            // No more players available
            currentAuctionPlayer = null;

            // Check if auction is complete
            if (availablePlayerPool.length === 0 && unsoldPlayers.length === 0) {
                showAuctionComplete();
            }

            return null;
        }

        function getCurrentAuctionPlayer() {
            return currentAuctionPlayer;
        }

        function showAuctionComplete() {
            const completeMsg = document.createElement('div');
            completeMsg.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-600 text-white px-8 py-4 rounded-lg shadow-lg z-50 text-center';
            completeMsg.innerHTML = `
                <h3 class="text-xl font-bold mb-2">üéâ Auction Complete!</h3>
                <p>All ${players.filter(p => p.status === 'sold').length} players have been sold</p>
                <p class="text-sm mt-2">Remaining unsold: ${players.filter(p => p.status === 'unsold').length}</p>
            `;
            document.body.appendChild(completeMsg);

            setTimeout(() => {
                if (completeMsg.parentNode) {
                    completeMsg.parentNode.removeChild(completeMsg);
                }
            }, 5000);

            console.log('Auction completed - all available players processed');
        }

        function unsoldPlayer(playerId = null) {
            if (playerId) {
                // Unsold from player management dashboard
                const player = players.find(p => p.id === playerId);
                if (player && player.status === 'sold') {
                    // Find the team that bought this player
                    const team = teams.find(t => t.id === player.soldTo);
                    if (team) {
                        // Remove player from team and refund budget
                        team.players = team.players.filter(p => p.id !== playerId);
                        team.budget += player.currentBid;
                    }

                    // Reset player status
                    player.status = 'available';
                    player.soldTo = null;
                    player.currentBid = 0;

                    // Add back to auction queue if auction is ongoing
                    if (auctionActive || auctionQueue.length > 0) {
                        auctionQueue.push(player);
                    }

                    // Save to localStorage
                    saveToLocalStorage();

                    // Update UI
                    renderAll();

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    successMsg.textContent = `${player.name} is now available for auction again!`;
                    document.body.appendChild(successMsg);

                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 3000);
                }
            } else {
                // Unsold from auction (current player)
                const currentPlayer = getCurrentAuctionPlayer();
                if (currentPlayer) {
                    currentPlayer.status = 'unsold';

                    // Remove from available pool and add to unsold list
                    availablePlayerPool = availablePlayerPool.filter(id => id !== currentPlayer.id);
                    unsoldPlayers.push(currentPlayer.id);

                    // Show unsold message
                    const unsoldMsg = document.createElement('div');
                    unsoldMsg.className = 'fixed top-4 right-4 bg-orange-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    unsoldMsg.textContent = `${currentPlayer.name} goes unsold - will return later`;
                    document.body.appendChild(unsoldMsg);

                    setTimeout(() => {
                        if (unsoldMsg.parentNode) {
                            unsoldMsg.parentNode.removeChild(unsoldMsg);
                        }
                    }, 3000);

                    saveToLocalStorage();
                    nextPlayer();
                }
            }
        }

        function nextPlayer() {
            auctionActive = false;
            currentBidder = null;

            // Pick next random player from available pool
            pickRandomPlayer();

            renderAuctionOnly(); // Use optimized render
        }

        function autoAllocateRemainingPlayers(remainingPlayers) {
            const allocationMsg = document.createElement('div');
            allocationMsg.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-orange-600 text-white px-8 py-4 rounded-lg shadow-lg z-50 text-center';
            allocationMsg.innerHTML = `
                <h3 class="text-xl font-bold mb-2">‚ö° Auto-Allocating Remaining Players</h3>
                <p>Distributing ${remainingPlayers.length} unsold players to teams with available slots...</p>
            `;
            document.body.appendChild(allocationMsg);

            // Sort teams by available slots and budget
            const eligibleTeams = teams.filter(team => team.players.length < 15 && team.budget >= 500)
                .sort((a, b) => {
                    const slotsA = 15 - a.players.length;
                    const slotsB = 15 - b.players.length;
                    return slotsB - slotsA; // Teams with more slots first
                });

            let allocatedCount = 0;

            remainingPlayers.forEach(player => {
                // Find a team that can afford this player
                const availableTeam = eligibleTeams.find(team =>
                    team.players.length < 15 &&
                    team.budget >= Math.max(player.basePrice, 500)
                );

                if (availableTeam) {
                    const allocationPrice = Math.max(player.basePrice, 500);

                    // Allocate player to team
                    availableTeam.budget -= allocationPrice;
                    availableTeam.players.push({ ...player, soldPrice: allocationPrice });
                    player.status = 'sold';
                    player.soldTo = availableTeam.id;
                    player.currentBid = allocationPrice;

                    allocatedCount++;
                    console.log(`Auto-allocated ${player.name} to ${availableTeam.name} for ‚Çπ${allocationPrice.toLocaleString()}`);
                }
            });

            // Update allocation message
            setTimeout(() => {
                allocationMsg.innerHTML = `
                    <h3 class="text-xl font-bold mb-2">‚úÖ Auto-Allocation Complete</h3>
                    <p>${allocatedCount} players allocated to teams</p>
                    ${allocatedCount < remainingPlayers.length ? `<p class="text-sm mt-2">‚ö†Ô∏è ${remainingPlayers.length - allocatedCount} players could not be allocated due to budget/slot constraints</p>` : ''}
                `;

                setTimeout(() => {
                    if (allocationMsg.parentNode) {
                        allocationMsg.parentNode.removeChild(allocationMsg);
                    }

                    // Final completion message
                    const finalMsg = document.createElement('div');
                    finalMsg.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-600 text-white px-8 py-4 rounded-lg shadow-lg z-50 text-center';
                    finalMsg.innerHTML = `
                        <h3 class="text-xl font-bold mb-2">üéâ Auction Complete!</h3>
                        <p>All possible players have been allocated</p>
                    `;
                    document.body.appendChild(finalMsg);

                    setTimeout(() => {
                        if (finalMsg.parentNode) {
                            finalMsg.parentNode.removeChild(finalMsg);
                        }
                    }, 5000);

                }, 3000);
            }, 2000);

            // Save changes
            saveToLocalStorage();

            // Update UI
            setTimeout(() => {
                renderAll();
            }, 4000);
        }

        function setCurrentPlayer(index) {
            currentPlayerIndex = index;
            auctionActive = false;
            currentBidder = null;
            renderAuction();
        }

        // Player management
        function renderPlayers() {
            const playersHtml = players.map(player => `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold">${player.name}</h4>
                        <span class="text-xs px-2 py-1 rounded ${player.status === 'available' ? 'bg-green-500' :
                    player.status === 'sold' ? 'bg-blue-500' : 'bg-red-500'
                }">${player.status}</span>
                    </div>
                    <p class="text-sm text-gray-300">${player.role}</p>
                    <p class="text-sm">Base: ‚Çπ${player.basePrice.toLocaleString()}</p>
                    ${player.status === 'sold' ? `
                        <p class="text-sm text-green-400">Sold: ‚Çπ${player.currentBid.toLocaleString()}</p>
                        <p class="text-xs text-gray-400">To: ${teams.find(t => t.id === player.soldTo)?.name}</p>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="editPlayer(${player.id})" class="text-xs bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded">
                                Edit
                            </button>
                            <button onclick="unsoldPlayer(${player.id})" class="text-xs bg-orange-500 hover:bg-orange-600 px-2 py-1 rounded">
                                Unsold
                            </button>
                            <button onclick="removePlayer(${player.id})" class="text-xs bg-red-500 hover:bg-red-600 px-2 py-1 rounded">
                                Remove
                            </button>
                        </div>
                    ` : `
                        <div class="flex space-x-2 mt-2">
                            <button onclick="editPlayer(${player.id})" class="text-xs bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded">
                                Edit
                            </button>
                            <button onclick="removePlayer(${player.id})" class="text-xs bg-red-500 hover:bg-red-600 px-2 py-1 rounded">
                            Remove
                        </button>
                        </div>
                    `}
                </div>
            `).join('');

            document.getElementById('playersGrid').innerHTML = playersHtml;
        }

        function showAddPlayerModal() {
            document.getElementById('addPlayerModal').classList.remove('hidden');
        }

        function closeAddPlayerModal() {
            document.getElementById('addPlayerModal').classList.add('hidden');
            document.getElementById('playerName').value = '';
            document.getElementById('playerAge').value = '';
            document.getElementById('playerExperience').value = '';
            document.getElementById('playerBattingStyle').value = '';
            document.getElementById('playerBowlingStyle').value = '';
            document.getElementById('basePrice').value = '500';
            document.getElementById('playerPhoto').value = '';
            document.getElementById('playerPhotoFile').value = '';

            // Clear checkboxes
            ['2019', '2020', '2021', '2022', '2023', '2024'].forEach(year => {
                document.getElementById(`season${year}`).checked = false;
            });
        }

        function addPlayer() {
            const name = document.getElementById('playerName').value;
            const role = document.getElementById('playerRole').value;
            const age = parseInt(document.getElementById('playerAge').value);
            const experience = document.getElementById('playerExperience').value;
            const battingStyle = document.getElementById('playerBattingStyle').value;
            const bowlingStyle = document.getElementById('playerBowlingStyle').value;
            const basePrice = parseInt(document.getElementById('basePrice').value);
            const photoFile = document.getElementById('playerPhotoFile').files[0];
            const photoText = document.getElementById('playerPhoto').value;

            // Get selected PCL seasons
            const pclSeasons = [];
            ['2019', '2020', '2021', '2022', '2023', '2024'].forEach(year => {
                if (document.getElementById(`season${year}`).checked) {
                    pclSeasons.push(year);
                }
            });

            if (!name || !basePrice) {
                alert('Please fill required fields (Name and Base Price)');
                return;
            }

            try {
                // Handle photo upload
                let photo = photoText || 'üë§';
                if (photoFile) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const newPlayer = {
                            id: Date.now(),
                            name,
                            role,
                            battingStyle: battingStyle || null,
                            bowlingStyle: bowlingStyle || null,
                            pclSeasons: pclSeasons,
                            basePrice,
                            currentBid: 0,
                            status: 'available',
                            soldTo: null,
                            photo: e.target.result
                        };

                        players.push(newPlayer);
                        saveToLocalStorage();
                        closeAddPlayerModal();
                        renderPlayers();

                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                        successMsg.textContent = `${name} added successfully!`;
                        document.body.appendChild(successMsg);

                        setTimeout(() => {
                            if (successMsg.parentNode) {
                                successMsg.parentNode.removeChild(successMsg);
                            }
                        }, 3000);
                    };
                    reader.readAsDataURL(photoFile);
                } else {
                    const newPlayer = {
                        id: Date.now(),
                        name,
                        role,
                        battingStyle: battingStyle || null,
                        bowlingStyle: bowlingStyle || null,
                        pclSeasons: pclSeasons,
                        basePrice,
                        currentBid: 0,
                        status: 'available',
                        soldTo: null,
                        photo
                    };

                    players.push(newPlayer);
                    saveToLocalStorage();
                    closeAddPlayerModal();
                    renderPlayers();

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    successMsg.textContent = `${name} added successfully!`;
                    document.body.appendChild(successMsg);

                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('Error adding player:', error);
                alert('Error occurred while adding player. Please try again.');
            }
        }

        function removePlayer(playerId) {
            players = players.filter(p => p.id !== playerId);
            renderPlayers();
        }

        // Team dashboard
        function renderTeams() {
            const teamsHtml = teams.map(team => {
                const totalBudget = 75000;
                const spent = totalBudget - team.budget;
                const spentPercentage = ((spent / totalBudget) * 100).toFixed(1);
                const remainingSlots = 15 - team.players.length; // Max 15 players per team
                const maxByBudget = Math.floor(team.budget / 500); // Minimum base price is 500
                const maxPlayersCanBuy = Math.min(remainingSlots, maxByBudget);
                const isEligible = team.budget >= 500 && team.budget > 0;

                // Group players by role
                const playersByRole = {
                    'Batsman': team.players.filter(p => p.role === 'Batsman'),
                    'Bowler': team.players.filter(p => p.role === 'Bowler'),
                    'All-Rounder': team.players.filter(p => p.role === 'All-Rounder'),
                    'Wicket-keeper': team.players.filter(p => p.role === 'Wicket-keeper')
                };

                return `
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 ${!isEligible ? 'opacity-75 border-red-500/30' : ''}">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                        <div class="w-4 h-4 ${team.color} rounded-full mr-3"></div>
                        <h3 class="text-xl font-bold">${team.name}</h3>
                            ${!isEligible ? '<span class="text-xs text-red-400 ml-2 px-2 py-1 bg-red-500/20 rounded">Ineligible</span>' : ''}
                        </div>
                        <div class="text-right text-sm">
                            <div class="text-yellow-400 font-bold">‚Çπ${team.budget.toLocaleString()}</div>
                            <div class="text-gray-400">remaining</div>
                        </div>
                    </div>
                    
                    <div class="mb-4 p-3 bg-white/5 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-400">Players:</span>
                                <span class="font-bold ml-2">${team.players.length}/15</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Can buy:</span>
                                <span class="font-bold ml-2 text-blue-400">${maxPlayersCanBuy} more</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Spent:</span>
                                <span class="font-bold ml-2 text-red-400">‚Çπ${spent.toLocaleString()}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Used:</span>
                                <span class="font-bold ml-2">${spentPercentage}%</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-3">
                            <div class="${team.color} h-2 rounded-full transition-all duration-500" style="width: ${spentPercentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        ${Object.entries(playersByRole).map(([role, rolePlayers]) => {
                    if (rolePlayers.length === 0) return '';

                    // Fix role display name
                    const roleDisplayName = role === 'All-Rounder' ? 'All-Rounder' :
                        role === 'Wicket-keeper' ? 'Wicket-keeper' :
                            role + 's';

                    return `
                            <div>
                                <h5 class="text-sm font-medium text-yellow-400 mb-2">${roleDisplayName} (${rolePlayers.length})</h5>
                                <div class="space-y-1">
                                    ${rolePlayers.map(player => `
                                        <div class="flex items-center justify-between text-sm bg-white/5 rounded p-2">
                                            <div class="flex items-center space-x-2">
                                                <div class="text-lg">
                                                    ${player.photo && (player.photo.startsWith('data:') || player.photo.includes('/') || player.photo.includes('.')) ?
                            `<img src="${player.photo}" alt="${player.name || 'Player'}" class="w-6 h-6 rounded-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                                         <span style="display:none;">${player.photo && !player.photo.includes('/') && !player.photo.includes('.') ? player.photo : 'üë§'}</span>` :
                            `<span>${player.photo || 'üë§'}</span>`
                        }
                            </div>
                                                <span class="font-medium">${player.name || 'Unknown Player'}</span>
                                                ${player.age ? `<span class="text-xs text-gray-400">(${player.age}y)</span>` : ''}
                    </div>
                                            <span class="text-green-400 font-bold">‚Çπ${(player.soldPrice || player.currentBid || 0).toLocaleString()}</span>
                </div>
                                    `).join('')}
                                </div>
                            </div>
                        `}).filter(Boolean).join('')}
                        
                        ${team.players.length === 0 ? '<div class="text-center py-8 text-gray-400"><div class="text-4xl mb-2">üèè</div><p>No players yet</p></div>' : ''}
                        
                        ${team.players.length === 0 ? '<div class="text-center py-8 text-gray-400"><div class="text-4xl mb-2">üèè</div><p>No players yet</p></div>' : ''}
                    </div>
                </div>
            `}).join('');

            document.getElementById('teamsGrid').innerHTML = teamsHtml;
        }

        // Settings
        function updateSettings() {
            const numTeams = parseInt(document.getElementById('numTeams').value);
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);

            // Update teams array (simplified - in real app would need more logic)
            while (teams.length < numTeams) {
                teams.push({
                    id: teams.length + 1,
                    name: `Team ${teams.length + 1}`,
                    owner: `owner${teams.length + 1}`,
                    budget: 8000000,
                    players: [],
                    color: 'bg-gray-600'
                });
            }

            if (teams.length > numTeams) {
                teams = teams.slice(0, numTeams);
            }

            alert('Settings updated successfully!');
            renderAll();
        }

        function resetAuction() {
            if (confirm('Are you sure you want to reset the auction? This will clear all bids and team assignments.')) {
                players.forEach(player => {
                    player.status = 'available';
                    player.currentBid = 0;
                    player.soldTo = null;
                });

                teams.forEach(team => {
                    team.players = [];
                    team.budget = 75000;
                });

                currentPlayerIndex = 0;
                auctionActive = false;
                currentBidder = null;

                alert('Auction reset successfully!');
                renderAll();
            }
        }

        function exportData() {
            const data = {
                teams: teams,
                players: players,
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'auction-results.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Optimized render functions with async processing
        function renderAll() {
            // Use requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                renderAuction();
                requestAnimationFrame(() => {
                    renderPlayers();
                    requestAnimationFrame(() => {
                        renderTeams();
                    });
                });
            });
        }

        // Optimized render with selective updates
        function renderAuctionOnly() {
            requestAnimationFrame(() => {
                renderAuction();
            });
        }

        // Edit player functionality
        let currentEditingPlayerId = null;

        function editPlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            currentEditingPlayerId = playerId;

            // Populate edit form with current player data
            document.getElementById('editPlayerName').value = player.name || '';
            document.getElementById('editPlayerRole').value = player.role || 'Batsman';
            document.getElementById('editPlayerAge').value = player.age || '';
            document.getElementById('editPlayerExperience').value = player.experience || '';
            document.getElementById('editPlayerBattingStyle').value = player.battingStyle || '';
            document.getElementById('editPlayerBowlingStyle').value = player.bowlingStyle || '';
            document.getElementById('editBasePrice').value = player.basePrice || 5000;
            document.getElementById('editPlayerPhoto').value = (player.photo && !player.photo.startsWith('data:')) ? player.photo : '';

            // Set PCL seasons checkboxes
            ['2019', '2020', '2021', '2022', '2023', '2024'].forEach(year => {
                const checkbox = document.getElementById(`editSeason${year}`);
                checkbox.checked = player.pclSeasons && player.pclSeasons.includes(year);
            });

            // Show edit modal
            document.getElementById('editPlayerModal').classList.remove('hidden');
        }

        function closeEditPlayerModal() {
            document.getElementById('editPlayerModal').classList.add('hidden');
            currentEditingPlayerId = null;

            // Clear form
            document.getElementById('editPlayerName').value = '';
            document.getElementById('editPlayerAge').value = '';
            document.getElementById('editPlayerExperience').value = '';
            document.getElementById('editPlayerBattingStyle').value = '';
            document.getElementById('editPlayerBowlingStyle').value = '';
            document.getElementById('editBasePrice').value = '';
            document.getElementById('editPlayerPhoto').value = '';
            document.getElementById('editPlayerPhotoFile').value = '';

            // Clear checkboxes
            ['2019', '2020', '2021', '2022', '2023', '2024'].forEach(year => {
                document.getElementById(`editSeason${year}`).checked = false;
            });
        }

        function savePlayerEdit() {
            if (!currentEditingPlayerId) return;

            const player = players.find(p => p.id === currentEditingPlayerId);
            if (!player) return;

            const name = document.getElementById('editPlayerName').value;
            const role = document.getElementById('editPlayerRole').value;
            const age = parseInt(document.getElementById('editPlayerAge').value);
            const experience = document.getElementById('editPlayerExperience').value;
            const battingStyle = document.getElementById('editPlayerBattingStyle').value;
            const bowlingStyle = document.getElementById('editPlayerBowlingStyle').value;
            const basePrice = parseInt(document.getElementById('editBasePrice').value);
            const photoFile = document.getElementById('editPlayerPhotoFile').files[0];
            const photoText = document.getElementById('editPlayerPhoto').value;

            // Get selected PCL seasons
            const pclSeasons = [];
            ['2019', '2020', '2021', '2022', '2023', '2024'].forEach(year => {
                if (document.getElementById(`editSeason${year}`).checked) {
                    pclSeasons.push(year);
                }
            });

            if (!name || !basePrice) {
                alert('Please fill required fields (Name and Base Price)');
                return;
            }

            try {
                // Handle photo upload
                if (photoFile) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        // Update player data
                        player.name = name;
                        player.role = role;
                        player.age = age || null;
                        player.experience = experience || null;
                        player.battingStyle = battingStyle || null;
                        player.bowlingStyle = bowlingStyle || null;
                        player.pclSeasons = pclSeasons;
                        player.basePrice = basePrice;
                        player.photo = e.target.result;

                        // If player is sold, update team roster as well
                        if (player.status === 'sold' && player.soldTo) {
                            const team = teams.find(t => t.id === player.soldTo);
                            if (team) {
                                const teamPlayerIndex = team.players.findIndex(p => p.id === player.id);
                                if (teamPlayerIndex !== -1) {
                                    team.players[teamPlayerIndex] = { ...player };
                                }
                            }
                        }

                        // Save to localStorage
                        saveToLocalStorage();

                        closeEditPlayerModal();
                        renderAll();

                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                        successMsg.textContent = `${name}'s details updated successfully!`;
                        document.body.appendChild(successMsg);

                        setTimeout(() => {
                            if (successMsg.parentNode) {
                                successMsg.parentNode.removeChild(successMsg);
                            }
                        }, 3000);
                    };
                    reader.readAsDataURL(photoFile);
                } else {
                    // Update player data without photo change
                    player.name = name;
                    player.role = role;
                    player.age = age || null;
                    player.experience = experience || null;
                    player.battingStyle = battingStyle || null;
                    player.bowlingStyle = bowlingStyle || null;
                    player.pclSeasons = pclSeasons;
                    player.basePrice = basePrice;

                    // Update photo only if text is provided
                    if (photoText) {
                        player.photo = photoText;
                    }

                    // If player is sold, update team roster as well
                    if (player.status === 'sold' && player.soldTo) {
                        const team = teams.find(t => t.id === player.soldTo);
                        if (team) {
                            const teamPlayerIndex = team.players.findIndex(p => p.id === player.id);
                            if (teamPlayerIndex !== -1) {
                                team.players[teamPlayerIndex] = { ...player };
                            }
                        }
                    }

                    // Save to localStorage
                    saveToLocalStorage();

                    closeEditPlayerModal();
                    renderAll();

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    successMsg.textContent = `${name}'s details updated successfully!`;
                    document.body.appendChild(successMsg);

                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('Error updating player:', error);
                alert('Error occurred while updating player. Please try again.');
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            // Check for viewer mode first
            if (checkViewerMode()) {
                // Load saved data for viewer
                const dataLoaded = loadFromLocalStorage();

                // If no data loaded, use defaults
                if (!dataLoaded || teams.length === 0) {
                    teams = [...defaultTeams];
                }
                if (!dataLoaded || players.length === 0) {
                    players = [...defaultPlayers];
                }

                console.log('Viewer mode initialized with:', teams.length, 'teams and', players.length, 'players');
                renderTeams();
                return;
            }

            // Normal admin mode initialization
            const dataLoaded = loadFromLocalStorage();

            // If no data loaded, use defaults
            if (!dataLoaded || teams.length === 0) {
                teams = [...defaultTeams];
            }
            if (!dataLoaded || players.length === 0) {
                players = [...defaultPlayers];
            }
            if (users.length === 0) {
                users = [...defaultUsers];
            }

            console.log('Admin mode initialized with:', teams.length, 'teams and', players.length, 'players');

            // Set default login for demo
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
        });
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9778c1df17769374',t:'MTc1NjYwMzc3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>