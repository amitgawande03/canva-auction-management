<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Cricket 2025 - Auction App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .pulse-bid {
            animation: pulseBid 1s infinite;
        }

        @keyframes pulseBid {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen text-white">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md border border-white/20">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-yellow-400 mb-2">üèè Persistent Cricket 2025</h1>
                <p class="text-gray-300">Auction Management System</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="username"
                        class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        placeholder="Enter username" value="admin">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="password"
                        class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        placeholder="Enter password" value="admin123">
                </div>

                <button onclick="login()"
                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 rounded-lg transition-colors">
                    Login as Admin
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-black/30 backdrop-blur-lg border-b border-white/20 p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-yellow-400">üèè PC 2025 Auction</h1>
                    <span id="userRole"
                        class="px-3 py-1 bg-yellow-500 text-black rounded-full text-sm font-medium"></span>
                </div>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                    Logout
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-black/20 backdrop-blur-lg border-b border-white/10">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-8">
                    <button onclick="showTab('auction')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="auction">Live Auction</button>
                    <button onclick="showTab('players')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="players">Player Management</button>
                    <button onclick="showTab('teams')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="teams">Team Dashboard</button>
                    <button onclick="showTab('settings')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="settings">Settings</button>
                </div>
            </div>
        </nav>

        <!-- Live Auction Tab -->
        <div id="auctionTab" class="tab-content p-6">
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Current Player & Bidding -->
                    <div>
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 mb-6">
                            <h2 class="text-2xl font-bold mb-4 text-yellow-400">Current Auction</h2>
                            <div id="currentPlayerCard" class="text-center">
                                <div class="text-gray-400">No player selected for auction</div>
                            </div>
                        </div>

                        <!-- Bidding Panel -->
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                            <h3 class="text-xl font-bold mb-4 text-yellow-400">Place Bid</h3>
                            <div id="biddingPanel" class="space-y-4">
                                <div class="text-gray-400 text-center">Select a player to start bidding</div>
                            </div>
                        </div>
                    </div>

                    <!-- Teams Overview -->
                    <div>
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                            <h3 class="text-xl font-bold mb-4 text-yellow-400">Teams Budget</h3>
                            <div id="teamsOverview" class="space-y-3">
                                <!-- Teams budget will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Player Queue -->
                <div class="mt-6 bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <h3 class="text-xl font-bold mb-4 text-yellow-400">Players Available for Auction</h3>
                    <div id="playerQueue" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Players will be populated here -->
                    </div>
                </div>

                <!-- All Teams Players -->
                <div class="mt-6 bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <h3 class="text-xl font-bold mb-4 text-yellow-400">All Teams Squad</h3>
                    <div id="allTeamsPlayers" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- All teams with their players will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Management Tab -->
        <div id="playersTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-yellow-400">Player Management</h2>
                    <button onclick="showAddPlayerModal()"
                        class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                        Add Player
                    </button>
                </div>

                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div id="playersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Players will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Dashboard Tab -->
        <div id="teamsTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6">Team Dashboard</h2>
                <div id="teamsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Teams will be populated here -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6">Auction Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4">Team Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Number of Teams</label>
                                <input type="number" id="numTeams" value="6" min="2" max="10"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Max Players per Team</label>
                                <input type="number" id="maxPlayers" value="15" min="10" max="25"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                            </div>
                            <button onclick="updateSettings()"
                                class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                Update Settings
                            </button>
                        </div>
                    </div>

                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4">Data Management</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Load Players JSON</label>
                                <input type="file" accept=".json" onchange="loadPlayersJSON(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-500 file:text-white hover:file:bg-green-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Load Teams JSON</label>
                                <input type="file" accept=".json" onchange="loadTeamsJSON(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Load Users JSON</label>
                                <input type="file" accept=".json" onchange="loadUsersJSON(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-500 file:text-white hover:file:bg-purple-600">
                            </div>
                            <button onclick="downloadSampleJSONs()"
                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg transition-colors">
                                Download Sample JSON Files
                            </button>
                        </div>
                    </div>

                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4">Auction Controls</h3>
                        <div class="space-y-4">
                            <button onclick="resetAuction()"
                                class="w-full bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                                Reset Auction
                            </button>
                            <button onclick="exportToJSON()"
                                class="w-full bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                Export Complete Data
                            </button>
                            <button onclick="manualSaveJSONFiles()"
                                class="w-full bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                Download Updated JSON Files
                            </button>
                            <div>
                                <label class="block text-sm font-medium mb-2">Import Complete Data</label>
                                <input type="file" accept=".json" onchange="importFromJSON(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Load Session Data</label>
                                <input type="file" accept=".json" onchange="loadSessionData(event)"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-500 file:text-white hover:file:bg-orange-600">
                                <p class="text-xs text-gray-400 mt-1">Load auction_session.json to restore exact auction
                                    state</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Player Modal -->
    <div id="addPlayerModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-md border border-white/20">
            <h3 class="text-xl font-bold mb-4 text-yellow-400">Add New Player</h3>
            <div class="space-y-4 max-h-96 overflow-y-auto">
                <input type="text" id="playerName" placeholder="Player Name"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <select id="playerRole"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="Batsman" class="bg-gray-800 text-white">Batsman</option>
                    <option value="Bowler" class="bg-gray-800 text-white">Bowler</option>
                    <option value="All-rounder" class="bg-gray-800 text-white">All-rounder</option>
                    <option value="Wicket-keeper" class="bg-gray-800 text-white">Wicket-keeper</option>
                </select>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="playerAge" placeholder="Age"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                    <input type="text" id="playerExperience" placeholder="Experience (e.g., 10 years)"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                </div>
                <select id="playerBattingStyle"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="" class="bg-gray-800 text-white">Select Batting Style</option>
                    <option value="Right-handed" class="bg-gray-800 text-white">Right-handed</option>
                    <option value="Left-handed" class="bg-gray-800 text-white">Left-handed</option>
                </select>
                <select id="playerBowlingStyle"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="" class="bg-gray-800 text-white">Select Bowling Style</option>
                    <option value="Right-arm fast" class="bg-gray-800 text-white">Right-arm fast</option>
                    <option value="Right-arm fast-medium" class="bg-gray-800 text-white">Right-arm fast-medium</option>
                    <option value="Right-arm medium" class="bg-gray-800 text-white">Right-arm medium</option>
                    <option value="Right-arm off-break" class="bg-gray-800 text-white">Right-arm off-break</option>
                    <option value="Right-arm leg-break" class="bg-gray-800 text-white">Right-arm leg-break</option>
                    <option value="Left-arm fast" class="bg-gray-800 text-white">Left-arm fast</option>
                    <option value="Left-arm fast-medium" class="bg-gray-800 text-white">Left-arm fast-medium</option>
                    <option value="Left-arm medium" class="bg-gray-800 text-white">Left-arm medium</option>
                    <option value="Left-arm orthodox" class="bg-gray-800 text-white">Left-arm orthodox</option>
                    <option value="Left-arm chinaman" class="bg-gray-800 text-white">Left-arm chinaman</option>
                </select>
                <div>
                    <label class="block text-sm font-medium mb-2">PCL Seasons Played</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2019" value="2019" class="mr-2"> 2019
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2020" value="2020" class="mr-2"> 2020
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2021" value="2021" class="mr-2"> 2021
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2022" value="2022" class="mr-2"> 2022
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2023" value="2023" class="mr-2"> 2023
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="season2024" value="2024" class="mr-2"> 2024
                        </label>
                    </div>
                </div>
                <input type="number" id="basePrice" placeholder="Base Price" value="5000"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <div>
                    <label class="block text-sm font-medium mb-2">Player Photo</label>
                    <input type="file" id="playerPhotoFile" accept="image/*"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-black hover:file:bg-yellow-600">
                    <p class="text-xs text-gray-400 mt-1">Or use emoji/text as photo</p>
                    <input type="text" id="playerPhoto" placeholder="Photo emoji or text (e.g., üèè)"
                        class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400 mt-2">
                </div>
                <div class="flex space-x-4">
                    <button onclick="addPlayer()"
                        class="flex-1 bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">Add</button>
                    <button onclick="closeAddPlayerModal()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-yellow-400 mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-yellow-400 mb-2">Processing...</h3>
            <p id="loadingMessage" class="text-gray-300">Please wait while we update the data</p>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentRole = null;
        let currentPlayerIndex = 0;
        let auctionActive = false;
        let currentBid = 0;
        let currentBidder = null;
        let isProcessing = false;

        // Loading functions
        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            isProcessing = true;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            isProcessing = false;
        }

        // Debounce function to prevent rapid clicks
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Data persistence functions
        function saveToLocalStorage() {
            const data = {
                teams: teams,
                players: players,
                currentPlayerIndex: currentPlayerIndex,
                auctionActive: auctionActive,
                currentBid: currentBid,
                currentBidder: currentBidder,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('auctionData', JSON.stringify(data));
        }

        // Update JSON files in project path (async for better performance)
        async function updateProjectJSONFiles() {
            return new Promise((resolve) => {
                // Use setTimeout to make it async and prevent UI blocking
                setTimeout(() => {
                    try {
                        // Prepare players.json (only available and unsold players)
                        const availablePlayers = players.filter(p => p.status === 'available' || p.status === 'unsold');
                        const playersData = availablePlayers.map(player => ({
                            id: player.id,
                            name: player.name,
                            role: player.role,
                            age: player.age,
                            nationality: player.nationality,
                            experience: player.experience,
                            battingStyle: player.battingStyle,
                            bowlingStyle: player.bowlingStyle,
                            pclSeasons: player.pclSeasons,
                            basePrice: player.basePrice,
                            photo: player.photo
                        }));

                        // Prepare teams.json (with sold players included)
                        const teamsData = teams.map(team => ({
                            id: team.id,
                            name: team.name,
                            budget: team.budget,
                            color: team.color,
                            owner: team.owner,
                            players: team.players.map(player => ({
                                id: player.id,
                                name: player.name,
                                role: player.role,
                                age: player.age,
                                nationality: player.nationality,
                                experience: player.experience,
                                battingStyle: player.battingStyle,
                                bowlingStyle: player.bowlingStyle,
                                pclSeasons: player.pclSeasons,
                                basePrice: player.basePrice,
                                soldPrice: player.soldPrice,
                                photo: player.photo
                            }))
                        }));

                        // Store in localStorage for persistence
                        localStorage.setItem('updatedPlayers', JSON.stringify(playersData));
                        localStorage.setItem('updatedTeams', JSON.stringify(teamsData));

                        // Log updated data to console for manual file updates (only in development)
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.log('=== UPDATED PLAYERS.JSON ===');
                            console.log(JSON.stringify(playersData, null, 2));
                            console.log('\n=== UPDATED TEAMS.JSON ===');
                            console.log(JSON.stringify(teamsData, null, 2));
                        }

                        resolve({ playersData, teamsData });
                    } catch (error) {
                        console.error('Error updating JSON files:', error);
                        resolve(null);
                    }
                }, 100); // Small delay to prevent UI blocking
            });
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('auctionData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    teams = data.teams || teams;
                    players = data.players || players;
                    currentPlayerIndex = data.currentPlayerIndex || 0;
                    auctionActive = data.auctionActive || false;
                    currentBid = data.currentBid || 0;
                    currentBidder = data.currentBidder || null;
                    console.log('Data loaded from localStorage');
                } catch (error) {
                    console.error('Error loading data from localStorage:', error);
                }
            }
        }

        function exportToJSON() {
            const data = {
                teams: teams,
                players: players,
                auctionState: {
                    currentPlayerIndex: currentPlayerIndex,
                    auctionActive: auctionActive,
                    currentBid: currentBid,
                    currentBidder: currentBidder
                },
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auction-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // JSON file loading functions
        function loadPlayersJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            players = data.map(player => ({
                                ...player,
                                currentBid: 0,
                                status: 'available',
                                soldTo: null
                            }));
                        } else if (data.players && Array.isArray(data.players)) {
                            players = data.players.map(player => ({
                                ...player,
                                currentBid: 0,
                                status: 'available',
                                soldTo: null
                            }));
                        }
                        saveToLocalStorage();
                        renderAll();
                        alert(`${players.length} players loaded successfully!`);
                    } catch (error) {
                        alert('Error loading players JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadTeamsJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            teams = data.map(team => ({
                                ...team,
                                players: team.players || []
                            }));
                        } else if (data.teams && Array.isArray(data.teams)) {
                            teams = data.teams.map(team => ({
                                ...team,
                                players: team.players || []
                            }));
                        }
                        saveToLocalStorage();
                        renderAll();
                        alert(`${teams.length} teams loaded successfully!`);
                    } catch (error) {
                        alert('Error loading teams JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadUsersJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            users = data;
                        } else if (data.users && Array.isArray(data.users)) {
                            users = data.users;
                        }
                        alert(`${users.length} users loaded successfully!`);
                    } catch (error) {
                        alert('Error loading users JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function downloadSampleJSONs() {
            // Sample Players JSON
            const samplePlayers = [
                {
                    "id": 1,
                    "name": "Virat Kohli",
                    "role": "Batsman",
                    "age": 35,
                    "nationality": "Indian",
                    "experience": "15 years",
                    "battingStyle": "Right-handed",
                    "bowlingStyle": "Right-arm medium",
                    "pclSeasons": ["2019", "2020", "2021", "2022", "2023"],
                    "basePrice": 15000,
                    "photo": "üèè"
                },
                {
                    "id": 2,
                    "name": "MS Dhoni",
                    "role": "Wicket-keeper",
                    "age": 42,
                    "nationality": "Indian",
                    "experience": "20 years",
                    "battingStyle": "Right-handed",
                    "bowlingStyle": "Right-arm medium",
                    "pclSeasons": ["2019", "2020", "2021", "2022"],
                    "basePrice": 15000,
                    "photo": "üß§"
                },
                {
                    "id": 3,
                    "name": "Jasprit Bumrah",
                    "role": "Bowler",
                    "age": 30,
                    "nationality": "Indian",
                    "experience": "8 years",
                    "battingStyle": "Right-handed",
                    "bowlingStyle": "Right-arm fast",
                    "pclSeasons": ["2020", "2021", "2022", "2023"],
                    "basePrice": 12000,
                    "photo": "‚ö°"
                }
            ];

            // Sample Teams JSON
            const sampleTeams = [
                {
                    "id": 1,
                    "name": "Mumbai Warriors",
                    "budget": 100000,
                    "color": "bg-blue-600",
                    "owner": "Owner 1",
                    "players": []
                },
                {
                    "id": 2,
                    "name": "Delhi Capitals",
                    "budget": 100000,
                    "color": "bg-red-600",
                    "owner": "Owner 2",
                    "players": []
                }
            ];

            // Sample Users JSON
            const sampleUsers = [
                {
                    "id": 1,
                    "username": "admin",
                    "password": "admin123",
                    "role": "admin",
                    "name": "Administrator"
                },
                {
                    "id": 2,
                    "username": "auctioneer",
                    "password": "auction123",
                    "role": "auctioneer",
                    "name": "Auctioneer"
                }
            ];

            // Download players.json
            downloadJSON(samplePlayers, 'players.json');

            // Download teams.json
            setTimeout(() => downloadJSON(sampleTeams, 'teams.json'), 500);

            // Download users.json
            setTimeout(() => downloadJSON(sampleUsers, 'users.json'), 1000);

            alert('Sample JSON files will be downloaded. Use these as templates for your data!');
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.teams) teams = data.teams;
                        if (data.players) players = data.players;
                        if (data.users) users = data.users;
                        if (data.auctionState) {
                            currentPlayerIndex = data.auctionState.currentPlayerIndex || 0;
                            auctionActive = data.auctionState.auctionActive || false;
                            currentBid = data.auctionState.currentBid || 0;
                            currentBidder = data.auctionState.currentBidder || null;
                        }
                        saveToLocalStorage();
                        renderAll();
                        alert('Complete data imported successfully!');
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadSessionData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const sessionData = JSON.parse(e.target.result);

                        // Restore teams with their players
                        if (sessionData.teams) {
                            teams = sessionData.teams.map(team => ({
                                ...team,
                                players: team.players || []
                            }));
                        }

                        // Restore available players
                        if (sessionData.availablePlayers) {
                            const availablePlayers = sessionData.availablePlayers.map(player => ({
                                ...player,
                                currentBid: 0,
                                status: 'available',
                                soldTo: null
                            }));

                            // Restore sold players
                            const soldPlayers = sessionData.soldPlayers ? sessionData.soldPlayers.map(player => ({
                                ...player,
                                currentBid: player.soldPrice,
                                status: 'sold'
                            })) : [];

                            players = [...availablePlayers, ...soldPlayers];
                        }

                        // Restore auction state
                        if (sessionData.auctionState) {
                            currentPlayerIndex = sessionData.auctionState.currentPlayerIndex || 0;
                            auctionActive = sessionData.auctionState.auctionActive || false;
                            currentBid = sessionData.auctionState.currentBid || 0;
                            currentBidder = sessionData.auctionState.currentBidder || null;
                        }

                        localStorage.setItem('auctionData', JSON.stringify({
                            teams: teams,
                            players: players,
                            currentPlayerIndex: currentPlayerIndex,
                            auctionActive: auctionActive,
                            currentBid: currentBid,
                            currentBidder: currentBidder,
                            timestamp: new Date().toISOString()
                        }));

                        renderAll();
                        alert(`Session restored successfully! 
                        Teams: ${teams.length}
                        Available Players: ${players.filter(p => p.status === 'available').length}
                        Sold Players: ${players.filter(p => p.status === 'sold').length}
                        Session Date: ${sessionData.timestamp ? new Date(sessionData.timestamp).toLocaleString() : 'Unknown'}`);
                    } catch (error) {
                        alert('Error loading session data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        const manualSaveJSONFiles = debounce(async function () {
            if (isProcessing) return;

            if (confirm('This will download updated JSON files with current auction state. Continue?')) {
                showLoading('Preparing JSON files for download...');

                try {
                    // Save players.json (only available and unsold players)
                    const availablePlayers = players.filter(p => p.status === 'available' || p.status === 'unsold');
                    const playersData = availablePlayers.map(player => ({
                        id: player.id,
                        name: player.name,
                        role: player.role,
                        battingStyle: player.battingStyle,
                        bowlingStyle: player.bowlingStyle,
                        pclSeasons: player.pclSeasons,
                        basePrice: player.basePrice,
                        photo: player.photo
                    }));

                    downloadJSON(playersData, 'players_updated.json');

                    // Save teams.json (with sold players included)
                    const teamsData = teams.map(team => ({
                        id: team.id,
                        name: team.name,
                        budget: team.budget,
                        color: team.color,
                        owner: team.owner,
                        players: team.players.map(player => ({
                            id: player.id,
                            name: player.name,
                            role: player.role,
                            battingStyle: player.battingStyle,
                            bowlingStyle: player.bowlingStyle,
                            pclSeasons: player.pclSeasons,
                            basePrice: player.basePrice,
                            soldPrice: player.soldPrice,
                            photo: player.photo
                        }))
                    }));

                    // Delay team file download to avoid browser blocking multiple downloads
                    setTimeout(() => {
                        downloadJSON(teamsData, 'teams_updated.json');
                    }, 1000);

                    // Save complete session data
                    setTimeout(() => {
                        const sessionData = {
                            teams: teamsData,
                            availablePlayers: playersData,
                            soldPlayers: players.filter(p => p.status === 'sold').map(player => ({
                                id: player.id,
                                name: player.name,
                                role: player.role,
                                soldTo: player.soldTo,
                                soldPrice: player.currentBid,
                                soldToTeam: teams.find(t => t.id === player.soldTo)?.name
                            })),
                            auctionState: {
                                currentPlayerIndex: currentPlayerIndex,
                                auctionActive: auctionActive,
                                currentBid: currentBid,
                                currentBidder: currentBidder
                            },
                            timestamp: new Date().toISOString()
                        };
                        downloadJSON(sessionData, 'auction_session.json');
                        hideLoading();

                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                        successMsg.textContent = 'JSON files downloaded successfully!';
                        document.body.appendChild(successMsg);

                        setTimeout(() => {
                            if (successMsg.parentNode) {
                                successMsg.parentNode.removeChild(successMsg);
                            }
                        }, 3000);
                    }, 2000);

                } catch (error) {
                    hideLoading();
                    console.error('Error downloading files:', error);
                    alert('Error occurred while preparing files. Please try again.');
                }
            }
        }, 1000);

        // Initialize empty data arrays
        let teams = [];
        let players = [];
        let users = [];
        let auctionSettings = {};

        // Default fallback data (used if JSON files are not loaded)
        const defaultTeams = [
            { id: 1, name: 'Mumbai Warriors', budget: 100000, players: [], color: 'bg-blue-600' },
            { id: 2, name: 'Delhi Capitals', budget: 100000, players: [], color: 'bg-red-600' },
            { id: 3, name: 'Chennai Kings', budget: 100000, players: [], color: 'bg-yellow-600' },
            { id: 4, name: 'Kolkata Knights', budget: 100000, players: [], color: 'bg-purple-600' },
            { id: 5, name: 'Bangalore Royals', budget: 100000, players: [], color: 'bg-green-600' },
            { id: 6, name: 'Hyderabad Titans', budget: 100000, players: [], color: 'bg-orange-600' }
        ];

        const defaultPlayers = [
            {
                id: 1, name: 'Virat Kohli', role: 'Batsman', basePrice: 15000, currentBid: 0, status: 'available', soldTo: null, photo: 'üèè',
                battingStyle: 'Right-handed', bowlingStyle: 'Right-arm medium', pclSeasons: ['2019', '2020', '2021', '2022', '2023'],
                age: 35, nationality: 'Indian', experience: '15 years'
            },
            {
                id: 2, name: 'Rohit Sharma', role: 'Batsman', basePrice: 15000, currentBid: 0, status: 'available', soldTo: null, photo: 'üèè',
                battingStyle: 'Right-handed', bowlingStyle: 'Right-arm off-break', pclSeasons: ['2019', '2020', '2021', '2022', '2023'],
                age: 37, nationality: 'Indian', experience: '17 years'
            }
        ];

        const defaultUsers = [
            { id: 1, username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator' },
            { id: 2, username: 'auctioneer', password: 'auction123', role: 'auctioneer', name: 'Auctioneer' }
        ];

        const defaultSettings = {
            maxTeams: 10,
            maxPlayersPerTeam: 15,
            defaultBudget: 100000,
            bidIncrement: 1000,
            auctionName: 'Persistent Cricket League 2025'
        };

        // Login functionality
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }

            // Check against loaded users or default users
            const allUsers = users.length > 0 ? users : defaultUsers;
            const user = allUsers.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user.username;
                currentRole = user.role;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userRole').textContent = user.name || user.role;

                showTab('auction');
                renderAll();
            } else {
                alert('Invalid credentials');
            }
        }

        function logout() {
            currentUser = null;
            currentRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('border-yellow-400'));

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-yellow-400');

            // Render content based on tab
            if (tabName === 'auction') renderAuction();
            if (tabName === 'players') renderPlayers();
            if (tabName === 'teams') renderTeams();
        }

        // Auction functionality
        function renderAuction() {
            const availablePlayers = players.filter(p => p.status === 'available');

            // Render current player
            if (availablePlayers.length > 0 && currentPlayerIndex < availablePlayers.length) {
                const currentPlayer = availablePlayers[currentPlayerIndex];
                document.getElementById('currentPlayerCard').innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-black rounded-xl p-6 mb-4">
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="text-6xl">
                                ${currentPlayer.photo && currentPlayer.photo.startsWith('data:') ?
                        `<img src="${currentPlayer.photo}" alt="${currentPlayer.name}" class="w-16 h-16 rounded-full object-cover">` :
                        (currentPlayer.photo || 'üë§')
                    }
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold">${currentPlayer.name}</h3>
                                <p class="text-lg">${currentPlayer.role}</p>
                                <p class="text-sm">Base Price: ‚Çπ${currentPlayer.basePrice.toLocaleString()}</p>
                                <div class="grid grid-cols-2 gap-2 mt-3 text-xs">
                                    <div><strong>Batting:</strong> ${currentPlayer.battingStyle || 'N/A'}</div>
                                    <div><strong>Bowling:</strong> ${currentPlayer.bowlingStyle || 'N/A'}</div>
                                    <div class="col-span-2"><strong>PCL Seasons:</strong> ${currentPlayer.pclSeasons ? currentPlayer.pclSeasons.join(', ') : 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-lg font-bold">Current Bid: ‚Çπ${currentPlayer.currentBid.toLocaleString()}</p>
                            ${currentBidder ? `<p class="text-sm">Leading: ${teams.find(t => t.id === currentBidder)?.name}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="startBidding()" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded-lg transition-colors">
                            Start Bidding
                        </button>
                        <button onclick="unsoldPlayer()" class="bg-red-500 hover:bg-red-600 px-6 py-2 rounded-lg transition-colors">
                            Unsold
                        </button>
                    </div>
                `;

                // Render bidding panel for admin
                if (auctionActive) {
                    document.getElementById('biddingPanel').innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Select Team</label>
                                <select id="biddingTeam" class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                                    <option value="" class="bg-gray-800 text-white">Select Team</option>
                                    ${teams.map(team => `
                                        <option value="${team.id}" class="bg-gray-800 text-white" ${team.budget < currentPlayer.basePrice ? 'disabled' : ''}>
                                            ${team.name} (‚Çπ${team.budget.toLocaleString()})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Current Bid Amount</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="bidAmount" value="${Math.max(currentPlayer.currentBid, currentPlayer.basePrice)}" 
                                           class="flex-1 px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white" step="1000" min="${currentPlayer.basePrice}">
                                    <button onclick="increaseBid()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors text-white font-bold">
                                        +‚Çπ1000
                                    </button>
                                </div>
                            </div>
                            <button onclick="soldToSelectedTeam()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-colors">
                                Sold to Selected Team
                            </button>
                        </div>
                    `;
                } else {
                    document.getElementById('biddingPanel').innerHTML = '<div class="text-gray-400 text-center">Start bidding to place bids</div>';
                }
            } else {
                document.getElementById('currentPlayerCard').innerHTML = '<div class="text-gray-400 text-center">Auction Complete!</div>';
                document.getElementById('biddingPanel').innerHTML = '<div class="text-gray-400 text-center">Auction Complete!</div>';
            }

            // Render teams overview
            renderTeamsOverview();

            // Render player queue
            renderPlayerQueue();

            // Render all teams players
            renderAllTeamsPlayers();
        }

        function renderTeamsOverview() {
            const teamsHtml = teams.map(team => {
                const totalBudget = 100000;
                const spent = totalBudget - team.budget;
                const spentPercentage = ((spent / totalBudget) * 100).toFixed(1);
                const remainingPercentage = ((team.budget / totalBudget) * 100).toFixed(1);

                return `
                <div class="p-3 bg-white/5 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center">
                            <div class="w-3 h-3 ${team.color} rounded-full mr-3"></div>
                            <span class="font-medium">${team.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold">‚Çπ${team.budget.toLocaleString()}</div>
                            <div class="text-xs text-gray-400">${team.players.length}/15 players</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-300">
                        <div class="flex justify-between">
                            <span>Spent: ‚Çπ${spent.toLocaleString()} (${spentPercentage}%)</span>
                            <span>Remaining: ${remainingPercentage}%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-1">
                            <div class="${team.color} h-2 rounded-full" style="width: ${spentPercentage}%"></div>
                        </div>
                    </div>
                </div>
            `}).join('');

            document.getElementById('teamsOverview').innerHTML = teamsHtml;
        }

        function renderPlayerQueue() {
            const availablePlayers = players.filter(p => p.status === 'available');
            const queueHtml = availablePlayers.map((player, index) => `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10 ${index === currentPlayerIndex ? 'ring-2 ring-yellow-400' : ''}">
                    <h4 class="font-bold">${player.name}</h4>
                    <p class="text-sm text-gray-300">${player.role}</p>
                    <p class="text-sm">‚Çπ${player.basePrice.toLocaleString()}</p>
                    <button onclick="setCurrentPlayer(${index})" class="mt-2 text-xs bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded">
                        Select
                    </button>
                </div>
            `).join('');

            document.getElementById('playerQueue').innerHTML = queueHtml;
        }

        function renderAllTeamsPlayers() {
            const teamsHtml = teams.map(team => `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="flex items-center mb-3">
                        <div class="w-3 h-3 ${team.color} rounded-full mr-3"></div>
                        <h4 class="font-bold">${team.name}</h4>
                    </div>
                    <div class="text-xs text-gray-400 mb-3">
                        Budget: ‚Çπ${team.budget.toLocaleString()} | Players: ${team.players.length}/15
                    </div>
                    <div class="space-y-2">
                        ${team.players.length > 0 ? team.players.map(player => `
                            <div class="flex justify-between text-sm bg-white/5 rounded p-2">
                                <span>${player.name} (${player.role})</span>
                                <span class="text-green-400">‚Çπ${player.soldPrice.toLocaleString()}</span>
                            </div>
                        `).join('') : '<p class="text-gray-400 text-sm">No players yet</p>'}
                    </div>
                </div>
            `).join('');

            document.getElementById('allTeamsPlayers').innerHTML = teamsHtml;
        }

        function startBidding() {
            auctionActive = true;
            const currentPlayer = players.filter(p => p.status === 'available')[currentPlayerIndex];
            currentPlayer.currentBid = currentPlayer.basePrice;
            currentBid = currentPlayer.basePrice;
            currentBidder = null;
            renderAuction();
        }

        function increaseBid() {
            const bidAmountInput = document.getElementById('bidAmount');
            const currentAmount = parseInt(bidAmountInput.value);
            const newAmount = currentAmount + 1000;
            bidAmountInput.value = newAmount;

            // Update current bid display
            const currentPlayer = players.filter(p => p.status === 'available')[currentPlayerIndex];
            currentPlayer.currentBid = newAmount;
            renderAuction();
        }

        const soldToSelectedTeam = debounce(async function () {
            if (isProcessing) return;

            const teamId = parseInt(document.getElementById('biddingTeam').value);
            const bidAmount = parseInt(document.getElementById('bidAmount').value);
            const currentPlayer = players.filter(p => p.status === 'available')[currentPlayerIndex];

            if (!teamId) {
                alert('Please select a team');
                return;
            }

            const selectedTeam = teams.find(t => t.id === teamId);

            if (bidAmount > selectedTeam.budget) {
                alert('Team has insufficient budget');
                return;
            }

            if (selectedTeam.players.length >= 15) {
                alert('Team is full (15 players maximum)');
                return;
            }

            // Show loading
            showLoading(`Selling ${currentPlayer.name} to ${selectedTeam.name}...`);

            try {
                // Sell player to selected team
                selectedTeam.budget -= bidAmount;
                selectedTeam.players.push({ ...currentPlayer, soldPrice: bidAmount });
                currentPlayer.status = 'sold';
                currentPlayer.soldTo = teamId;
                currentPlayer.currentBid = bidAmount;

                // Save to localStorage first (fast)
                saveToLocalStorage();

                // Update project JSON files (async)
                await updateProjectJSONFiles();

                // Move to next player and update UI
                nextPlayer();

                // Hide loading
                hideLoading();

                // Show success message briefly
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                successMsg.textContent = `${currentPlayer.name} sold to ${selectedTeam.name} for ‚Çπ${bidAmount.toLocaleString()}!`;
                document.body.appendChild(successMsg);

                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 3000);

            } catch (error) {
                hideLoading();
                console.error('Error selling player:', error);
                alert('Error occurred while selling player. Please try again.');
            }
        }, 500);



        const unsoldPlayer = debounce(async function (playerId = null) {
            if (isProcessing) return;

            if (playerId) {
                // Unsold from player management dashboard
                const player = players.find(p => p.id === playerId);
                if (player && player.status === 'sold') {
                    showLoading(`Making ${player.name} available for auction...`);

                    try {
                        // Find the team that bought this player
                        const team = teams.find(t => t.id === player.soldTo);
                        if (team) {
                            // Remove player from team and refund budget
                            team.players = team.players.filter(p => p.id !== playerId);
                            team.budget += player.currentBid;
                        }

                        // Reset player status
                        player.status = 'available';
                        player.soldTo = null;
                        player.currentBid = 0;

                        // Save to localStorage first (fast)
                        saveToLocalStorage();

                        // Update project JSON files (async)
                        await updateProjectJSONFiles();

                        // Update UI
                        renderAll();

                        hideLoading();

                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                        successMsg.textContent = `${player.name} is now available for auction again!`;
                        document.body.appendChild(successMsg);

                        setTimeout(() => {
                            if (successMsg.parentNode) {
                                successMsg.parentNode.removeChild(successMsg);
                            }
                        }, 3000);

                    } catch (error) {
                        hideLoading();
                        console.error('Error unselling player:', error);
                        alert('Error occurred while making player available. Please try again.');
                    }
                }
            } else {
                // Unsold from auction (current player)
                const currentPlayer = players.filter(p => p.status === 'available')[currentPlayerIndex];
                showLoading(`Marking ${currentPlayer.name} as unsold...`);

                try {
                    currentPlayer.status = 'unsold';
                    saveToLocalStorage();
                    await updateProjectJSONFiles();
                    nextPlayer();
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    console.error('Error marking player as unsold:', error);
                }
            }
        }, 300);

        function nextPlayer() {
            currentPlayerIndex++;
            auctionActive = false;
            currentBidder = null;
            renderAuctionOnly(); // Use optimized render
        }

        function setCurrentPlayer(index) {
            currentPlayerIndex = index;
            auctionActive = false;
            currentBidder = null;
            renderAuction();
        }

        // Player management
        function renderPlayers() {
            const playersHtml = players.map(player => `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold">${player.name}</h4>
                        <span class="text-xs px-2 py-1 rounded ${player.status === 'available' ? 'bg-green-500' :
                    player.status === 'sold' ? 'bg-blue-500' : 'bg-red-500'
                }">${player.status}</span>
                    </div>
                    <p class="text-sm text-gray-300">${player.role}</p>
                    <p class="text-sm">Base: ‚Çπ${player.basePrice.toLocaleString()}</p>
                    ${player.status === 'sold' ? `
                        <p class="text-sm text-green-400">Sold: ‚Çπ${player.currentBid.toLocaleString()}</p>
                        <p class="text-xs text-gray-400">To: ${teams.find(t => t.id === player.soldTo)?.name}</p>
                        <div class="flex space-x-2 mt-2">
                            <button onclick="unsoldPlayer(${player.id})" class="text-xs bg-orange-500 hover:bg-orange-600 px-2 py-1 rounded">
                                Unsold
                            </button>
                            <button onclick="removePlayer(${player.id})" class="text-xs bg-red-500 hover:bg-red-600 px-2 py-1 rounded">
                                Remove
                            </button>
                        </div>
                    ` : `
                        <button onclick="removePlayer(${player.id})" class="mt-2 text-xs bg-red-500 hover:bg-red-600 px-2 py-1 rounded">
                            Remove
                        </button>
                    `}
                </div>
            `).join('');

            document.getElementById('playersGrid').innerHTML = playersHtml;
        }

        function showAddPlayerModal() {
            document.getElementById('addPlayerModal').classList.remove('hidden');
        }

        function closeAddPlayerModal() {
            document.getElementById('addPlayerModal').classList.add('hidden');
            document.getElementById('playerName').value = '';
            document.getElementById('playerAge').value = '';
            document.getElementById('playerExperience').value = '';
            document.getElementById('playerBattingStyle').value = '';
            document.getElementById('playerBowlingStyle').value = '';
            document.getElementById('basePrice').value = '5000';
            document.getElementById('playerPhoto').value = '';
            document.getElementById('playerPhotoFile').value = '';

            // Clear checkboxes
            ['2019', '2020', '2021', '2022', '2023', '2024'].forEach(year => {
                document.getElementById(`season${year}`).checked = false;
            });
        }

        const addPlayer = debounce(async function () {
            if (isProcessing) return;

            const name = document.getElementById('playerName').value;
            const role = document.getElementById('playerRole').value;
            const battingStyle = document.getElementById('playerBattingStyle').value;
            const bowlingStyle = document.getElementById('playerBowlingStyle').value;
            const basePrice = parseInt(document.getElementById('basePrice').value);
            const photoFile = document.getElementById('playerPhotoFile').files[0];
            const photoText = document.getElementById('playerPhoto').value;

            // Get selected PCL seasons
            const pclSeasons = [];
            ['2019', '2020', '2021', '2022', '2023', '2024'].forEach(year => {
                if (document.getElementById(`season${year}`).checked) {
                    pclSeasons.push(year);
                }
            });

            if (!name || !basePrice) {
                alert('Please fill required fields (Name and Base Price)');
                return;
            }

            showLoading(`Adding ${name} to player list...`);

            try {
                // Handle photo upload
                let photo = photoText || 'üë§';
                if (photoFile) {
                    const reader = new FileReader();
                    reader.onload = async function (e) {
                        const newPlayer = {
                            id: Date.now(),
                            name,
                            role,
                            battingStyle: battingStyle || null,
                            bowlingStyle: bowlingStyle || null,
                            pclSeasons: pclSeasons,
                            basePrice,
                            currentBid: 0,
                            status: 'available',
                            soldTo: null,
                            photo: e.target.result
                        };

                        players.push(newPlayer);
                        saveToLocalStorage();
                        await updateProjectJSONFiles();
                        closeAddPlayerModal();
                        renderPlayers();
                        hideLoading();

                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                        successMsg.textContent = `${name} added successfully!`;
                        document.body.appendChild(successMsg);

                        setTimeout(() => {
                            if (successMsg.parentNode) {
                                successMsg.parentNode.removeChild(successMsg);
                            }
                        }, 3000);
                    };
                    reader.readAsDataURL(photoFile);
                } else {
                    const newPlayer = {
                        id: Date.now(),
                        name,
                        role,
                        battingStyle: battingStyle || null,
                        bowlingStyle: bowlingStyle || null,
                        pclSeasons: pclSeasons,
                        basePrice,
                        currentBid: 0,
                        status: 'available',
                        soldTo: null,
                        photo
                    };

                    players.push(newPlayer);
                    saveToLocalStorage();
                    await updateProjectJSONFiles();
                    closeAddPlayerModal();
                    renderPlayers();
                    hideLoading();

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    successMsg.textContent = `${name} added successfully!`;
                    document.body.appendChild(successMsg);

                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 3000);
                }
            } catch (error) {
                hideLoading();
                console.error('Error adding player:', error);
                alert('Error occurred while adding player. Please try again.');
            }
        }, 500);

        function removePlayer(playerId) {
            players = players.filter(p => p.id !== playerId);
            renderPlayers();
        }

        // Team dashboard
        function renderTeams() {
            const teamsHtml = teams.map(team => `
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div class="flex items-center mb-4">
                        <div class="w-4 h-4 ${team.color} rounded-full mr-3"></div>
                        <h3 class="text-xl font-bold">${team.name}</h3>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-300">Budget Remaining: ‚Çπ${team.budget.toLocaleString()}</p>
                        <p class="text-sm text-gray-300">Players: ${team.players.length}/15</p>
                        <p class="text-sm text-gray-300">Total Spent: ‚Çπ${team.players.reduce((sum, p) => sum + (p.soldPrice || 0), 0).toLocaleString()}</p>
                    </div>
                    
                    <div class="space-y-2">
                        <h4 class="font-medium text-yellow-400">Squad:</h4>
                        ${team.players.length > 0 ? team.players.map(player => `
                            <div class="flex justify-between text-sm bg-white/5 rounded p-2">
                                <span>${player.name} (${player.role})</span>
                                <span class="text-green-400">‚Çπ${player.soldPrice.toLocaleString()}</span>
                            </div>
                        `).join('') : '<p class="text-gray-400 text-sm">No players yet</p>'}
                    </div>
                </div>
            `).join('');

            document.getElementById('teamsGrid').innerHTML = teamsHtml;
        }

        // Settings
        function updateSettings() {
            const numTeams = parseInt(document.getElementById('numTeams').value);
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);

            // Update teams array (simplified - in real app would need more logic)
            while (teams.length < numTeams) {
                teams.push({
                    id: teams.length + 1,
                    name: `Team ${teams.length + 1}`,
                    owner: `owner${teams.length + 1}`,
                    budget: 8000000,
                    players: [],
                    color: 'bg-gray-600'
                });
            }

            if (teams.length > numTeams) {
                teams = teams.slice(0, numTeams);
            }

            alert('Settings updated successfully!');
            renderAll();
        }

        function resetAuction() {
            if (confirm('Are you sure you want to reset the auction? This will clear all bids and team assignments.')) {
                players.forEach(player => {
                    player.status = 'available';
                    player.currentBid = 0;
                    player.soldTo = null;
                });

                teams.forEach(team => {
                    team.players = [];
                    team.budget = 100000;
                });

                currentPlayerIndex = 0;
                auctionActive = false;
                currentBidder = null;

                alert('Auction reset successfully!');
                renderAll();
            }
        }

        function exportData() {
            const data = {
                teams: teams,
                players: players,
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'auction-results.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Optimized render functions with async processing
        function renderAll() {
            // Use requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                renderAuction();
                requestAnimationFrame(() => {
                    renderPlayers();
                    requestAnimationFrame(() => {
                        renderTeams();
                    });
                });
            });
        }

        // Optimized render with selective updates
        function renderAuctionOnly() {
            requestAnimationFrame(() => {
                renderAuction();
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            // Load saved data on startup
            loadFromLocalStorage();

            // If no data loaded, use defaults
            if (teams.length === 0) {
                teams = [...defaultTeams];
            }
            if (players.length === 0) {
                players = [...defaultPlayers];
            }
            if (users.length === 0) {
                users = [...defaultUsers];
            }

            // Set default login for demo
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
        });
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9737f6eb363b2e2e',t:'MTc1NTkyNDM2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>