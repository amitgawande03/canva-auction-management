<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Cricket 2025 - Auction App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .pulse-bid {
            animation: pulseBid 1s infinite;
        }

        @keyframes pulseBid {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen text-white">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md border border-white/20">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-yellow-400 mb-2">üèè Persistent Cricket 2025</h1>
                <p class="text-gray-300">Auction Management System</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="username"
                        class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        placeholder="Enter username" value="admin">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="password"
                        class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        placeholder="Enter password" value="admin123">
                </div>

                <button onclick="login()"
                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 rounded-lg transition-colors">
                    Login as Admin
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-black/30 backdrop-blur-lg border-b border-white/20 p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-yellow-400">üèè PCL 2025 Auction</h1>
                    <span id="userRole"
                        class="px-3 py-1 bg-yellow-500 text-black rounded-full text-sm font-medium"></span>
                    <div id="syncStatus" class="text-xs text-blue-400 bg-blue-500/20 px-3 py-1 rounded-full">
                        üìÅ Server File Storage Active
                    </div>
                    <div id="connectionStatus" class="text-xs px-3 py-1 rounded-full">
                        üîÑ Checking connection...
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="logout()"
                        class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-black/20 backdrop-blur-lg border-b border-white/10">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-8">
                    <button onclick="showTab('auction')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="auction">Live Auction</button>
                    <button onclick="showTab('players')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="players">Player Management</button>
                    <button onclick="showTab('teams')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="teams">Team Dashboard</button>
                    <button onclick="showTab('settings')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="settings">Settings</button>
                    <button onclick="showTab('viewer')"
                        class="tab-btn py-4 px-6 border-b-2 border-transparent hover:border-yellow-400 transition-colors"
                        data-tab="viewer">Viewer Page</button>
                </div>
            </div>
        </nav>

        <!-- Live Auction Tab -->
        <div id="auctionTab" class="tab-content p-6">
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Current Player & Bidding -->
                    <div>
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 mb-6">
                            <h2 class="text-2xl font-bold mb-4 text-yellow-400">Current Auction</h2>
                            <div id="currentPlayerCard" class="text-center">
                                <div class="text-gray-400">No player selected for auction</div>
                            </div>
                        </div>

                        <!-- Bidding Panel -->
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                            <h3 class="text-xl font-bold mb-4 text-yellow-400">Place Bid</h3>
                            <div id="biddingPanel" class="space-y-4">
                                <div class="text-gray-400 text-center">Select a player to start bidding</div>
                            </div>
                        </div>
                    </div>

                    <!-- Teams Overview -->
                    <div>
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                            <h3 class="text-xl font-bold mb-4 text-yellow-400">Teams Budget</h3>
                            <div id="teamsOverview" class="space-y-3">
                                <!-- Teams budget will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Player Queue -->
                <div class="mt-6 bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-yellow-400">Players Available for Auction</h3>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <input type="text" id="playerSearch" placeholder="Search players..."
                                    class="px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400 w-64"
                                    oninput="filterPlayers()">
                                <div class="absolute right-3 top-2.5 text-gray-400">üîç</div>
                            </div>
                            <select id="roleFilter" onchange="filterPlayers()"
                                class="px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                                <option value="" class="bg-gray-800 text-white">All Roles</option>
                                <option value="Batsman" class="bg-gray-800 text-white">Batsman</option>
                                <option value="Bowler" class="bg-gray-800 text-white">Bowler</option>
                                <option value="All-rounder" class="bg-gray-800 text-white">All-rounder</option>
                                <option value="Wicket-keeper" class="bg-gray-800 text-white">Wicket-keeper</option>
                            </select>
                            <button onclick="clearFilters()"
                                class="px-3 py-2 bg-gray-500 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                                Clear
                            </button>
                        </div>
                    </div>
                    <div id="playerSearchResults" class="text-sm text-gray-400 mb-2 hidden"></div>
                    <div id="playerQueue" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Players will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Management Tab -->
        <div id="playersTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-yellow-400">Player Management</h2>
                    <button onclick="showAddPlayerModal()"
                        class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                        Add Player
                    </button>
                </div>

                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div id="playersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Players will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Dashboard Tab -->
        <div id="teamsTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6">Team Dashboard</h2>
                <div id="teamsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Teams will be populated here -->
                </div>
            </div>
        </div>

        <!-- Viewer Page Tab -->
        <div id="viewerTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6">üì∫ Viewer Page Configuration</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Viewer URL Configuration -->
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4 text-yellow-400">üîó Viewer Page URL</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Viewer Page URL</label>
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="viewerPageUrl" readonly
                                        class="flex-1 px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white"
                                        value="">
                                    <button onclick="copyViewerUrl()"
                                        class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                        üìã Copy
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Share this URL with viewers to see live auction
                                    data</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="generateViewerUrl()"
                                    class="flex-1 bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                    üîÑ Generate URL
                                </button>
                                <button onclick="openViewerPage()"
                                    class="flex-1 bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg transition-colors">
                                    üöÄ Open Viewer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Viewer Settings -->
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4 text-yellow-400">‚öôÔ∏è Viewer Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="autoRefreshViewer" checked class="rounded">
                                    <span class="text-sm">Auto-refresh viewer data (every 3 seconds)</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="showCurrentAuction" checked class="rounded">
                                    <span class="text-sm">Show current auction player</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="showTeamBudgets" checked class="rounded">
                                    <span class="text-sm">Show team budgets</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="showPlayerPhotos" checked class="rounded">
                                    <span class="text-sm">Show player photos</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Refresh Interval (seconds)</label>
                                <select id="refreshInterval"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                                    <option value="1" class="bg-gray-800 text-white">1 second</option>
                                    <option value="3" selected class="bg-gray-800 text-white">3 seconds</option>
                                    <option value="5" class="bg-gray-800 text-white">5 seconds</option>
                                    <option value="10" class="bg-gray-800 text-white">10 seconds</option>
                                </select>
                            </div>
                            <button onclick="saveViewerSettings()"
                                class="w-full bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                üíæ Save Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Live Viewer Preview -->
                <div class="mt-6 bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-yellow-400">üëÅÔ∏è Live Viewer Preview</h3>
                        <div class="flex items-center space-x-2">
                            <div id="viewerStatus"
                                class="text-xs px-3 py-1 rounded-full bg-green-500/20 text-green-400">
                                üü¢ Live
                            </div>
                            <button onclick="refreshViewerPreview()"
                                class="bg-gray-500 hover:bg-gray-600 px-3 py-1 rounded text-sm transition-colors">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    <div id="viewerPreview" class="border border-white/20 rounded-lg p-4 bg-black/20 min-h-96">
                        <!-- Viewer preview will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content hidden p-6">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6">Auction Settings & File Paths</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- File Path Configuration -->
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4 text-yellow-400">üìÅ Server File Paths</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Players JSON Path</label>
                                <input type="text" id="playersFilePath" value="./data/players.json"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white"
                                    placeholder="e.g., ./data/players.json or C:/auction/players.json">
                                <p class="text-xs text-gray-400 mt-1">Relative or absolute path to players.json file</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Teams JSON Path</label>
                                <input type="text" id="teamsFilePath" value="./data/teams.json"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white"
                                    placeholder="e.g., ./data/teams.json or C:/auction/teams.json">
                                <p class="text-xs text-gray-400 mt-1">Relative or absolute path to teams.json file</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Session Data Path</label>
                                <input type="text" id="sessionFilePath" value="./data/auction_session.json"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white"
                                    placeholder="e.g., ./data/auction_session.json">
                                <p class="text-xs text-gray-400 mt-1">Path for live auction session data</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="saveFilePaths()"
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                    Save Paths
                                </button>
                                <button onclick="testFilePaths()"
                                    class="flex-1 bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                    Test Connection
                                </button>
                            </div>
                            <div id="filePathStatus" class="text-sm p-3 rounded-lg hidden">
                                <!-- Status messages will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4 text-yellow-400">üì§ Upload JSON Files</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Upload Players JSON</label>
                                <input type="file" id="playersFileUpload" accept=".json"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-black hover:file:bg-yellow-600">
                                <p class="text-xs text-gray-400 mt-1">Upload players.json to override current data</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Upload Teams JSON</label>
                                <input type="file" id="teamsFileUpload" accept=".json"
                                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-black hover:file:bg-yellow-600">
                                <p class="text-xs text-gray-400 mt-1">Upload teams.json to override current data</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="uploadFiles()"
                                    class="flex-1 bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg transition-colors">
                                    üì§ Upload & Override
                                </button>
                                <button onclick="downloadCurrentData()"
                                    class="flex-1 bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded-lg transition-colors">
                                    üì• Download JSON
                                </button>
                            </div>
                            <div class="flex space-x-2 mt-2">
                                <button onclick="downloadExcelReport()"
                                    class="flex-1 bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                    üìä Download Excel Report
                                </button>
                                <button onclick="downloadTeamWiseExcel()"
                                    class="flex-1 bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg transition-colors">
                                    üìã Team-wise Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- File Operations -->
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                        <h3 class="text-xl font-bold mb-4">üìÇ File Operations</h3>
                        <div class="space-y-4">
                            <button onclick="loadFromServerFiles()"
                                class="w-full bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">
                                üîÑ Load from Server Files
                            </button>
                            <button onclick="saveToServerFiles()"
                                class="w-full bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">
                                üíæ Save to Server Files
                            </button>
                            <button onclick="createBackupFiles()"
                                class="w-full bg-orange-500 hover:bg-orange-600 px-4 py-2 rounded-lg transition-colors">
                                üìã Create Backup Files
                            </button>
                            <button onclick="resetAuction()"
                                class="w-full bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                                üîÑ Reset Auction
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Player Modal -->
    <div id="addPlayerModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-md border border-white/20">
            <h3 class="text-xl font-bold mb-4 text-yellow-400">Add New Player</h3>
            <div class="space-y-4 max-h-96 overflow-y-auto">
                <input type="text" id="playerName" placeholder="Player Name"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <select id="playerRole"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="Batsman" class="bg-gray-800 text-white">Batsman</option>
                    <option value="Bowler" class="bg-gray-800 text-white">Bowler</option>
                    <option value="All-rounder" class="bg-gray-800 text-white">All-rounder</option>
                    <option value="Wicket-keeper" class="bg-gray-800 text-white">Wicket-keeper</option>
                </select>
                <input type="number" id="playerRuns" placeholder="Runs" value="0"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <input type="number" id="playerWickets" placeholder="Wickets" value="0"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <input type="text" id="pclSeasons" placeholder="PCL Seasons (e.g., 6,7)"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <input type="number" id="basePrice" placeholder="Base Price" value="500"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <input type="text" id="playerPhoto" placeholder="Photo path (e.g., photos/player.jpg)"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <select id="battingStyle"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="Right-handed" class="bg-gray-800 text-white">Right-handed</option>
                    <option value="Left-handed" class="bg-gray-800 text-white">Left-handed</option>
                </select>
                <div class="flex space-x-4">
                    <button onclick="addPlayer()"
                        class="flex-1 bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors">Add</button>
                    <button onclick="closeAddPlayerModal()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Player Modal -->
    <div id="editPlayerModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-md border border-white/20">
            <h3 class="text-xl font-bold mb-4 text-yellow-400">Edit Player Details</h3>
            <div class="space-y-4 max-h-96 overflow-y-auto">
                <input type="hidden" id="editPlayerId">
                <input type="text" id="editPlayerName" placeholder="Player Name"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <select id="editPlayerRole"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="Batsman" class="bg-gray-800 text-white">Batsman</option>
                    <option value="Bowler" class="bg-gray-800 text-white">Bowler</option>
                    <option value="All-rounder" class="bg-gray-800 text-white">All-rounder</option>
                    <option value="Wicket-keeper" class="bg-gray-800 text-white">Wicket-keeper</option>
                </select>
                <input type="number" id="editPlayerRuns" placeholder="Runs"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <input type="number" id="editPlayerWickets" placeholder="Wickets"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <input type="text" id="editPclSeasons" placeholder="PCL Seasons (e.g., 6,7)"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <input type="number" id="editBasePrice" placeholder="Base Price"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <input type="text" id="editPlayerPhoto" placeholder="Photo path (e.g., photos/player.jpg)"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white placeholder-gray-400">
                <select id="editBattingStyle"
                    class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                    <option value="Right-handed" class="bg-gray-800 text-white">Right-handed</option>
                    <option value="Left-handed" class="bg-gray-800 text-white">Left-handed</option>
                </select>
                <div id="editPlayerStatus" class="p-3 bg-white/5 rounded-lg">
                    <!-- Player status info will be shown here -->
                </div>
                <div class="flex space-x-4">
                    <button onclick="updatePlayer()"
                        class="flex-1 bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors">Update</button>
                    <button onclick="closeEditPlayerModal()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-yellow-400 mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-yellow-400 mb-2">Processing...</h3>
            <p id="loadingMessage" class="text-gray-300">Please wait while we update the data</p>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentRole = null;
        let currentPlayerIndex = 0;
        let auctionActive = false;
        let currentBid = 0;
        let currentBidder = null;
        let isProcessing = false;
        let playerOrder = []; // Randomized order of player indices
        let isFirstAuction = true; // Track if this is the first auction start

        // Viewer configuration
        let viewerConfig = {
            autoRefresh: true,
            showCurrentAuction: true,
            showTeamBudgets: true,
            showPlayerPhotos: true,
            refreshInterval: 3,
            viewerUrl: ''
        };

        let viewerRefreshTimer = null;

        // File system configuration
        let fileConfig = {
            playersPath: './data/players.json',
            teamsPath: './data/teams.json',
            sessionPath: './data/auction_session.json',
            syncInterval: 2000,
            autoSyncEnabled: true,
            backupEnabled: true
        };

        // Auto-sync timer
        let syncTimer = null;

        // Initialize empty data arrays
        let teams = [];
        let players = [];

        // Default fallback data
        const defaultTeams = [
            { id: 1, name: 'Mumbai Warriors', budget: 75000, players: [], color: 'bg-blue-600' },
            { id: 2, name: 'Delhi Capitals', budget: 75000, players: [], color: 'bg-red-600' },
            { id: 3, name: 'Chennai Kings', budget: 75000, players: [], color: 'bg-yellow-600' },
            { id: 4, name: 'Kolkata Knights', budget: 75000, players: [], color: 'bg-purple-600' },
            { id: 5, name: 'Bangalore Royals', budget: 75000, players: [], color: 'bg-green-600' },
            { id: 6, name: 'Hyderabad Titans', budget: 75000, players: [], color: 'bg-orange-600' }
        ];

        const defaultPlayers = [

        ];

        // Server file system simulation with localStorage persistence
        class ServerFileSystem {
            constructor() {
                this.files = new Map();
                this.loadFromLocalStorage();
                this.initializeDefaultFiles();
            }

            loadFromLocalStorage() {
                try {
                    const savedFiles = localStorage.getItem('serverFiles');
                    if (savedFiles) {
                        const filesData = JSON.parse(savedFiles);
                        this.files = new Map(Object.entries(filesData));
                    }
                } catch (error) {
                    console.warn('Could not load files from localStorage:', error);
                }
            }

            saveToLocalStorage() {
                try {
                    const filesData = Object.fromEntries(this.files);
                    localStorage.setItem('serverFiles', JSON.stringify(filesData));
                } catch (error) {
                    console.warn('Could not save files to localStorage:', error);
                }
            }

            initializeDefaultFiles() {
                // Only initialize if files don't exist
                if (!this.files.has(fileConfig.playersPath)) {
                    this.files.set(fileConfig.playersPath, JSON.stringify(defaultPlayers, null, 2));
                }
                if (!this.files.has(fileConfig.teamsPath)) {
                    this.files.set(fileConfig.teamsPath, JSON.stringify(defaultTeams, null, 2));
                }
                if (!this.files.has(fileConfig.sessionPath)) {
                    this.files.set(fileConfig.sessionPath, JSON.stringify({
                        currentPlayerIndex: 0,
                        auctionActive: false,
                        currentBid: 0,
                        currentBidder: null,
                        timestamp: new Date().toISOString()
                    }, null, 2));
                }
                this.saveToLocalStorage();
            }

            async readFile(filePath) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (this.files.has(filePath)) {
                            resolve(this.files.get(filePath));
                        } else {
                            // Try to find file with similar name or create default
                            const fileName = filePath.split('/').pop();
                            if (fileName === 'players.json') {
                                const defaultContent = JSON.stringify(defaultPlayers, null, 2);
                                this.files.set(filePath, defaultContent);
                                this.saveToLocalStorage();
                                resolve(defaultContent);
                            } else if (fileName === 'teams.json') {
                                const defaultContent = JSON.stringify(defaultTeams, null, 2);
                                this.files.set(filePath, defaultContent);
                                this.saveToLocalStorage();
                                resolve(defaultContent);
                            } else {
                                reject(new Error(`File not found: ${filePath}`));
                            }
                        }
                    }, 100);
                });
            }

            async writeFile(filePath, content) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        try {
                            if (fileConfig.backupEnabled && this.files.has(filePath)) {
                                const backupPath = filePath.replace(/\.json$/, '.bak');
                                this.files.set(backupPath, this.files.get(filePath));
                            }

                            this.files.set(filePath, content);
                            this.saveToLocalStorage();
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    }, 150);
                });
            }

            listFiles() {
                return Array.from(this.files.keys());
            }

            // Method to override files with uploaded content
            async overrideFile(filePath, content) {
                return this.writeFile(filePath, content);
            }
        }

        const serverFS = new ServerFileSystem();

        // Utility functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function initializePlayerOrder() {
            const availablePlayers = players.filter(p => p.status === 'available');
            if (availablePlayers.length === 0) return;

            // Create array of player IDs and shuffle them
            const playerIds = availablePlayers.map(p => p.id);
            playerOrder = shuffleArray(playerIds);
            currentPlayerIndex = 0; // Reset to start of shuffled order
            isFirstAuction = false;

            console.log('Player order randomized:', playerOrder);
            const firstPlayer = players.find(p => p.id === playerOrder[0]);
            showStatusMessage(`Player order randomized! Starting with ${firstPlayer ? firstPlayer.name : 'Unknown Player'}`, 'success');
        }

        function getCurrentPlayer() {
            if (playerOrder.length === 0 || currentPlayerIndex >= playerOrder.length) return null;

            // Get player by ID from the randomized order
            const currentPlayerId = playerOrder[currentPlayerIndex];
            const currentPlayer = players.find(p => p.id === currentPlayerId);

            // If player is not found or no longer available, skip to next available player
            if (!currentPlayer || currentPlayer.status !== 'available') {
                // Remove this player ID from the order
                playerOrder = playerOrder.filter(id => id !== currentPlayerId);

                // Don't increment index since we removed current player
                if (currentPlayerIndex >= playerOrder.length) {
                    // Check if there are still available players for a new round
                    const availablePlayers = players.filter(p => p.status === 'available');
                    if (availablePlayers.length > 0) {
                        initializePlayerOrder();
                        return getCurrentPlayer();
                    } else {
                        return null; // No more players available
                    }
                }

                // Try next player in the order
                return getCurrentPlayer();
            }

            return currentPlayer;
        }

        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            isProcessing = true;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            isProcessing = false;
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `text-xs px-3 py-1 rounded-full ${status === 'connected' ? 'text-green-400 bg-green-500/20' :
                status === 'error' ? 'text-red-400 bg-red-500/20' :
                    'text-yellow-400 bg-yellow-500/20'
                }`;
            statusEl.textContent = message;
        }

        function showStatusMessage(message, type) {
            const statusEl = document.getElementById('filePathStatus');
            if (statusEl) {
                statusEl.className = `text-sm p-3 rounded-lg ${type === 'success' ? 'bg-green-500/20 text-green-300' :
                    type === 'error' ? 'bg-red-500/20 text-red-300' :
                        'bg-blue-500/20 text-blue-300'
                    }`;
                statusEl.textContent = message;
                statusEl.classList.remove('hidden');

                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        // File operations
        function saveFilePaths() {
            fileConfig.playersPath = document.getElementById('playersFilePath').value;
            fileConfig.teamsPath = document.getElementById('teamsFilePath').value;
            fileConfig.sessionPath = document.getElementById('sessionFilePath').value;

            localStorage.setItem('fileConfig', JSON.stringify(fileConfig));
            showStatusMessage('File paths saved successfully!', 'success');
            serverFS.initializeDefaultFiles();
        }

        function loadFilePaths() {
            const saved = localStorage.getItem('fileConfig');
            if (saved) {
                fileConfig = { ...fileConfig, ...JSON.parse(saved) };
                document.getElementById('playersFilePath').value = fileConfig.playersPath;
                document.getElementById('teamsFilePath').value = fileConfig.teamsPath;
                document.getElementById('sessionFilePath').value = fileConfig.sessionPath;
            }
        }

        async function testFilePaths() {
            showLoading('Testing file connections...');

            try {
                const results = [];

                try {
                    await serverFS.readFile(fileConfig.playersPath);
                    results.push(`‚úÖ Players file: ${fileConfig.playersPath}`);
                } catch (error) {
                    results.push(`‚ùå Players file: ${fileConfig.playersPath} - ${error.message}`);
                }

                try {
                    await serverFS.readFile(fileConfig.teamsPath);
                    results.push(`‚úÖ Teams file: ${fileConfig.teamsPath}`);
                } catch (error) {
                    results.push(`‚ùå Teams file: ${fileConfig.teamsPath} - ${error.message}`);
                }

                try {
                    await serverFS.readFile(fileConfig.sessionPath);
                    results.push(`‚úÖ Session file: ${fileConfig.sessionPath}`);
                } catch (error) {
                    results.push(`‚ùå Session file: ${fileConfig.sessionPath} - ${error.message}`);
                }

                hideLoading();

                const statusEl = document.getElementById('filePathStatus');
                statusEl.className = 'text-sm p-3 rounded-lg bg-blue-500/20 text-blue-300';
                statusEl.innerHTML = `
                    <h4 class="font-bold mb-2">Connection Test Results:</h4>
                    ${results.map(result => `<div>${result}</div>`).join('')}
                    <div class="mt-2 text-xs">Available files: ${serverFS.listFiles().length}</div>
                `;
                statusEl.classList.remove('hidden');

                updateConnectionStatus('connected', 'üìÅ Server files accessible');

            } catch (error) {
                hideLoading();
                showStatusMessage(`Connection test failed: ${error.message}`, 'error');
                updateConnectionStatus('error', '‚ùå Connection failed');
            }
        }

        async function loadFromServerFiles() {
            const isViewerMode = window.location.search.includes('mode=viewer');

            if (!isViewerMode) {
                showLoading('Loading data from server files...');
            }

            try {
                // Load session data first to get current auction state
                try {
                    const sessionData = await serverFS.readFile(fileConfig.sessionPath);
                    const parsedSession = JSON.parse(sessionData);

                    if (parsedSession.auctionState) {
                        currentPlayerIndex = parsedSession.auctionState.currentPlayerIndex || 0;
                        auctionActive = parsedSession.auctionState.auctionActive || false;
                        currentBid = parsedSession.auctionState.currentBid || 0;
                        currentBidder = parsedSession.auctionState.currentBidder || null;
                    }

                    // Use session data if available and recent
                    if (parsedSession.teams && parsedSession.availablePlayers) {
                        teams = parsedSession.teams.map(team => ({
                            ...team,
                            players: team.players || []
                        }));

                        // Reconstruct players array from session data
                        const availablePlayers = parsedSession.availablePlayers.map(player => ({
                            ...player,
                            runs: player.runs || 0,
                            wickets: player.wickets || 0,
                            pclSeasons: player.pclSeasons || [],
                            battingStyle: player.battingStyle || 'Right-handed',
                            currentBid: player.currentBid || 0,
                            status: 'available',
                            soldTo: null
                        }));

                        const soldPlayers = (parsedSession.soldPlayers || []).map(player => ({
                            ...player,
                            status: 'sold',
                            currentBid: player.soldPrice || 0
                        }));

                        players = [...availablePlayers, ...soldPlayers];

                        if (!isViewerMode) {
                            hideLoading();
                            renderAll();
                            showStatusMessage(`Loaded live session data with ${players.length} players and ${teams.length} teams`, 'success');
                            updateConnectionStatus('connected', 'üìÅ Live session loaded');
                        }
                        return;
                    }
                } catch (sessionError) {
                    console.log('Session file not available, loading from individual files:', sessionError);
                }

                // Fallback to individual files
                const playersData = await serverFS.readFile(fileConfig.playersPath);
                const parsedPlayers = JSON.parse(playersData);
                if (Array.isArray(parsedPlayers)) {
                    players = parsedPlayers.map(player => ({
                        ...player,
                        runs: player.runs || 0,
                        wickets: player.wickets || 0,
                        pclSeasons: player.pclSeasons || [],
                        battingStyle: player.battingStyle || 'Right-handed',
                        currentBid: player.currentBid || 0,
                        status: player.status || 'available',
                        soldTo: player.soldTo || null
                    }));
                }

                const teamsData = await serverFS.readFile(fileConfig.teamsPath);
                const parsedTeams = JSON.parse(teamsData);
                if (Array.isArray(parsedTeams)) {
                    teams = parsedTeams.map(team => ({
                        ...team,
                        players: team.players || []
                    }));
                }

                if (!isViewerMode) {
                    hideLoading();
                    renderAll();
                    showStatusMessage(`Loaded ${players.length} players and ${teams.length} teams from server`, 'success');
                    updateConnectionStatus('connected', 'üìÅ Data loaded from server');
                }

            } catch (error) {
                if (!isViewerMode) {
                    hideLoading();
                    console.error('Error loading from server files:', error);
                    showStatusMessage(`Failed to load from server: ${error.message}`, 'error');
                    updateConnectionStatus('error', '‚ùå Load failed');

                    if (teams.length === 0) teams = [...defaultTeams];
                    if (players.length === 0) players = [...defaultPlayers];
                    renderAll();
                } else {
                    // In viewer mode, use existing data if load fails
                    if (teams.length === 0) teams = [...defaultTeams];
                    if (players.length === 0) players = [...defaultPlayers];
                }
                throw error;
            }
        }

        async function saveToServerFiles() {
            if (isProcessing) return;

            showLoading('Saving data to server files...');

            try {
                const availablePlayers = players.filter(p => p.status === 'available' || p.status === 'unsold');
                const playersData = availablePlayers.map(player => ({
                    id: player.id,
                    name: player.name,
                    role: player.role,
                    runs: player.runs,
                    wickets: player.wickets,
                    pclSeasons: player.pclSeasons,
                    basePrice: player.basePrice,
                    photo: player.photo,
                    battingStyle: player.battingStyle
                }));

                await serverFS.writeFile(fileConfig.playersPath, JSON.stringify(playersData, null, 2));

                const teamsData = teams.map(team => ({
                    id: team.id,
                    name: team.name,
                    budget: team.budget,
                    color: team.color,
                    owner: team.owner,
                    players: team.players.map(player => ({
                        id: player.id,
                        name: player.name,
                        role: player.role,
                        runs: player.runs,
                        wickets: player.wickets,
                        pclSeasons: player.pclSeasons,
                        basePrice: player.basePrice,
                        soldPrice: player.soldPrice,
                        photo: player.photo,
                        battingStyle: player.battingStyle
                    }))
                }));

                await serverFS.writeFile(fileConfig.teamsPath, JSON.stringify(teamsData, null, 2));

                const sessionData = {
                    teams: teamsData,
                    availablePlayers: playersData,
                    soldPlayers: players.filter(p => p.status === 'sold').map(player => ({
                        id: player.id,
                        name: player.name,
                        role: player.role,
                        soldTo: player.soldTo,
                        soldPrice: player.currentBid,
                        soldToTeam: teams.find(t => t.id === player.soldTo)?.name
                    })),
                    auctionState: {
                        currentPlayerIndex: currentPlayerIndex,
                        auctionActive: auctionActive,
                        currentBid: currentBid,
                        currentBidder: currentBidder
                    },
                    timestamp: new Date().toISOString()
                };

                await serverFS.writeFile(fileConfig.sessionPath, JSON.stringify(sessionData, null, 2));

                hideLoading();
                showStatusMessage('Data saved to server files successfully!', 'success');
                updateConnectionStatus('connected', 'üíæ Data saved to server');

            } catch (error) {
                hideLoading();
                console.error('Error saving to server files:', error);
                showStatusMessage(`Failed to save to server: ${error.message}`, 'error');
                updateConnectionStatus('error', '‚ùå Save failed');
            }
        }

        async function createBackupFiles() {
            showLoading('Creating backup files...');

            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

                const playersBackupPath = fileConfig.playersPath.replace('.json', `_backup_${timestamp}.json`);
                const teamsBackupPath = fileConfig.teamsPath.replace('.json', `_backup_${timestamp}.json`);
                const sessionBackupPath = fileConfig.sessionPath.replace('.json', `_backup_${timestamp}.json`);

                const playersContent = await serverFS.readFile(fileConfig.playersPath);
                const teamsContent = await serverFS.readFile(fileConfig.teamsPath);
                const sessionContent = await serverFS.readFile(fileConfig.sessionPath);

                await serverFS.writeFile(playersBackupPath, playersContent);
                await serverFS.writeFile(teamsBackupPath, teamsContent);
                await serverFS.writeFile(sessionBackupPath, sessionContent);

                hideLoading();
                showStatusMessage(`Backup files created with timestamp: ${timestamp}`, 'success');

            } catch (error) {
                hideLoading();
                showStatusMessage(`Backup creation failed: ${error.message}`, 'error');
            }
        }

        // Login functionality
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }

            if (username === 'admin' && password === 'sandy123') {
                currentUser = username;
                currentRole = 'admin';
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userRole').textContent = 'Administrator';

                showTab('auction');

                loadFromServerFiles().then(() => {
                    renderAll();
                });
            } else {
                alert('Invalid credentials');
            }
        }

        function logout() {
            currentUser = null;
            currentRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Tab functionality
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('border-yellow-400'));

            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            const tabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (tabBtn) tabBtn.classList.add('border-yellow-400');

            if (tabName === 'auction') renderAuction();
            if (tabName === 'players') renderPlayers();
            if (tabName === 'teams') renderTeams();
            if (tabName === 'viewer') renderViewerTab();
        }

        // Team validation function - Exactly 15 players required
        function validateTeamPurchase(team, bidAmount) {
            const requiredTeamSize = 15;
            const currentTeamSize = team.players.length;
            const remainingSlots = requiredTeamSize - currentTeamSize;

            // Check if team is already full (has 15 players)
            if (remainingSlots <= 0) {
                return {
                    canPurchase: false,
                    message: `${team.name} already has ${requiredTeamSize} players (roster complete)!`
                };
            }

            // Check basic budget constraint
            if (bidAmount > team.budget) {
                return {
                    canPurchase: false,
                    message: `${team.name} has insufficient budget! Available: ${team.budget.toLocaleString()}, Required: ${bidAmount.toLocaleString()}`
                };
            }

            // Critical constraint: Ensure team can complete roster with remaining budget
            const budgetAfterPurchase = team.budget - bidAmount;
            const slotsAfterPurchase = remainingSlots - 1; // After buying current player

            if (slotsAfterPurchase > 0) {
                // Get minimum base price from available players
                const availablePlayers = players.filter(p => p.status === 'available');
                if (availablePlayers.length === 0) {
                    return {
                        canPurchase: false,
                        message: `No more players available for auction!`
                    };
                }

                const minBasePrice = Math.min(...availablePlayers.map(p => p.basePrice));
                const minRequiredBudget = slotsAfterPurchase * minBasePrice;

                if (budgetAfterPurchase < minRequiredBudget) {
                    return {
                        canPurchase: false,
                        message: `${team.name} cannot afford this bid! After purchase, need ${minRequiredBudget.toLocaleString()} for ${slotsAfterPurchase} more players but will only have ${budgetAfterPurchase.toLocaleString()}`
                    };
                }
            }

            return {
                canPurchase: true,
                message: 'Purchase allowed',
                remainingSlots: slotsAfterPurchase,
                budgetAfterPurchase: budgetAfterPurchase
            };
        }

        function getMaxBidAmount(team, currentPlayer) {
            const requiredTeamSize = 15;
            const currentTeamSize = team.players.length;
            const remainingSlots = requiredTeamSize - currentTeamSize;

            if (remainingSlots <= 0) return 0;

            // If this is the last player they need to buy
            if (remainingSlots === 1) {
                return team.budget; // They can spend all remaining budget
            }

            // Calculate maximum they can bid while still being able to complete roster
            const availablePlayers = players.filter(p => p.status === 'available');
            if (availablePlayers.length === 0) return 0;

            const minBasePrice = Math.min(...availablePlayers.map(p => p.basePrice));
            const slotsAfterPurchase = remainingSlots - 1;
            const minRequiredForRemainingSlots = slotsAfterPurchase * minBasePrice;

            return Math.max(currentPlayer.basePrice, team.budget - minRequiredForRemainingSlots);
        }

        function getTeamStatus(team) {
            const requiredTeamSize = 15;
            const currentTeamSize = team.players.length;
            const remainingSlots = requiredTeamSize - currentTeamSize;

            if (remainingSlots === 0) {
                return { status: 'complete', message: '‚úÖ Roster Complete', color: 'text-green-400' };
            } else if (remainingSlots <= 2) {
                return { status: 'critical', message: `‚ö° Need ${remainingSlots} more`, color: 'text-yellow-400' };
            } else {
                return { status: 'active', message: `üîÑ Need ${remainingSlots} more`, color: 'text-blue-400' };
            }
        }

        // Auction functionality
        function renderAuction() {
            const availablePlayers = players.filter(p => p.status === 'available');

            // Initialize player order if this is the first time or if order is empty
            if (isFirstAuction || playerOrder.length === 0 || playerOrder.length !== availablePlayers.length) {
                initializePlayerOrder();
            }

            const currentPlayer = getCurrentPlayer();

            if (currentPlayer) {
                document.getElementById('currentPlayerCard').innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-black rounded-xl p-6 mb-4">
                        <div class="flex items-start space-x-6 mb-4">
                            <div class="flex-shrink-0">
                                <div class="w-40 h-40 rounded-xl bg-white/20 flex items-center justify-center border-4 border-white shadow-lg overflow-hidden">
                                    ${currentPlayer.photo && (currentPlayer.photo.includes('.jpg') || currentPlayer.photo.includes('.png') || currentPlayer.photo.includes('.jpeg') || currentPlayer.photo.includes('.gif')) ?
                        `<img src="${currentPlayer.photo}" alt="${currentPlayer.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-8xl\\'>üèè</div>';">` :
                        `<div class="text-8xl">${currentPlayer.photo || 'üèè'}</div>`
                    }
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold">${currentPlayer.name}</h3>
                                <p class="text-lg">${currentPlayer.role}</p>
                                <p class="text-sm">Base Price: ${currentPlayer.basePrice.toLocaleString()}</p>
                                <div class="grid grid-cols-2 gap-2 mt-3 text-xs">
                                    <div><strong>Runs:</strong> ${currentPlayer.runs || 0}</div>
                                    <div><strong>Wickets:</strong> ${currentPlayer.wickets || 0}</div>
                                    <div><strong>PCL Seasons:</strong> ${currentPlayer.pclSeasons ? currentPlayer.pclSeasons.join(', ') : 'N/A'}</div>
                                    <div><strong>Batting Style:</strong> ${currentPlayer.battingStyle || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-lg font-bold">Current Bid: ${currentPlayer.currentBid.toLocaleString()}</p>
                            ${currentBidder ? `<p class="text-sm">Leading: ${teams.find(t => t.id === currentBidder)?.name}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="startBidding()" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded-lg transition-colors">
                            Start Bidding
                        </button>
                        <button onclick="unsoldPlayer()" class="bg-red-500 hover:bg-red-600 px-6 py-2 rounded-lg transition-colors">
                            Unsold
                        </button>
                        <button onclick="nextPlayer()" class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg transition-colors">
                            Next Player
                        </button>
                        <button onclick="reshufflePlayerOrder()" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg transition-colors text-sm">
                            üîÄ Shuffle Order
                        </button>
                    </div>
                `;

                if (auctionActive) {
                    document.getElementById('biddingPanel').innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Select Team</label>
                                <select id="biddingTeam" onchange="updateBidAmountForTeam()" class="w-full px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white">
                                    <option value="" class="bg-gray-800 text-white">Select Team</option>
                                    ${teams.map(team => {
                        const teamStatus = getTeamStatus(team);
                        const maxBidAmount = getMaxBidAmount(team, currentPlayer);
                        const currentSize = team.players.length;
                        const remainingSlots = 15 - currentSize;
                        const isDisabled = remainingSlots === 0 || maxBidAmount < currentPlayer.basePrice;

                        return `
                                            <option value="${team.id}" class="bg-gray-800 text-white" ${isDisabled ? 'disabled' : ''}>
                                                ${team.name} - ${team.budget.toLocaleString()} | ${currentSize}/15 players | ${teamStatus.message} ${isDisabled ? '(CANNOT BID)' : `| Max: ${maxBidAmount.toLocaleString()}`}
                                            </option>
                                        `;
                    }).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Bid Amount</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="bidAmount" value="${Math.max(currentPlayer.currentBid, currentPlayer.basePrice)}" 
                                           class="flex-1 px-4 py-2 bg-white/10 border border-white/30 rounded-lg text-white" step="1000" min="${currentPlayer.basePrice}">
                                    <button onclick="increaseBid()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors text-white font-bold">
                                        +1000
                                    </button>
                                </div>
                                <div id="bidValidationMessage" class="text-xs mt-2 p-2 rounded hidden"></div>
                            </div>
                            <button onclick="soldToSelectedTeam()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-colors">
                                Sold to Selected Team
                            </button>
                        </div>
                    `;
                } else {
                    document.getElementById('biddingPanel').innerHTML = '<div class="text-gray-400 text-center">Start bidding to place bids</div>';
                }
            } else {
                document.getElementById('currentPlayerCard').innerHTML = '<div class="text-gray-400 text-center">Auction Complete!</div>';
                document.getElementById('biddingPanel').innerHTML = '<div class="text-gray-400 text-center">Auction Complete!</div>';
            }

            renderTeamsOverview();
            renderPlayerQueue();
        }

        function renderTeamsOverview() {
            const teamsHtml = teams.map(team => {
                const totalBudget = 75000;
                const spent = totalBudget - team.budget;
                const spentPercentage = ((spent / totalBudget) * 100).toFixed(1);

                const teamStatus = getTeamStatus(team);
                const remainingSlots = 15 - team.players.length;

                // Calculate average spend per player
                const avgSpendPerPlayer = team.players.length > 0 ? (spent / team.players.length) : 0;

                return `
                <div class="p-3 bg-white/5 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center">
                            <div class="w-3 h-3 ${team.color} rounded-full mr-3"></div>
                            <span class="font-medium">${team.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold">${team.budget.toLocaleString()}</div>
                            <div class="text-xs ${teamStatus.color}">${team.players.length}/15 players</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-300">
                        <div class="flex justify-between mb-1">
                            <span>Spent: ${spent.toLocaleString()} (${spentPercentage}%)</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="${teamStatus.color}">${teamStatus.message}</span>
                            ${team.players.length > 0 ? `<span class="text-gray-400">Avg: ${Math.round(avgSpendPerPlayer).toLocaleString()}</span>` : ''}
                        </div>
                        ${remainingSlots > 0 ? `
                            <div class="flex justify-between mb-1 text-xs">
                                <span>Budget per remaining slot:</span>
                                <span class="font-bold ${remainingSlots <= 2 ? 'text-yellow-400' : 'text-blue-400'}">${Math.round(team.budget / remainingSlots).toLocaleString()}</span>
                            </div>
                        ` : ''}
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-1">
                            <div class="${team.color} h-2 rounded-full" style="width: ${spentPercentage}%"></div>
                        </div>
                    </div>
                </div>
            `}).join('');

            document.getElementById('teamsOverview').innerHTML = teamsHtml;
        }

        function renderPlayerQueue() {
            const availablePlayers = players.filter(p => p.status === 'available');
            renderFilteredPlayerQueue(availablePlayers, availablePlayers);
        }

        function renderFilteredPlayerQueue(filteredPlayers, allAvailablePlayers) {
            const queueHtml = filteredPlayers.map((player) => {
                // Check if this player is current based on randomized order
                let isCurrentPlayer = false;
                if (playerOrder.length > 0 && currentPlayerIndex < playerOrder.length) {
                    const currentPlayerId = playerOrder[currentPlayerIndex];
                    isCurrentPlayer = player.id === currentPlayerId;
                }

                return `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10 ${isCurrentPlayer ? 'ring-2 ring-yellow-400' : ''}">
                    <div class="flex items-start space-x-3 mb-3">
                        <div class="w-12 h-12 rounded-lg bg-white/10 flex items-center justify-center overflow-hidden">
                            ${player.photo && (player.photo.includes('.jpg') || player.photo.includes('.png') || player.photo.includes('.jpeg') || player.photo.includes('.gif')) ?
                        `<img src="${player.photo}" alt="${player.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-xl\\'>üèè</div>';">` :
                        `<div class="text-xl">${player.photo || 'üèè'}</div>`
                    }
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <h4 class="font-bold text-sm">${player.name}</h4>
                                <span class="text-xs px-2 py-1 rounded ${isCurrentPlayer ? 'bg-yellow-500 text-black' : 'bg-gray-600'}">
                                    ${isCurrentPlayer ? 'CURRENT' : 'AVAILABLE'}
                                </span>
                            </div>
                            <p class="text-xs text-gray-300">${player.role}</p>
                            <p class="text-xs">${player.basePrice.toLocaleString()}</p>
                            <div class="text-xs text-gray-400 mt-1">
                                <span>Runs: ${player.runs || 0}</span> | 
                                <span>Wickets: ${player.wickets || 0}</span>
                            </div>
                        </div>
                    </div>
                    ${!isCurrentPlayer ? `
                        <button onclick="setCurrentPlayer(${player.id})" class="w-full text-xs bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded transition-colors">
                            Select for Auction
                        </button>
                    ` : ''}
                </div>
            `}).join('');

            if (filteredPlayers.length === 0) {
                document.getElementById('playerQueue').innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-400">
                        <div class="text-4xl mb-4">üîç</div>
                        <p class="text-lg mb-2">No players found</p>
                        <p class="text-sm">Try adjusting your search or filter criteria</p>
                    </div>
                `;
            } else {
                document.getElementById('playerQueue').innerHTML = queueHtml;
            }
        }

        function startBidding() {
            // Initialize random order if this is the first auction
            if (isFirstAuction) {
                initializePlayerOrder();
            }

            auctionActive = true;
            const currentPlayer = getCurrentPlayer();
            if (currentPlayer) {
                currentPlayer.currentBid = currentPlayer.basePrice;
                currentBid = currentPlayer.basePrice;
                currentBidder = null;
                renderAuction();
            }
        }

        function updateBidAmountForTeam() {
            const teamId = parseInt(document.getElementById('biddingTeam').value);
            const bidAmountInput = document.getElementById('bidAmount');
            const validationMessage = document.getElementById('bidValidationMessage');

            if (!teamId) {
                validationMessage.classList.add('hidden');
                return;
            }

            const selectedTeam = teams.find(t => t.id === teamId);
            const availablePlayers = players.filter(p => p.status === 'available');
            const currentPlayer = availablePlayers[currentPlayerIndex];

            if (!selectedTeam || !currentPlayer) return;

            const maxBidAmount = getMaxBidAmount(selectedTeam, currentPlayer);
            const minBidAmount = Math.max(currentPlayer.currentBid + 1000, currentPlayer.basePrice);

            // Set appropriate bid amount
            bidAmountInput.value = minBidAmount;
            bidAmountInput.max = maxBidAmount;

            // Show validation message
            const teamStatus = getTeamStatus(selectedTeam);
            const remainingSlots = 15 - selectedTeam.players.length;

            if (remainingSlots === 1) {
                validationMessage.innerHTML = `
                    <div class="text-yellow-400">
                        ‚ö° <strong>Final Player:</strong> ${selectedTeam.name} can spend up to ${maxBidAmount.toLocaleString()} (all remaining budget)
                    </div>
                `;
            } else {
                const budgetAfterMinBid = selectedTeam.budget - minBidAmount;
                const minBasePrice = Math.min(...players.filter(p => p.status === 'available').map(p => p.basePrice));
                const remainingAfterPurchase = remainingSlots - 1;

                validationMessage.innerHTML = `
                    <div class="text-blue-400">
                        üìä <strong>Budget Analysis:</strong> After minimum bid of ${minBidAmount.toLocaleString()}, ${selectedTeam.name} will have ${budgetAfterMinBid.toLocaleString()} for ${remainingAfterPurchase} more players (min ${(minBasePrice * remainingAfterPurchase).toLocaleString()} needed)
                        <br><strong>Max Bid:</strong> ${maxBidAmount.toLocaleString()}
                    </div>
                `;
            }

            validationMessage.classList.remove('hidden');
            validationMessage.className = 'text-xs mt-2 p-2 rounded bg-blue-500/20';
        }

        function increaseBid() {
            const bidAmountInput = document.getElementById('bidAmount');
            const teamId = parseInt(document.getElementById('biddingTeam').value);
            const currentAmount = parseInt(bidAmountInput.value);
            const newAmount = currentAmount + 1000;

            if (teamId) {
                const selectedTeam = teams.find(t => t.id === teamId);
                const currentPlayer = getCurrentPlayer();
                const maxBidAmount = getMaxBidAmount(selectedTeam, currentPlayer);

                if (newAmount <= maxBidAmount) {
                    bidAmountInput.value = newAmount;

                    // Update live bid tracking
                    if (currentPlayer && auctionActive) {
                        currentPlayer.currentBid = newAmount;
                        currentBidder = teamId;
                        saveToServerFiles(); // Save for viewer sync
                    }
                } else {
                    alert(`Maximum bid for ${selectedTeam.name} is ${maxBidAmount.toLocaleString()}`);
                }
            } else {
                bidAmountInput.value = newAmount;
            }
        }

        function soldToSelectedTeam() {
            const teamId = parseInt(document.getElementById('biddingTeam').value);
            const bidAmount = parseInt(document.getElementById('bidAmount').value);

            if (!teamId) {
                alert('Please select a team');
                return;
            }

            const currentPlayer = getCurrentPlayer();

            if (!currentPlayer) {
                alert('No player selected for auction');
                return;
            }

            const selectedTeam = teams.find(t => t.id === teamId);

            if (!selectedTeam) {
                alert('Selected team not found');
                return;
            }

            // Check team capacity and budget constraints
            const validationResult = validateTeamPurchase(selectedTeam, bidAmount);
            if (!validationResult.canPurchase) {
                alert(validationResult.message);
                return;
            }

            const playerName = currentPlayer.name;
            const teamName = selectedTeam.name;

            // Update team and player data
            selectedTeam.budget -= bidAmount;
            selectedTeam.players.push({ ...currentPlayer, soldPrice: bidAmount });
            currentPlayer.status = 'sold';
            currentPlayer.soldTo = teamId;
            currentPlayer.currentBid = bidAmount;

            // Update current bidder for viewer
            currentBidder = teamId;

            // Remove sold player from the randomized order immediately
            playerOrder = playerOrder.filter(id => id !== currentPlayer.id);

            // Reset auction state
            auctionActive = false;
            currentBidder = null;

            // Save data immediately for viewer sync
            saveToServerFiles();

            // Move to next player without incrementing index (since we removed current player)
            if (currentPlayerIndex >= playerOrder.length) {
                // Check if there are still available players for a new round
                const availablePlayers = players.filter(p => p.status === 'available');
                if (availablePlayers.length > 0) {
                    initializePlayerOrder();
                    showStatusMessage(`${playerName} sold to ${teamName} for ${bidAmount.toLocaleString()}! Starting new randomized round...`, 'success');
                } else {
                    currentPlayerIndex = 0;
                    playerOrder = [];
                    showStatusMessage(`${playerName} sold to ${teamName} for ${bidAmount.toLocaleString()}! Auction complete!`, 'success');
                }
            } else {
                showStatusMessage(`${playerName} sold to ${teamName} for ${bidAmount.toLocaleString()}!`, 'success');
            }

            // Re-render all displays
            renderAuction();
            renderTeams();
        }

        function unsoldPlayer() {
            const currentPlayer = getCurrentPlayer();
            if (currentPlayer) {
                const playerName = currentPlayer.name;

                // Mark player as unsold
                currentPlayer.status = 'unsold';

                // Remove unsold player from the randomized order immediately
                playerOrder = playerOrder.filter(id => id !== currentPlayer.id);

                // Reset auction state
                auctionActive = false;
                currentBidder = null;

                // Save data immediately for viewer sync
                saveToServerFiles();

                // Move to next player without incrementing index (since we removed current player)
                if (currentPlayerIndex >= playerOrder.length) {
                    // Check if there are still available players for a new round
                    const availablePlayers = players.filter(p => p.status === 'available');
                    if (availablePlayers.length > 0) {
                        initializePlayerOrder();
                        showStatusMessage(`${playerName} marked as unsold. Starting new randomized round...`, 'success');
                    } else {
                        currentPlayerIndex = 0;
                        playerOrder = [];
                        showStatusMessage(`${playerName} marked as unsold. Auction complete!`, 'success');
                    }
                } else {
                    showStatusMessage(`${playerName} marked as unsold.`, 'success');
                }

                // Re-render displays
                renderAuction();
            }
        }

        function reshufflePlayerOrder() {
            if (confirm('Are you sure you want to reshuffle the player order? This will randomize the remaining players.')) {
                initializePlayerOrder();
                renderAuction();
                showStatusMessage('Player order reshuffled! New random sequence generated.', 'success');
            }
        }

        function nextPlayer() {
            auctionActive = false;
            currentBidder = null;

            // Simply move to next player in the order (no removal here as it's handled in sold/unsold functions)
            currentPlayerIndex++;

            // Check if we've gone through all players in the randomized order
            if (currentPlayerIndex >= playerOrder.length) {
                // Re-shuffle for next round if there are still available players
                const availablePlayers = players.filter(p => p.status === 'available');
                if (availablePlayers.length > 0) {
                    initializePlayerOrder();
                    showStatusMessage('All players auctioned! Starting new randomized round...', 'success');
                } else {
                    currentPlayerIndex = 0;
                    playerOrder = [];
                    showStatusMessage('Auction complete! No more players available.', 'success');
                }
            }

            renderAuction();
        }

        function setCurrentPlayer(playerId) {
            // Find the position in our randomized order that corresponds to this player ID
            const positionInOrder = playerOrder.indexOf(playerId);
            if (positionInOrder !== -1) {
                currentPlayerIndex = positionInOrder;
            } else {
                // If not found in current order, reinitialize and find the player
                initializePlayerOrder();
                const newPosition = playerOrder.indexOf(playerId);
                currentPlayerIndex = newPosition !== -1 ? newPosition : 0;
            }

            auctionActive = false;
            currentBidder = null;
            renderAuction();
        }

        function filterPlayers() {
            const searchTerm = document.getElementById('playerSearch').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;

            const availablePlayers = players.filter(p => p.status === 'available');

            let filteredPlayers = availablePlayers;

            // Apply search filter
            if (searchTerm) {
                filteredPlayers = filteredPlayers.filter(player =>
                    player.name.toLowerCase().includes(searchTerm) ||
                    player.role.toLowerCase().includes(searchTerm)
                );
            }

            // Apply role filter
            if (roleFilter) {
                filteredPlayers = filteredPlayers.filter(player =>
                    player.role === roleFilter
                );
            }

            // Show search results info
            const resultsEl = document.getElementById('playerSearchResults');
            if (searchTerm || roleFilter) {
                resultsEl.textContent = `Showing ${filteredPlayers.length} of ${availablePlayers.length} players`;
                resultsEl.classList.remove('hidden');
            } else {
                resultsEl.classList.add('hidden');
            }

            // Render filtered players
            renderFilteredPlayerQueue(filteredPlayers, availablePlayers);
        }

        function clearFilters() {
            document.getElementById('playerSearch').value = '';
            document.getElementById('roleFilter').value = '';
            renderPlayerQueue();
        }

        // Player management
        function renderPlayers() {
            const playersHtml = players.map(player => `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold">${player.name}</h4>
                        <span class="text-xs px-2 py-1 rounded ${player.status === 'available' ? 'bg-green-500' :
                    player.status === 'sold' ? 'bg-blue-500' : 'bg-red-500'
                }">${player.status}</span>
                    </div>
                    <div class="text-sm text-gray-300 mb-2">
                        <p><strong>Role:</strong> ${player.role}</p>
                        <p><strong>Base Price:</strong> ${player.basePrice.toLocaleString()}</p>
                        <p><strong>Runs:</strong> ${player.runs || 0} | <strong>Wickets:</strong> ${player.wickets || 0}</p>
                        <p><strong>Batting Style:</strong> ${player.battingStyle || 'N/A'}</p>
                        <p><strong>PCL Seasons:</strong> ${player.pclSeasons ? player.pclSeasons.join(', ') : 'N/A'}</p>
                    </div>
                    ${player.status === 'sold' ? `
                        <div class="bg-blue-500/20 rounded p-2 mb-2">
                            <p class="text-sm text-green-400 font-bold">Sold: ${player.currentBid.toLocaleString()}</p>
                            <p class="text-xs text-gray-300">To: ${teams.find(t => t.id === player.soldTo)?.name}</p>
                        </div>
                    ` : ''}
                    <div class="flex flex-wrap gap-2 mt-3">
                        <button onclick="showEditPlayerModal(${player.id})" class="text-xs bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded transition-colors">
                            ‚úèÔ∏è Edit
                        </button>
                        ${player.status === 'sold' ? `
                            <button onclick="resetPlayerToAuction(${player.id})" class="text-xs bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded transition-colors text-black font-medium">
                                üîÑ Back to Auction
                            </button>
                        ` : ''}
                        ${player.status === 'unsold' ? `
                            <button onclick="resetPlayerToAvailable(${player.id})" class="text-xs bg-green-500 hover:bg-green-600 px-3 py-1 rounded transition-colors">
                                ‚Ü©Ô∏è Make Available
                            </button>
                        ` : ''}
                        <button onclick="removePlayer(${player.id})" class="text-xs bg-red-500 hover:bg-red-600 px-3 py-1 rounded transition-colors">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                </div>
            `).join('');

            document.getElementById('playersGrid').innerHTML = playersHtml;
        }

        function showAddPlayerModal() {
            document.getElementById('addPlayerModal').classList.remove('hidden');
        }

        function closeAddPlayerModal() {
            document.getElementById('addPlayerModal').classList.add('hidden');
            document.getElementById('playerName').value = '';
            document.getElementById('playerRuns').value = '0';
            document.getElementById('playerWickets').value = '0';
            document.getElementById('pclSeasons').value = '';
            document.getElementById('basePrice').value = '500';
            document.getElementById('playerPhoto').value = '';
        }

        function addPlayer() {
            const name = document.getElementById('playerName').value;
            const role = document.getElementById('playerRole').value;
            const runs = parseInt(document.getElementById('playerRuns').value) || 0;
            const wickets = parseInt(document.getElementById('playerWickets').value) || 0;
            const pclSeasons = document.getElementById('pclSeasons').value.split(',').map(s => s.trim()).filter(s => s);
            const basePrice = parseInt(document.getElementById('basePrice').value);
            const photo = document.getElementById('playerPhoto').value || 'photos/default.jpg';
            const battingStyle = document.getElementById('battingStyle').value;

            if (!name || !basePrice) {
                alert('Please fill required fields');
                return;
            }

            const newPlayer = {
                id: Date.now(),
                name,
                role,
                runs,
                wickets,
                pclSeasons,
                basePrice,
                photo,
                battingStyle,
                currentBid: 0,
                status: 'available',
                soldTo: null
            };

            players.push(newPlayer);
            saveToServerFiles();
            closeAddPlayerModal();
            renderPlayers();

            showStatusMessage(`${name} added successfully!`, 'success');
        }

        function showEditPlayerModal(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            // Populate form fields
            document.getElementById('editPlayerId').value = player.id;
            document.getElementById('editPlayerName').value = player.name;
            document.getElementById('editPlayerRole').value = player.role;
            document.getElementById('editPlayerRuns').value = player.runs || 0;
            document.getElementById('editPlayerWickets').value = player.wickets || 0;
            document.getElementById('editPclSeasons').value = player.pclSeasons ? player.pclSeasons.join(', ') : '';
            document.getElementById('editBasePrice').value = player.basePrice;
            document.getElementById('editPlayerPhoto').value = player.photo || '';
            document.getElementById('editBattingStyle').value = player.battingStyle || 'Right-handed';

            // Show player status info
            let statusHtml = `
                <div class="text-sm">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">Current Status:</span>
                        <span class="px-2 py-1 rounded text-xs ${player.status === 'available' ? 'bg-green-500' :
                    player.status === 'sold' ? 'bg-blue-500' : 'bg-red-500'
                }">${player.status.toUpperCase()}</span>
                    </div>
            `;

            if (player.status === 'sold') {
                const soldTeam = teams.find(t => t.id === player.soldTo);
                statusHtml += `
                    <div class="text-xs text-gray-300 space-y-1">
                        <div>Sold to: <span class="text-blue-400 font-medium">${soldTeam ? soldTeam.name : 'Unknown Team'}</span></div>
                        <div>Sold Price: <span class="text-green-400 font-medium">${player.currentBid.toLocaleString()}</span></div>
                        <div class="mt-2 p-2 bg-yellow-500/20 rounded text-yellow-300">
                            ‚ö†Ô∏è Player is currently sold. Use "Back to Auction" button to return to auction pool.
                        </div>
                    </div>
                `;
            } else if (player.status === 'unsold') {
                statusHtml += `
                    <div class="text-xs text-gray-300">
                        <div class="p-2 bg-red-500/20 rounded text-red-300">
                            ‚ùå Player was marked as unsold. Use "Make Available" button to return to auction pool.
                        </div>
                    </div>
                `;
            } else {
                statusHtml += `
                    <div class="text-xs text-green-300">
                        ‚úÖ Player is available for auction
                    </div>
                `;
            }

            statusHtml += '</div>';
            document.getElementById('editPlayerStatus').innerHTML = statusHtml;

            document.getElementById('editPlayerModal').classList.remove('hidden');
        }

        function closeEditPlayerModal() {
            document.getElementById('editPlayerModal').classList.add('hidden');
        }

        function updatePlayer() {
            const playerId = parseInt(document.getElementById('editPlayerId').value);
            const player = players.find(p => p.id === playerId);

            if (!player) {
                alert('Player not found');
                return;
            }

            const name = document.getElementById('editPlayerName').value;
            const role = document.getElementById('editPlayerRole').value;
            const runs = parseInt(document.getElementById('editPlayerRuns').value) || 0;
            const wickets = parseInt(document.getElementById('editPlayerWickets').value) || 0;
            const pclSeasons = document.getElementById('editPclSeasons').value.split(',').map(s => s.trim()).filter(s => s);
            const basePrice = parseInt(document.getElementById('editBasePrice').value);
            const photo = document.getElementById('editPlayerPhoto').value;
            const battingStyle = document.getElementById('editBattingStyle').value;

            if (!name || !basePrice) {
                alert('Please fill required fields (Name and Base Price)');
                return;
            }

            // Update player details
            player.name = name;
            player.role = role;
            player.runs = runs;
            player.wickets = wickets;
            player.pclSeasons = pclSeasons;
            player.basePrice = basePrice;
            player.photo = photo;
            player.battingStyle = battingStyle;

            // If player is sold, also update the team's player data
            if (player.status === 'sold' && player.soldTo) {
                const team = teams.find(t => t.id === player.soldTo);
                if (team) {
                    const teamPlayerIndex = team.players.findIndex(p => p.id === player.id);
                    if (teamPlayerIndex !== -1) {
                        team.players[teamPlayerIndex] = { ...player, soldPrice: player.currentBid };
                    }
                }
            }

            saveToServerFiles();
            closeEditPlayerModal();
            renderPlayers();
            renderTeams(); // Update team display if player was sold

            showStatusMessage(`${name} updated successfully!`, 'success');
        }

        function resetPlayerToAuction(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player || player.status !== 'sold') {
                alert('Player is not currently sold');
                return;
            }

            const soldTeam = teams.find(t => t.id === player.soldTo);
            const playerName = player.name;
            const soldPrice = player.currentBid;
            const teamName = soldTeam ? soldTeam.name : 'Unknown Team';

            if (confirm(`Are you sure you want to return ${playerName} to auction? This will:\n\n‚Ä¢ Remove player from ${teamName}\n‚Ä¢ Refund ${soldPrice.toLocaleString()} to team budget\n‚Ä¢ Make player available for auction again`)) {

                // Remove player from team and refund budget
                if (soldTeam) {
                    soldTeam.players = soldTeam.players.filter(p => p.id !== playerId);
                    soldTeam.budget += soldPrice;
                }

                // Reset player status
                player.status = 'available';
                player.currentBid = 0;
                player.soldTo = null;

                saveToServerFiles();
                renderPlayers();
                renderTeams();
                renderAuction(); // Update auction display

                showStatusMessage(`${playerName} returned to auction pool. ${teamName} refunded ${soldPrice.toLocaleString()}`, 'success');
            }
        }

        function resetPlayerToAvailable(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player || player.status !== 'unsold') {
                alert('Player is not currently unsold');
                return;
            }

            if (confirm(`Are you sure you want to make ${player.name} available for auction again?`)) {
                player.status = 'available';
                player.currentBid = 0;

                saveToServerFiles();
                renderPlayers();
                renderAuction(); // Update auction display

                showStatusMessage(`${player.name} is now available for auction`, 'success');
            }
        }

        function removePlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            let confirmMessage = `Are you sure you want to permanently remove ${player.name}?`;

            if (player.status === 'sold') {
                const soldTeam = teams.find(t => t.id === player.soldTo);
                confirmMessage += `\n\nThis will also:\n‚Ä¢ Remove player from ${soldTeam ? soldTeam.name : 'their team'}\n‚Ä¢ Refund ${player.currentBid.toLocaleString()} to team budget`;
            }

            if (confirm(confirmMessage)) {
                // If player is sold, remove from team and refund budget
                if (player.status === 'sold' && player.soldTo) {
                    const soldTeam = teams.find(t => t.id === player.soldTo);
                    if (soldTeam) {
                        soldTeam.players = soldTeam.players.filter(p => p.id !== playerId);
                        soldTeam.budget += player.currentBid;
                    }
                }

                players = players.filter(p => p.id !== playerId);
                saveToServerFiles();
                renderPlayers();
                renderTeams();
                renderAuction();

                showStatusMessage(`${player.name} removed successfully`, 'success');
            }
        }

        // Team dashboard
        function renderTeams() {
            const teamsHtml = teams.map(team => {
                const totalBudget = 75000;
                const spent = totalBudget - team.budget;
                const spentPercentage = ((spent / totalBudget) * 100).toFixed(1);
                const teamStatus = getTeamStatus(team);
                const remainingSlots = 15 - team.players.length;

                return `
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-4 h-4 ${team.color} rounded-full mr-3"></div>
                            <h3 class="text-xl font-bold">${team.name}</h3>
                        </div>
                        <div class="text-right text-sm">
                            <div class="text-yellow-400 font-bold">${team.budget.toLocaleString()}</div>
                            <div class="text-gray-400">remaining</div>
                        </div>
                    </div>
                    
                    <div class="mb-4 p-3 bg-white/5 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                            <div>
                                <span class="text-gray-400">Players:</span>
                                <span class="font-bold ml-2 ${teamStatus.color}">${team.players.length}/15</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Spent:</span>
                                <span class="font-bold ml-2 text-red-400">${spent.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="text-center mb-2">
                            <span class="text-xs px-3 py-1 rounded-full ${teamStatus.status === 'complete' ? 'bg-green-500/20 text-green-400' : teamStatus.status === 'critical' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-blue-500/20 text-blue-400'}">
                                ${teamStatus.message}
                            </span>
                        </div>
                        ${remainingSlots > 0 ? `
                            <div class="text-xs text-center text-gray-400 mb-2">
                                Budget per remaining slot: ${Math.round(team.budget / remainingSlots).toLocaleString()}
                            </div>
                        ` : ''}
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="${team.color} h-2 rounded-full transition-all duration-500" style="width: ${spentPercentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        ${team.players.length > 0 ? team.players.map(player => `
                            <div class="flex items-center justify-between text-sm bg-white/5 rounded p-2">
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 rounded-md bg-white/10 flex items-center justify-center overflow-hidden">
                                        ${player.photo && (player.photo.includes('.jpg') || player.photo.includes('.png') || player.photo.includes('.jpeg') || player.photo.includes('.gif')) ?
                        `<img src="${player.photo}" alt="${player.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-sm\\'>üèè</div>';">` :
                        `<div class="text-sm">${player.photo || 'üèè'}</div>`
                    }
                                    </div>
                                    <span class="font-medium">${player.name}</span>
                                    <span class="text-xs text-gray-400">(${player.role})</span>
                                </div>
                                <span class="text-green-400 font-bold">${(player.soldPrice || 0).toLocaleString()}</span>
                            </div>
                        `).join('') : `<div class="text-center py-8 text-gray-400"><div class="text-4xl mb-2">üèè</div><p>No players yet</p><p class="text-xs mt-2">Need ${remainingSlots} players</p></div>`}
                    </div>
                </div>
            `}).join('');

            document.getElementById('teamsGrid').innerHTML = teamsHtml;
        }

        function resetAuction() {
            if (confirm('Are you sure you want to reset the auction?')) {
                players.forEach(player => {
                    player.status = 'available';
                    player.currentBid = 0;
                    player.soldTo = null;
                });

                teams.forEach(team => {
                    team.players = [];
                    team.budget = 75000;
                });

                currentPlayerIndex = 0;
                auctionActive = false;
                currentBidder = null;
                playerOrder = []; // Clear the randomized order
                isFirstAuction = true; // Reset to first auction state

                saveToServerFiles();
                showStatusMessage('Auction reset successfully! Player order will be randomized on next start.', 'success');
                renderAll();
            }
        }

        function renderAll() {
            renderAuction();
            renderPlayers();
            renderTeams();
        }

        // File upload functionality
        async function uploadFiles() {
            const playersFile = document.getElementById('playersFileUpload').files[0];
            const teamsFile = document.getElementById('teamsFileUpload').files[0];

            if (!playersFile && !teamsFile) {
                alert('Please select at least one file to upload');
                return;
            }

            showLoading('Uploading and processing files...');

            try {
                let uploadedPlayers = false;
                let uploadedTeams = false;

                if (playersFile) {
                    const playersContent = await readFileContent(playersFile);
                    const playersData = JSON.parse(playersContent);

                    // Validate players data structure
                    if (!Array.isArray(playersData)) {
                        throw new Error('Players file must contain an array of players');
                    }

                    // Ensure each player has required fields
                    const validatedPlayers = playersData.map((player, index) => ({
                        id: player.id || Date.now() + index,
                        name: player.name || `Player ${index + 1}`,
                        role: player.role || 'Batsman',
                        runs: parseInt(player.runs) || 0,
                        wickets: parseInt(player.wickets) || 0,
                        pclSeasons: player.pclSeasons || [],
                        basePrice: parseInt(player.basePrice) || 500,
                        photo: player.photo || 'photos/default.jpg',
                        battingStyle: player.battingStyle || 'Right-handed',
                        currentBid: 0,
                        status: 'available',
                        soldTo: null
                    }));

                    await serverFS.overrideFile(fileConfig.playersPath, JSON.stringify(validatedPlayers, null, 2));
                    players = validatedPlayers;
                    uploadedPlayers = true;
                }

                if (teamsFile) {
                    const teamsContent = await readFileContent(teamsFile);
                    const teamsData = JSON.parse(teamsContent);

                    // Validate teams data structure
                    if (!Array.isArray(teamsData)) {
                        throw new Error('Teams file must contain an array of teams');
                    }

                    // Ensure each team has required fields
                    const validatedTeams = teamsData.map((team, index) => ({
                        id: team.id || index + 1,
                        name: team.name || `Team ${index + 1}`,
                        budget: parseInt(team.budget) || 75000,
                        players: team.players || [],
                        color: team.color || `bg-blue-${(index % 6) + 1}00`,
                        owner: team.owner || ''
                    }));

                    await serverFS.overrideFile(fileConfig.teamsPath, JSON.stringify(validatedTeams, null, 2));
                    teams = validatedTeams;
                    uploadedTeams = true;
                }

                hideLoading();

                const uploadMessage = [];
                if (uploadedPlayers) uploadMessage.push(`${players.length} players`);
                if (uploadedTeams) uploadMessage.push(`${teams.length} teams`);

                showStatusMessage(`Successfully uploaded and overridden: ${uploadMessage.join(' and ')}!`, 'success');
                updateConnectionStatus('connected', 'üì§ Files uploaded successfully');

                // Clear file inputs
                document.getElementById('playersFileUpload').value = '';
                document.getElementById('teamsFileUpload').value = '';

                // Refresh all displays
                renderAll();

            } catch (error) {
                hideLoading();
                console.error('Upload error:', error);
                showStatusMessage(`Upload failed: ${error.message}`, 'error');
                updateConnectionStatus('error', '‚ùå Upload failed');
            }
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        function downloadCurrentData() {
            try {
                // Create downloadable files
                const playersBlob = new Blob([JSON.stringify(players, null, 2)], { type: 'application/json' });
                const teamsBlob = new Blob([JSON.stringify(teams, null, 2)], { type: 'application/json' });

                // Download players file
                const playersUrl = URL.createObjectURL(playersBlob);
                const playersLink = document.createElement('a');
                playersLink.href = playersUrl;
                playersLink.download = 'players.json';
                document.body.appendChild(playersLink);
                playersLink.click();
                document.body.removeChild(playersLink);
                URL.revokeObjectURL(playersUrl);

                // Download teams file
                setTimeout(() => {
                    const teamsUrl = URL.createObjectURL(teamsBlob);
                    const teamsLink = document.createElement('a');
                    teamsLink.href = teamsUrl;
                    teamsLink.download = 'teams.json';
                    document.body.appendChild(teamsLink);
                    teamsLink.click();
                    document.body.removeChild(teamsLink);
                    URL.revokeObjectURL(teamsUrl);
                }, 500);

                showStatusMessage('JSON files downloaded successfully!', 'success');

            } catch (error) {
                console.error('Download error:', error);
                showStatusMessage(`Download failed: ${error.message}`, 'error');
            }
        }

        // Excel generation functions
        function downloadExcelReport() {
            try {
                showLoading('Generating comprehensive Excel report...');

                // Create comprehensive auction report
                const excelData = generateComprehensiveExcelData();
                const csvContent = convertToCSV(excelData);

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `PC2025_Auction_Report_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                hideLoading();
                showStatusMessage('Excel report downloaded successfully!', 'success');

            } catch (error) {
                hideLoading();
                console.error('Excel generation error:', error);
                showStatusMessage(`Excel generation failed: ${error.message}`, 'error');
            }
        }

        function downloadTeamWiseExcel() {
            try {
                showLoading('Generating team-wise Excel reports...');

                // Generate separate CSV for each team
                teams.forEach((team, index) => {
                    setTimeout(() => {
                        const teamData = generateTeamExcelData(team);
                        const csvContent = convertToCSV(teamData);

                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `${team.name.replace(/\s+/g, '_')}_Squad_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        if (index === teams.length - 1) {
                            hideLoading();
                            showStatusMessage(`${teams.length} team Excel files downloaded successfully!`, 'success');
                        }
                    }, index * 300); // Stagger downloads
                });

            } catch (error) {
                hideLoading();
                console.error('Team Excel generation error:', error);
                showStatusMessage(`Team Excel generation failed: ${error.message}`, 'error');
            }
        }

        function generateComprehensiveExcelData() {
            const data = [];

            // Add header section
            data.push(['PERSISTENT CRICKET 2025 - AUCTION REPORT']);
            data.push(['Generated on:', new Date().toLocaleString()]);
            data.push(['']); // Empty row

            // Auction Summary
            data.push(['AUCTION SUMMARY']);
            data.push(['Total Players:', players.length]);
            data.push(['Players Sold:', players.filter(p => p.status === 'sold').length]);
            data.push(['Players Unsold:', players.filter(p => p.status === 'unsold').length]);
            data.push(['Players Available:', players.filter(p => p.status === 'available').length]);
            data.push(['Total Budget (All Teams):', '' + (teams.length * 75000).toLocaleString()]);
            data.push(['Total Spent:', '' + teams.reduce((sum, team) => sum + (75000 - team.budget), 0).toLocaleString()]);
            data.push(['Total Remaining:', '' + teams.reduce((sum, team) => sum + team.budget, 0).toLocaleString()]);
            data.push(['']); // Empty row

            // Team Summary
            data.push(['TEAM SUMMARY']);
            data.push(['Team Name', 'Players Count', 'Budget Remaining', 'Amount Spent', 'Spend %', 'Status', 'Avg per Player']);

            teams.forEach(team => {
                const spent = 75000 - team.budget;
                const spendPercentage = ((spent / 75000) * 100).toFixed(1);
                const avgPerPlayer = team.players.length > 0 ? (spent / team.players.length) : 0;
                const teamStatus = getTeamStatus(team);

                data.push([
                    team.name,
                    `${team.players.length}/15`,
                    '' + team.budget.toLocaleString(),
                    '' + spent.toLocaleString(),
                    spendPercentage + '%',
                    teamStatus.message.replace(/[üîÑ‚ö°‚úÖ]/g, '').trim(),
                    '' + Math.round(avgPerPlayer).toLocaleString()
                ]);
            });

            data.push(['']); // Empty row

            // Detailed Team Rosters
            teams.forEach(team => {
                data.push([`${team.name.toUpperCase()} - DETAILED SQUAD`]);
                data.push(['Player Name', 'Role', 'Runs', 'Wickets', 'PCL Seasons', 'Base Price', 'Sold Price', 'Batting Style']);

                if (team.players.length > 0) {
                    team.players.forEach(player => {
                        data.push([
                            player.name,
                            player.role,
                            player.runs || 0,
                            player.wickets || 0,
                            (player.pclSeasons || []).join(', '),
                            '' + (player.basePrice || 0).toLocaleString(),
                            '' + (player.soldPrice || 0).toLocaleString(),
                            player.battingStyle || 'N/A'
                        ]);
                    });

                    // Team totals
                    const totalSpent = team.players.reduce((sum, p) => sum + (p.soldPrice || 0), 0);
                    data.push(['TEAM TOTALS:', '', '', '', '', '', '' + totalSpent.toLocaleString(), '']);
                } else {
                    data.push(['No players purchased yet', '', '', '', '', '', '', '']);
                }

                data.push(['']); // Empty row
            });

            // Role-wise Analysis
            data.push(['ROLE-WISE ANALYSIS']);
            data.push(['Role', 'Total Available', 'Sold', 'Unsold', 'Still Available', 'Avg Sold Price', 'Highest Price', 'Lowest Price']);

            const roles = ['Batsman', 'Bowler', 'All-rounder', 'Wicket-keeper'];
            roles.forEach(role => {
                const rolePlayers = players.filter(p => p.role === role);
                const soldPlayers = rolePlayers.filter(p => p.status === 'sold');
                const unsoldPlayers = rolePlayers.filter(p => p.status === 'unsold');
                const availablePlayers = rolePlayers.filter(p => p.status === 'available');

                const soldPrices = soldPlayers.map(p => p.currentBid).filter(price => price > 0);
                const avgPrice = soldPrices.length > 0 ? soldPrices.reduce((a, b) => a + b, 0) / soldPrices.length : 0;
                const maxPrice = soldPrices.length > 0 ? Math.max(...soldPrices) : 0;
                const minPrice = soldPrices.length > 0 ? Math.min(...soldPrices) : 0;

                data.push([
                    role,
                    rolePlayers.length,
                    soldPlayers.length,
                    unsoldPlayers.length,
                    availablePlayers.length,
                    '' + Math.round(avgPrice).toLocaleString(),
                    '' + maxPrice.toLocaleString(),
                    soldPrices.length > 0 ? '' + minPrice.toLocaleString() : 'N/A'
                ]);
            });

            data.push(['']); // Empty row

            // Unsold Players
            const unsoldPlayers = players.filter(p => p.status === 'unsold');
            if (unsoldPlayers.length > 0) {
                data.push(['UNSOLD PLAYERS']);
                data.push(['Player Name', 'Role', 'Base Price', 'Runs', 'Wickets', 'PCL Seasons', 'Batting Style']);

                unsoldPlayers.forEach(player => {
                    data.push([
                        player.name,
                        player.role,
                        '' + (player.basePrice || 0).toLocaleString(),
                        player.runs || 0,
                        player.wickets || 0,
                        (player.pclSeasons || []).join(', '),
                        player.battingStyle || 'N/A'
                    ]);
                });

                data.push(['']); // Empty row
            }

            // Available Players (if any)
            const availablePlayers = players.filter(p => p.status === 'available');
            if (availablePlayers.length > 0) {
                data.push(['PLAYERS STILL AVAILABLE FOR AUCTION']);
                data.push(['Player Name', 'Role', 'Base Price', 'Runs', 'Wickets', 'PCL Seasons', 'Batting Style']);

                availablePlayers.forEach(player => {
                    data.push([
                        player.name,
                        player.role,
                        '' + (player.basePrice || 0).toLocaleString(),
                        player.runs || 0,
                        player.wickets || 0,
                        (player.pclSeasons || []).join(', '),
                        player.battingStyle || 'N/A'
                    ]);
                });
            }

            return data;
        }

        function generateTeamExcelData(team) {
            const data = [];
            const spent = 75000 - team.budget;
            const spendPercentage = ((spent / 75000) * 100).toFixed(1);
            const teamStatus = getTeamStatus(team);

            // Team header
            data.push([`${team.name.toUpperCase()} - SQUAD DETAILS`]);
            data.push(['Generated on:', new Date().toLocaleString()]);
            data.push(['']); // Empty row

            // Team summary
            data.push(['TEAM SUMMARY']);
            data.push(['Team Name:', team.name]);
            data.push(['Total Players:', `${team.players.length}/15`]);
            data.push(['Budget Remaining:', '' + team.budget.toLocaleString()]);
            data.push(['Amount Spent:', '' + spent.toLocaleString()]);
            data.push(['Spend Percentage:', spendPercentage + '%']);
            data.push(['Team Status:', teamStatus.message.replace(/[üîÑ‚ö°‚úÖ]/g, '').trim()]);
            data.push(['Average per Player:', team.players.length > 0 ? '' + Math.round(spent / team.players.length).toLocaleString() : 'N/A']);
            data.push(['']); // Empty row

            // Squad details
            data.push(['SQUAD ROSTER']);
            data.push(['S.No', 'Player Name', 'Role', 'Runs', 'Wickets', 'PCL Seasons', 'Base Price', 'Sold Price', 'Batting Style', 'Value Rating']);

            if (team.players.length > 0) {
                team.players.forEach((player, index) => {
                    const valueRating = calculateValueRating(player);
                    data.push([
                        index + 1,
                        player.name,
                        player.role,
                        player.runs || 0,
                        player.wickets || 0,
                        (player.pclSeasons || []).join(', '),
                        '' + (player.basePrice || 0).toLocaleString(),
                        '' + (player.soldPrice || 0).toLocaleString(),
                        player.battingStyle || 'N/A',
                        valueRating
                    ]);
                });

                // Role-wise breakdown
                data.push(['']); // Empty row
                data.push(['ROLE-WISE BREAKDOWN']);
                data.push(['Role', 'Count', 'Total Spent', 'Average Price']);

                const roles = ['Batsman', 'Bowler', 'All-rounder', 'Wicket-keeper'];
                roles.forEach(role => {
                    const rolePlayers = team.players.filter(p => p.role === role);
                    const roleSpent = rolePlayers.reduce((sum, p) => sum + (p.soldPrice || 0), 0);
                    const avgPrice = rolePlayers.length > 0 ? roleSpent / rolePlayers.length : 0;

                    if (rolePlayers.length > 0) {
                        data.push([
                            role,
                            rolePlayers.length,
                            '' + roleSpent.toLocaleString(),
                            '' + Math.round(avgPrice).toLocaleString()
                        ]);
                    }
                });

                // Team totals
                data.push(['']); // Empty row
                data.push(['TEAM TOTALS']);
                data.push(['Total Players:', team.players.length]);
                data.push(['Total Spent:', '' + spent.toLocaleString()]);
                data.push(['Budget Remaining:', '' + team.budget.toLocaleString()]);
                data.push(['Slots Remaining:', 15 - team.players.length]);

            } else {
                data.push(['No players purchased yet']);
                data.push(['']); // Empty row
                data.push(['RECOMMENDATIONS']);
                data.push(['- Focus on building a balanced squad']);
                data.push(['- Need to purchase 15 players total']);
                data.push(['- Budget available: ' + team.budget.toLocaleString()]);
                data.push(['- Suggested budget per player: ' + Math.round(team.budget / 15).toLocaleString()]);
            }

            return data;
        }

        function calculateValueRating(player) {
            const soldPrice = player.soldPrice || 0;
            const basePrice = player.basePrice || 0;

            if (soldPrice <= basePrice) return 'Excellent Value';
            if (soldPrice <= basePrice * 1.5) return 'Good Value';
            if (soldPrice <= basePrice * 2) return 'Fair Value';
            if (soldPrice <= basePrice * 3) return 'Premium Buy';
            return 'Expensive';
        }

        function convertToCSV(data) {
            return data.map(row => {
                return row.map(cell => {
                    // Handle cells that might contain commas or quotes
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',');
            }).join('\n');
        }

        // Viewer functionality
        function renderViewerTab() {
            loadViewerSettings();
            generateViewerUrl();
            renderViewerPreview();

            if (viewerConfig.autoRefresh) {
                startViewerAutoRefresh();
            }
        }

        function loadViewerSettings() {
            const saved = localStorage.getItem('viewerConfig');
            if (saved) {
                viewerConfig = { ...viewerConfig, ...JSON.parse(saved) };
            }

            // Only update form elements if they exist (not in viewer-only mode)
            const autoRefreshEl = document.getElementById('autoRefreshViewer');
            const showCurrentAuctionEl = document.getElementById('showCurrentAuction');
            const showTeamBudgetsEl = document.getElementById('showTeamBudgets');
            const showPlayerPhotosEl = document.getElementById('showPlayerPhotos');
            const refreshIntervalEl = document.getElementById('refreshInterval');

            if (autoRefreshEl) autoRefreshEl.checked = viewerConfig.autoRefresh;
            if (showCurrentAuctionEl) showCurrentAuctionEl.checked = viewerConfig.showCurrentAuction;
            if (showTeamBudgetsEl) showTeamBudgetsEl.checked = viewerConfig.showTeamBudgets;
            if (showPlayerPhotosEl) showPlayerPhotosEl.checked = viewerConfig.showPlayerPhotos;
            if (refreshIntervalEl) refreshIntervalEl.value = viewerConfig.refreshInterval;
        }

        function saveViewerSettings() {
            viewerConfig.autoRefresh = document.getElementById('autoRefreshViewer').checked;
            viewerConfig.showCurrentAuction = document.getElementById('showCurrentAuction').checked;
            viewerConfig.showTeamBudgets = document.getElementById('showTeamBudgets').checked;
            viewerConfig.showPlayerPhotos = document.getElementById('showPlayerPhotos').checked;
            viewerConfig.refreshInterval = parseInt(document.getElementById('refreshInterval').value);

            localStorage.setItem('viewerConfig', JSON.stringify(viewerConfig));
            showStatusMessage('Viewer settings saved successfully!', 'success');

            if (viewerConfig.autoRefresh) {
                startViewerAutoRefresh();
            } else {
                stopViewerAutoRefresh();
            }

            renderViewerPreview();
        }

        function generateViewerUrl() {
            const baseUrl = window.location.origin + window.location.pathname;
            const viewerId = 'viewer_' + Date.now();
            viewerConfig.viewerUrl = `${baseUrl}?mode=viewer&id=${viewerId}`;

            document.getElementById('viewerPageUrl').value = viewerConfig.viewerUrl;
            localStorage.setItem('viewerConfig', JSON.stringify(viewerConfig));
        }

        function copyViewerUrl() {
            const urlInput = document.getElementById('viewerPageUrl');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                showStatusMessage('Viewer URL copied to clipboard!', 'success');
            } catch (err) {
                // Fallback for modern browsers
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    showStatusMessage('Viewer URL copied to clipboard!', 'success');
                }).catch(() => {
                    showStatusMessage('Failed to copy URL. Please copy manually.', 'error');
                });
            }
        }

        function openViewerPage() {
            if (viewerConfig.viewerUrl) {
                window.open(viewerConfig.viewerUrl, '_blank');
            } else {
                generateViewerUrl();
                window.open(viewerConfig.viewerUrl, '_blank');
            }
        }

        function startViewerAutoRefresh() {
            stopViewerAutoRefresh();
            viewerRefreshTimer = setInterval(() => {
                renderViewerPreview();
                updateViewerStatus();
            }, viewerConfig.refreshInterval * 1000);
        }

        function stopViewerAutoRefresh() {
            if (viewerRefreshTimer) {
                clearInterval(viewerRefreshTimer);
                viewerRefreshTimer = null;
            }
        }

        function refreshViewerPreview() {
            renderViewerPreview();
            updateViewerStatus();
        }

        function updateViewerStatus() {
            const statusEl = document.getElementById('viewerStatus');
            const now = new Date();
            statusEl.innerHTML = `üü¢ Live - ${now.toLocaleTimeString()}`;
        }

        function renderViewerPreview() {
            const viewerData = generateViewerData();
            const previewHtml = generateViewerHTML(viewerData);
            document.getElementById('viewerPreview').innerHTML = previewHtml;
        }

        function generateViewerData() {
            const currentPlayer = getCurrentPlayer();
            const availablePlayers = players.filter(p => p.status === 'available');

            return {
                currentPlayer: currentPlayer,
                auctionActive: auctionActive,
                currentBid: currentPlayer ? currentPlayer.currentBid : 0,
                currentBidder: currentBidder,
                currentBidderName: currentBidder ? teams.find(t => t.id === currentBidder)?.name : null,
                teams: teams.map(team => ({
                    ...team,
                    totalSpent: 75000 - team.budget,
                    spentPercentage: ((75000 - team.budget) / 75000 * 100).toFixed(1)
                })),
                auctionStats: {
                    totalPlayers: players.length,
                    soldPlayers: players.filter(p => p.status === 'sold').length,
                    availablePlayers: availablePlayers.length,
                    unsoldPlayers: players.filter(p => p.status === 'unsold').length
                },
                playerOrder: playerOrder,
                currentPlayerIndex: currentPlayerIndex,
                lastUpdated: new Date().toLocaleString()
            };
        }

        function generateViewerHTML(data) {
            let html = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h1 class="text-3xl font-bold text-yellow-400 mb-2">üèè PCL 2025 Live Auction</h1>
                        <div class="flex items-center justify-center space-x-4 mb-4">
                            <p class="text-gray-300">Last Updated: ${data.lastUpdated}</p>
                            <div class="connection-status text-xs px-3 py-1 rounded-full bg-blue-500/20 text-blue-400">
                                üîÑ Loading...
                            </div>
                        </div>
                    </div>
            `;

            // Current Auction Section
            if (viewerConfig.showCurrentAuction && data.currentPlayer) {
                html += `
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-black rounded-xl p-6 ${data.auctionActive ? 'pulse-bid' : ''}">
                        <h2 class="text-xl font-bold mb-4">üéØ Current Auction</h2>
                        <div class="flex items-center space-x-4">
                            ${viewerConfig.showPlayerPhotos ? `
                                <div class="w-20 h-20 rounded-lg bg-white/20 flex items-center justify-center overflow-hidden">
                                    ${data.currentPlayer.photo && (data.currentPlayer.photo.includes('.jpg') || data.currentPlayer.photo.includes('.png') || data.currentPlayer.photo.includes('.jpeg') || data.currentPlayer.photo.includes('.gif')) ?
                            `<img src="${data.currentPlayer.photo}" alt="${data.currentPlayer.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-4xl\\'>üèè</div>';">` :
                            `<div class="text-4xl">${data.currentPlayer.photo || 'üèè'}</div>`
                        }
                                </div>
                            ` : ''}
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold">${data.currentPlayer.name}</h3>
                                <p class="text-lg">${data.currentPlayer.role}</p>
                                <p class="text-sm">Base Price: ${data.currentPlayer.basePrice.toLocaleString()}</p>
                                <div class="mt-2">
                                    <p class="text-lg font-bold">Base Price: ${data.currentBid.toLocaleString()}</p>
                                    ${data.currentBidderName ? `<p class="text-sm font-medium">Leading: ${data.currentBidderName}</p>` : ''}
                                </div>
                                <div class="mt-2">
                                    ${data.auctionActive ? '<span class="inline-block bg-green-600 text-white px-3 py-1 rounded-full text-sm font-bold animate-pulse">üî¥ LIVE BIDDING</span>' : '<span class="inline-block bg-gray-600 text-white px-3 py-1 rounded-full text-sm">‚è∏Ô∏è Waiting</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Auction Statistics
            html += `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white/10 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-400">${data.auctionStats.soldPlayers}</div>
                        <div class="text-sm text-gray-300">Sold</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-400">${data.auctionStats.availablePlayers}</div>
                        <div class="text-sm text-gray-300">Available</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-400">${data.auctionStats.unsoldPlayers}</div>
                        <div class="text-sm text-gray-300">Unsold</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-400">${data.auctionStats.totalPlayers}</div>
                        <div class="text-sm text-gray-300">Total</div>
                    </div>
                </div>
            `;

            // Teams Section
            if (viewerConfig.showTeamBudgets) {
                html += `
                    <div>
                        <h2 class="text-xl font-bold text-yellow-400 mb-4">üèÜ Team Standings</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;

                data.teams.forEach(team => {
                    const teamStatus = getTeamStatus(team);
                    const remainingSlots = 15 - team.players.length;

                    html += `
                        <div class="bg-white/10 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 ${team.color} rounded-full mr-2"></div>
                                    <span class="font-bold">${team.name}</span>
                                </div>
                                <div class="text-right text-sm">
                                    <div class="text-yellow-400 font-bold">${team.budget.toLocaleString()}</div>
                                    <div class="${teamStatus.color}">${team.players.length}/15</div>
                                </div>
                            </div>
                            <div class="text-xs text-center mb-2">
                                <span class="px-2 py-1 rounded-full ${teamStatus.status === 'complete' ? 'bg-green-500/20 text-green-400' : teamStatus.status === 'critical' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-blue-500/20 text-blue-400'}">
                                    ${teamStatus.message}
                                </span>
                            </div>
                            <div class="text-xs text-gray-300 mb-2">
                                Spent: ${team.totalSpent.toLocaleString()} (${team.spentPercentage}%)
                                ${remainingSlots > 0 ? ` | Avg per slot: ${Math.round(team.budget / remainingSlots).toLocaleString()}` : ''}
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="${team.color} h-2 rounded-full transition-all duration-500" style="width: ${team.spentPercentage}%"></div>
                            </div>
                            ${team.players.length > 0 ? `
                                <div class="mt-3 space-y-1 max-h-48 overflow-y-auto">
                                    ${team.players.map(player => `
                                        <div class="flex items-center justify-between text-xs bg-white/5 rounded p-1">
                                            <div class="flex items-center space-x-1">
                                                ${viewerConfig.showPlayerPhotos ? `
                                                    <div class="w-6 h-6 rounded bg-white/10 flex items-center justify-center overflow-hidden">
                                                        ${player.photo && (player.photo.includes('.jpg') || player.photo.includes('.png') || player.photo.includes('.jpeg') || player.photo.includes('.gif')) ?
                                `<img src="${player.photo}" alt="${player.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-xs\\'>üèè</div>';">` :
                                `<div class="text-xs">${player.photo || 'üèè'}</div>`
                            }
                                                    </div>
                                                ` : ''}
                                                <span class="font-medium">${player.name}</span>
                                                <span class="text-gray-400">(${player.role})</span>
                                            </div>
                                            <span class="text-green-400 font-bold">${(player.soldPrice || 0).toLocaleString()}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `<div class="text-center py-4 text-gray-400 text-xs">No players yet<br><span class="text-blue-400">Need ${remainingSlots} players</span></div>`}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // Check if page is loaded in viewer mode
        function checkViewerMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');

            if (mode === 'viewer') {
                // Hide admin interface and show viewer-only interface
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.add('hidden');

                // Create viewer-only interface
                document.body.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen text-white">
                        <div class="container mx-auto px-4 py-6">
                            <div id="viewerContent" class="max-w-7xl mx-auto">
                                <div class="text-center mb-6">
                                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-yellow-400 mx-auto mb-4"></div>
                                    <h1 class="text-3xl font-bold text-yellow-400">Loading Live Auction Data...</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Initialize viewer mode
                initializeViewerMode();
                return true;
            }
            return false;
        }

        function initializeViewerMode() {
            // Load viewer settings (safe for viewer-only mode)
            loadViewerSettings();

            // Initialize with default data if needed
            if (teams.length === 0) teams = [...defaultTeams];
            if (players.length === 0) players = [...defaultPlayers];

            // Show initial loading state
            setTimeout(async () => {
                try {
                    // Force fresh load from server files
                    await loadFromServerFiles();
                    console.log('Viewer: Loaded fresh data from server');
                } catch (error) {
                    console.log('Viewer: Using default data, server load failed:', error);
                }

                // Start auto-refresh which will handle rendering
                startViewerModeAutoRefresh();
            }, 500);
        }

        function renderViewerOnlyInterface() {
            try {
                const viewerData = generateViewerData();
                const viewerHtml = generateViewerHTML(viewerData);

                const contentEl = document.getElementById('viewerContent');
                if (contentEl) {
                    contentEl.innerHTML = viewerHtml;
                } else {
                    console.error('Viewer content element not found');
                }
            } catch (error) {
                console.error('Error rendering viewer interface:', error);
                const contentEl = document.getElementById('viewerContent');
                if (contentEl) {
                    contentEl.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-red-400 text-xl mb-4">‚ö†Ô∏è Error Loading Auction Data</div>
                            <p class="text-gray-300 mb-4">Unable to load live auction data. Please refresh the page.</p>
                            <button onclick="window.location.reload()" class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg transition-colors">
                                üîÑ Refresh Page
                            </button>
                        </div>
                    `;
                }
            }
        }

        function startViewerModeAutoRefresh() {
            // Initial render
            renderViewerOnlyInterface();

            // Set up auto-refresh with proper error handling
            setInterval(async () => {
                try {
                    // Force reload from server files
                    await loadFromServerFiles();
                    renderViewerOnlyInterface();

                    // Update connection status if element exists
                    const statusEl = document.querySelector('.connection-status');
                    if (statusEl) {
                        statusEl.innerHTML = `üü¢ Live - ${new Date().toLocaleTimeString()}`;
                        statusEl.className = 'connection-status text-xs px-3 py-1 rounded-full bg-green-500/20 text-green-400';
                    }
                } catch (error) {
                    console.log('Auto-refresh error:', error);
                    // Still render with existing data
                    renderViewerOnlyInterface();

                    // Update connection status to show error
                    const statusEl = document.querySelector('.connection-status');
                    if (statusEl) {
                        statusEl.innerHTML = `‚ö†Ô∏è Connection Issue - ${new Date().toLocaleTimeString()}`;
                        statusEl.className = 'connection-status text-xs px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400';
                    }
                }
            }, (viewerConfig.refreshInterval || 3) * 1000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            // Check if this is viewer mode first
            if (checkViewerMode()) {
                return; // Exit early for viewer mode
            }

            loadFilePaths();
            updateConnectionStatus('checking', 'üîÑ Checking connection...');

            setTimeout(() => {
                testFilePaths();
            }, 1000);
        });
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'978f76078679935f',t:'MTc1Njg0MTgzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>